<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Urgent Cases</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Add Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <!-- Add jsPDF libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      text-decoration: none;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      display: flex;
      min-height: 100vh;
      background-color: #f4f6f9;
    }

    /* Sidebar styling with responsive behavior */
    .sidebar {
      width: 260px;
      background-color: #1e293b;
      color: #ffffff;
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100%;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      transition: transform 0.3s ease;
    }

    .sidebar-toggle {
      display: none;
      position: fixed;
      top: 15px;
      left: 15px;
      background: #1e293b;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      z-index: 1100;
      cursor: pointer;
    }

    .sidebar h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 40px;
      text-align: center;
    }

    .nav-link {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-radius: 6px;
      color: #cbd5e1;
      margin-bottom: 12px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .nav-link:hover,
    .nav-link:focus {
      background-color: #334155;
      color: #ffffff;
    }

    .nav-link span {
      margin-left: 10px;
      font-size: 15px;
    }

    /* Main content area */
    .main-content {
      margin-left: 260px;
      padding: 40px;
      width: calc(100% - 260px);
      background: #f9fafb;
      min-height: 100vh;
      overflow: auto;
      position: relative;
    }

    /* Notification banner */
    .notification-banner {
      background: linear-gradient(135deg, #dc2626, #ef4444);
      color: white;
      padding: 18px 24px;
      border-radius: 12px;
      margin-bottom: 30px;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .notification-banner span {
      font-size: 16px;
    }

    /* Section styling */
    .section {
      background-color: #ffffff;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .section h3 {
      margin-top: 0;
      font-size: 20px;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 10px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 15px;
    }

    button:hover {
      background-color: #1d4ed8;
    }

    #brgyList div,
    #reportList div {
      padding: 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    ul, li {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    /* Logout button styling */
    .logout-btn {
      margin-top: auto;
      background-color: #dc2626;
      padding: 12px;
      text-align: center;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background-color: #b91c1c;
    }

    /* Table styling */
    .cases-table-container {
      overflow-x: auto;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      background-color: #f8fafc;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    tr:hover {
      background-color: #f1f5f9;
    }

    .urgent-badge {
      background-color: #dc2626;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pending {
      background-color: #f59e0b;
      color: white;
    }

    .status-in-progress {
      background-color: #2563eb;
      color: white;
    }

    .status-resolved {
      background-color: #059669;
      color: white;
    }

    .action-btn {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      margin-right: 5px;
    }

    .view-btn {
      background-color: #2563eb;
      color: white;
    }

    .edit-btn {
      background-color: #059669;
      color: white;
    }

    .description-cell {
      max-width: 250px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .filter-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-controls select, .filter-controls input {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }

    .loading {
      text-align: center;
      padding: 20px;
      font-style: italic;
      color: #64748b;
    }
    
    .priority-high {
      background-color: #fef2f2;
    }
    
    .priority-high:hover {
      background-color: #fee2e2;
    }
    
    .status-select {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      min-width: 120px;
    }
    
    .status-select.pending {
      background-color: #fffbeb;
      color: #f59e0b;
      border-color: #f59e0b;
    }
    
    .status-select.in-progress {
      background-color: #eff6ff;
      color: #2563eb;
      border-color: #2563eb;
    }
    
    .status-select.resolved {
      background-color: #ecfdf5;
      color: #059669;
      border-color: #059669;
    }
    
    .save-status-btn {
      padding: 4px 8px;
      border-radius: 4px;
      border: none;
      background-color: #2563eb;
      color: white;
      cursor: pointer;
      font-size: 11px;
      margin-top: 5px;
      display: none;
    }
    
    .status-cell {
      min-width: 150px;
    }
    
    .save-status-btn:hover {
      background-color: #1d4ed8;
    }

    /* PDF Export Button */
    .export-btn {
      background-color: #dc2626;
      padding: 10px 16px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .export-btn:hover {
      background-color: #b91c1c;
    }

    /* Responsive card view for small screens */
    .cases-cards-container {
      display: none;
      flex-direction: column;
      gap: 15px;
    }
    
    .case-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .case-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .case-card-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .case-card-field {
      margin-bottom: 8px;
    }
    
    .case-card-field .label {
      font-weight: 600;
      color: #64748b;
      font-size: 12px;
      margin-bottom: 3px;
    }
    
    .case-card-field .value {
      font-size: 14px;
      word-break: break-word;
    }
    
    .case-card-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }
    
    /* Media Queries for Responsiveness */
    @media (max-width: 1200px) {
      .main-content {
        padding: 30px 20px;
      }
      
      table {
        font-size: 14px;
      }
      
      th, td {
        padding: 10px 12px;
      }
    }
    
    @media (max-width: 992px) {
      .sidebar {
        width: 220px;
        padding: 20px 15px;
      }
      
      .main-content {
        margin-left: 220px;
        width: calc(100% - 220px);
      }
      
      .sidebar h2 {
        font-size: 20px;
      }
      
      .nav-link span {
        font-size: 14px;
      }
    }
    
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .sidebar-toggle {
        display: block;
      }
      
      .main-content {
        margin-left: 0;
        width: 100%;
        padding: 60px 15px 15px;
      }
      
      .notification-banner {
        flex-direction: column;
        text-align: center;
        gap: 10px;
      }
      
      .filter-controls {
        flex-direction: column;
      }
      
      .filter-controls select, 
      .filter-controls input {
        width: 100%;
      }
      
      /* Switch to card view on mobile */
      .cases-table-container {
        display: none;
      }
      
      .cases-cards-container {
        display: flex;
      }
      
      .section h3 {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
    }
    
    @media (max-width: 576px) {
      .case-card-body {
        grid-template-columns: 1fr;
      }
      
      .case-card-actions {
        flex-direction: column;
      }
      
      .case-card-actions button {
        width: 100%;
      }
      
      .section {
        padding: 15px;
      }
    }
    
    @media (min-width: 769px) {
      .sidebar {
        transform: translateX(0) !important;
      }
    }
  </style>
</head>
<body>
  <button class="sidebar-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
  </button>
  
  <div class="sidebar" id="sidebar">
    <h2>JIABONG LGU ADMIN</h2>

    <a class="nav-link" href="MainAdmin.html">
      <i class="fas fa-chart-bar"></i> <span>Dashboard</span>
    </a>

    <a class="nav-link" href="brgy-accounts.html">
      <i class="fas fa-users-cog"></i> <span>Manage Brgy Accounts</span>
    </a>
    <a class="nav-link" href="view-reports.html">
      <i class="fas fa-folder-open"></i> <span>View All Reports</span>
    </a>
    <a class="nav-link" href="urgent-cases.html">
      <i class="fas fa-exclamation-circle"></i> <span>Urgent Cases</span>
    </a>
    <a class="nav-link" href="schedule.html">
      <i class="fas fa-calendar-alt"></i> <span>Scheduled Responses</span>
    </a>

    <!-- Logout Button -->
    <div class="logout-btn" onclick="logout()">
      <i class="fas fa-sign-out-alt"></i> Logout
    </div>
  </div>

  <div class="main-content">
    <div class="notification-banner">
      <span><i class="fas fa-exclamation-triangle"></i> Urgent or Emergency Cases</span>
      <span id="urgent-count">Loading urgent cases...</span>
    </div>
    
    <div class="filter-controls">
      <select id="month-filter">
        <option value="all">All Months</option>
        <option value="01">January</option>
        <option value="02">February</option>
        <option value="03">March</option>
        <option value="04">April</option>
        <option value="05">May</option>
        <option value="06">June</option>
        <option value="07">July</option>
        <option value="08">August</option>
        <option value="09">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
      </select>
      
      <select id="status-filter">
        <option value="all">All Statuses</option>
        <option value="Pending">Pending</option>
        <option value="In Progress">In Progress</option>
        <option value="Resolved">Resolved</option>
      </select>
      
      <select id="brgy-filter">
        <option value="all">All Barangays</option>
        <!-- Barangay options will be dynamically populated -->
      </select>
      
      <input type="text" id="search-input" placeholder="Search urgent cases...">
    </div>
    
    <section class="section">
      <h3>
        <span>Urgent Cases</span>
        <button class="export-btn" onclick="exportToPDF()">
          <i class="fas fa-file-pdf"></i> Export to PDF
        </button>
      </h3>
      
      <!-- Table view for larger screens -->
      <div class="cases-table-container">
        <table id="cases-table">
          <thead>
            <tr>
              <th>Case #</th>
              <th>Category</th>
              <th>Blotter Type</th>
              <th>Incident Type</th>
              <th>Barangay</th>
              <th>Reporter</th>
              <th>Email</th>
              <th>Description</th>
              <th>Date Submitted</th>
              <th>Incident Time</th>
              <th>Specific Location</th>
              <th>Urgent?</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="cases-table-body">
            <tr>
              <td colspan="14" class="loading">Loading urgent cases data...</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Card view for mobile screens -->
      <div class="cases-cards-container" id="cases-cards-container">
        <!-- Cards will be dynamically populated -->
        <div class="loading">Loading urgent cases data...</div>
      </div>
    </section>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCSUCbCVKEYZx_-dySDrAauf1OZ6GIUMgI",
      authDomain: "bpoms-15479.firebaseapp.com",
      databaseURL: "https://bpoms-15479-default-rtdb.firebaseio.com",
      projectId: "bpoms-15479",
      storageBucket: "bpoms-15479.appspot.com",
      messagingSenderId: "461076757426",
      appId: "1:461076757426:web:61adf7d3f1734cc05702ab"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Global variable to store all urgent cases
    let allUrgentCases = [];
    // Global variable to store all barangays
    let allBarangays = new Set();

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('active');
    }

    function renderCasesTable() {
      const tableBody = document.getElementById('cases-table-body');
      const cardsContainer = document.getElementById('cases-cards-container');
      
      const monthFilter = document.getElementById('month-filter').value;
      const statusFilter = document.getElementById('status-filter').value;
      const brgyFilter = document.getElementById('brgy-filter').value;
      const searchText = document.getElementById('search-input').value.toLowerCase();
      
      // If no data loaded yet
      if (allUrgentCases.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="14" class="loading">No urgent cases available</td></tr>';
        cardsContainer.innerHTML = '<div class="loading">No urgent cases available</div>';
        return;
      }
      
      // Filter cases based on selected filters
      const filteredCases = allUrgentCases.filter(caseItem => {
        // Month filter
        if (monthFilter !== 'all') {
          // Extract month from dateSubmitted (assuming format MM/DD/YYYY or similar)
          const dateParts = caseItem.dateSubmitted ? caseItem.dateSubmitted.split('/') : [];
          if (dateParts.length >= 1) {
            const month = dateParts[0].padStart(2, '0');
            if (month !== monthFilter) {
              return false;
            }
          } else {
            return false; // Invalid date format
          }
        }
        
        // Status filter
        if (statusFilter !== 'all' && caseItem.status !== statusFilter) return false;
        
        // Barangay filter
        if (brgyFilter !== 'all' && caseItem.barangay !== brgyFilter) return false;
        
        // Search filter
        if (searchText && !(
          (caseItem.caseNumber || '').toLowerCase().includes(searchText) ||
          (caseItem.category || '').toLowerCase().includes(searchText) ||
          (caseItem.blotterType || '').toLowerCase().includes(searchText) ||
          (caseItem.incidentType || '').toLowerCase().includes(searchText) ||
          (caseItem.barangay || '').toLowerCase().includes(searchText) ||
          (caseItem.reporter || '').toLowerCase().includes(searchText) ||
          (caseItem.email || '').toLowerCase().includes(searchText) ||
          (caseItem.description || '').toLowerCase().includes(searchText) ||
          (caseItem.specificLocation || '').toLowerCase().includes(searchText) ||
          (caseItem.status || '').toLowerCase().includes(searchText)
        )) return false;
        
        return true;
      });
      
      // Update urgent cases count
      document.getElementById('urgent-count').textContent = `${allUrgentCases.length} Urgent Cases (${filteredCases.length} filtered)`;
      
      // Clear table and cards
      tableBody.innerHTML = '';
      cardsContainer.innerHTML = '';
      
      // If no cases match the filter
      if (filteredCases.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="14" class="loading">No urgent cases match your filters</td></tr>';
        cardsContainer.innerHTML = '<div class="loading">No urgent cases match your filters</div>';
        return;
      }
      
      // Populate table with filtered cases
      filteredCases.forEach(caseItem => {
        const row = document.createElement('tr');
        
        // Add priority class for urgent cases
        if (caseItem.urgent) {
          row.classList.add('priority-high');
        }
        
        // Determine status badge class
        let statusClass = '';
        let statusSelectClass = '';
        if (caseItem.status === 'Pending') {
          statusClass = 'status-pending';
          statusSelectClass = 'pending';
        } else if (caseItem.status === 'In Progress') {
          statusClass = 'status-in-progress';
          statusSelectClass = 'in-progress';
        } else if (caseItem.status === 'Resolved') {
          statusClass = 'status-resolved';
          statusSelectClass = 'resolved';
        }
        
        row.innerHTML = `
          <td>${caseItem.caseNumber || 'N/A'}</td>
          <td>${caseItem.category || 'N/A'}</td>
          <td>${caseItem.blotterType || 'N/A'}</td>
          <td>${caseItem.incidentType || 'N/A'}</td>
          <td>${caseItem.barangay || 'N/A'}</td>
          <td>${caseItem.reporter || 'N/A'}</td>
          <td>${caseItem.email || 'N/A'}</td>
          <td class="description-cell" title="${caseItem.description || ''}">${caseItem.description || 'No description'}</td>
          <td>${caseItem.dateSubmitted || 'N/A'}</td>
          <td>${caseItem.incidentTime || 'N/A'}</td>
          <td class="description-cell" title="${caseItem.specificLocation || ''}">${caseItem.specificLocation || 'N/A'}</td>
          <td><span class="urgent-badge">URGENT</span></td>
          <td class="status-cell">
            <select class="status-select ${statusSelectClass}" data-case-id="${caseItem.id}" onchange="handleStatusChange(this)">
              <option value="Pending" ${caseItem.status === 'Pending' ? 'selected' : ''}>Pending</option>
              <option value="In Progress" ${caseItem.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
              <option value="Resolved" ${caseItem.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
            </select>
            <button class="save-status-btn" data-case-id="${caseItem.id}" onclick="saveStatusChange(this)">Save</button>
          </td>
          <td>
            <button class="action-btn view-btn" onclick="viewCase('${caseItem.id}')">View</button>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Populate cards for mobile view
      filteredCases.forEach(caseItem => {
        const card = document.createElement('div');
        card.className = 'case-card';
        
        // Determine status badge class
        let statusClass = '';
        let statusSelectClass = '';
        if (caseItem.status === 'Pending') {
          statusClass = 'status-pending';
          statusSelectClass = 'pending';
        } else if (caseItem.status === 'In Progress') {
          statusClass = 'status-in-progress';
          statusSelectClass = 'in-progress';
        } else if (caseItem.status === 'Resolved') {
          statusClass = 'status-resolved';
          statusSelectClass = 'resolved';
        }
        
        card.innerHTML = `
          <div class="case-card-header">
            <div><strong>${caseItem.caseNumber || 'N/A'}</strong></div>
            <div><span class="urgent-badge">URGENT</span></div>
          </div>
          <div class="case-card-body">
            <div class="case-card-field">
              <div class="label">Category</div>
              <div class="value">${caseItem.category || 'N/A'}</div>
            </div>
            <div class="case-card-field">
              <div class="label">Blotter Type</div>
              <div class="value">${caseItem.blotterType || 'N/A'}</div>
            </div>
            <div class="case-card-field">
              <div class="label">Incident Type</div>
              <div class="value">${caseItem.incidentType || 'N/A'}</div>
            </div>
            <div class="case-card-field">
              <div class="label">Barangay</div>
              <div class="value">${caseItem.barangay || 'N/A'}</div>
            </div>
            <div class="case-card-field">
              <div class="label">Reporter</div>
              <div class="value">${caseItem.reporter || 'N/A'}</div>
            </div>
            <div class="case-card-field">
              <div class="label">Email</div>
              <div class="value">${caseItem.email || 'N/A'}</div>
            </div>
            <div class="case-card-field" style="grid-column: 1 / -1;">
              <div class="label">Description</div>
              <div class="value">${caseItem.description || 'No description'}</div>
            </div>
            <div class="case-card-field">
              <div class="label">Date Submitted</div>
              <div class="value">${caseItem.dateSubmitted || 'N/A'}</div>
            </div>
            <div class="case-card-field">
              <div class="label">Incident Time</div>
              <div class="value">${caseItem.incidentTime || 'N/A'}</div>
            </div>
            <div class="case-card-field" style="grid-column: 1 / -1;">
              <div class="label">Specific Location</div>
              <div class="value">${caseItem.specificLocation || 'N/A'}</div>
            </div>
            <div class="case-card-field">
              <div class="label">Status</div>
              <div class="value">
                <select class="status-select ${statusSelectClass}" data-case-id="${caseItem.id}" onchange="handleStatusChange(this)">
                  <option value="Pending" ${caseItem.status === 'Pending' ? 'selected' : ''}>Pending</option>
                  <option value="In Progress" ${caseItem.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                  <option value="Resolved" ${caseItem.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                </select>
                <button class="save-status-btn" data-case-id="${caseItem.id}" onclick="saveStatusChange(this)">Save</button>
              </div>
            </div>
          </div>
          <div class="case-card-actions">
            <button class="action-btn view-btn" onclick="viewCase('${caseItem.id}')">View Details</button>
          </div>
        `;
        
        cardsContainer.appendChild(card);
      });
    }

    function populateBarangayFilter() {
      const brgyFilter = document.getElementById('brgy-filter');
      
      // Clear existing options except the first one (All Barangays)
      while (brgyFilter.options.length > 1) {
        brgyFilter.remove(1);
      }
      
      // Convert Set to Array and sort alphabetically
      const sortedBarangays = Array.from(allBarangays).sort();
      
      // Add barangay options from the Set
      sortedBarangays.forEach(barangay => {
        if (barangay) { // Only add if barangay is not empty
          const option = document.createElement('option');
          option.value = barangay;
          option.textContent = barangay;
          brgyFilter.appendChild(option);
        }
      });
    }

    function handleStatusChange(selectElement) {
      // Show the save button when status is changed
      const caseId = selectElement.getAttribute('data-case-id');
      const saveButtons = document.querySelectorAll(`.save-status-btn[data-case-id="${caseId}"]`);
      
      saveButtons.forEach(button => {
        button.style.display = 'inline-block';
      });
      
      // Update the select class based on the new value
      selectElement.className = `status-select ${selectElement.value.toLowerCase().replace(' ', '-')}`;
    }

    function saveStatusChange(buttonElement) {
      const caseId = buttonElement.getAttribute('data-case-id');
      const selectElements = document.querySelectorAll(`.status-select[data-case-id="${caseId}"]`);
      const newStatus = selectElements[0].value; // All selects should have the same value
      
      // Update the case status in Firebase
      updateCaseStatus(caseId, newStatus);
      
      // Hide all save buttons for this case after saving
      const saveButtons = document.querySelectorAll(`.save-status-btn[data-case-id="${caseId}"]`);
      saveButtons.forEach(button => {
        button.style.display = 'none';
      });
    }

    function fetchUrgentCasesFromFirebase() {
      // Reference to the "Submitted" node in Firebase
      const submittedRef = database.ref('Submitted');
      
      submittedRef.on('value', (snapshot) => {
        const data = snapshot.val();
        allUrgentCases = [];
        allBarangays.clear(); // Clear previous barangays
        
        if (data) {
          // Convert the object of objects to an array and filter for urgent cases
          Object.keys(data).forEach(key => {
            const caseData = data[key];
            
            // Collect all unique barangays
            if (caseData.barangay) {
              allBarangays.add(caseData.barangay);
            }
            
            // Check if this case is marked as urgent
            const isUrgent = caseData.isUrgent || caseData.urgent || false;
            
            if (isUrgent) {
              // Map the fields from your Submitted node to the expected format
              allUrgentCases.push({
                id: key, // Store the Firebase key for potential updates
                caseNumber: caseData.caseID || caseData.caseNumber || `CASE-${key.substring(0, 8)}`,
                category: caseData.category,
                blotterType: caseData.blotterType,
                incidentType: caseData.incidentType,
                barangay: caseData.barangay,
                reporter: caseData.reporterName || caseData.reporter,
                email: caseData.reporterEmail || caseData.email,
                description: caseData.incidentDescription || caseData.description,
                dateSubmitted: caseData.dateSubmitted || caseData.timestamp,
                incidentTime: caseData.incidentTime,
                specificLocation: caseData.specificLocation || caseData.location,
                urgent: true, // All cases in this array are urgent
                status: caseData.status || 'Pending'
              });
            }
          });
        }
        
        // Populate the barangay filter with the collected barangays
        populateBarangayFilter();
        
        // Render the cases table and cards
        renderCasesTable();
      }, (error) => {
        console.error('Error fetching urgent cases:', error);
        document.getElementById('cases-table-body').innerHTML = 
          '<tr><td colspan="14" class="loading">Error loading urgent cases data</td></tr>';
        document.getElementById('cases-cards-container').innerHTML = 
          '<div class="loading">Error loading urgent cases data</div>';
      });
    }

    function viewCase(caseId) {
      // Find the case in our allUrgentCases array
      const caseItem = allUrgentCases.find(c => c.id === caseId);
      if (caseItem) {
        alert(`Viewing details for URGENT case: ${caseItem.caseNumber}\nDescription: ${caseItem.description}\nStatus: ${caseItem.status}`);
        // In a real application, this would open a modal with full details
      } else {
        alert('Case not found');
      }
    }

    function updateCaseStatus(caseId, newStatus) {
      // Update the case status in Firebase
      database.ref('Submitted/' + caseId).update({
        status: newStatus
      }).then(() => {
        console.log('Urgent case status updated successfully');
        
        // Update the local data
        const caseIndex = allUrgentCases.findIndex(c => c.id === caseId);
        if (caseIndex !== -1) {
          allUrgentCases[caseIndex].status = newStatus;
        }
        
        // Show a success message
        showNotification('Status updated successfully!', 'success');
      }).catch((error) => {
        console.error('Error updating case status:', error);
        showNotification('Error updating status. Please try again.', 'error');
      });
    }

    function showNotification(message, type) {
      // Create a notification element
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.position = 'fixed';
      notification.style.top = '20px';
      notification.style.right = '20px';
      notification.style.padding = '12px 20px';
      notification.style.borderRadius = '6px';
      notification.style.color = 'white';
      notification.style.fontWeight = '500';
      notification.style.zIndex = '1000';
      notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      
      if (type === 'success') {
        notification.style.backgroundColor = '#059669';
      } else {
        notification.style.backgroundColor = '#dc2626';
      }
      
      document.body.appendChild(notification);
      
      // Remove the notification after 3 seconds
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 500);
      }, 3000);
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(18);
      doc.text("Urgent Cases Report", 14, 15);
      doc.setFontSize(11);
      doc.setTextColor(100);
      
      // Get current filters
      const monthFilter = document.getElementById('month-filter');
      const statusFilter = document.getElementById('status-filter');
      const brgyFilter = document.getElementById('brgy-filter');
      
      const monthText = monthFilter.options[monthFilter.selectedIndex].text;
      const statusText = statusFilter.options[statusFilter.selectedIndex].text;
      const brgyText = brgyFilter.options[brgyFilter.selectedIndex].text;
      
      // Add filter information
      doc.text(`Generated on ${new Date().toLocaleDateString()}`, 14, 22);
      doc.text(`Month: ${monthText} | Status: ${statusText} | Barangay: ${brgyText}`, 14, 29);
      
      // Prepare table data
      const tableColumn = [
        "Case #", 
        "Category", 
        "Blotter Type", 
        "Incident Type", 
        "Barangay", 
        "Reporter", 
        "Date", 
        "Status"
      ];
      
      // Get filtered cases for the PDF
      const monthFilterValue = document.getElementById('month-filter').value;
      const statusFilterValue = document.getElementById('status-filter').value;
      const brgyFilterValue = document.getElementById('brgy-filter').value;
      const searchText = document.getElementById('search-input').value.toLowerCase();
      
      const pdfCases = allUrgentCases.filter(caseItem => {
        // Month filter
        if (monthFilterValue !== 'all') {
          const dateParts = caseItem.dateSubmitted ? caseItem.dateSubmitted.split('/') : [];
          if (dateParts.length >= 1) {
            const month = dateParts[0].padStart(2, '0');
            if (month !== monthFilterValue) {
              return false;
            }
          } else {
            return false;
          }
        }
        
        // Status filter
        if (statusFilterValue !== 'all' && caseItem.status !== statusFilterValue) return false;
        
        // Barangay filter
        if (brgyFilterValue !== 'all' && caseItem.barangay !== brgyFilterValue) return false;
        
        // Search filter
        if (searchText && !(
          (caseItem.caseNumber || '').toLowerCase().includes(searchText) ||
          (caseItem.category || '').toLowerCase().includes(searchText) ||
          (caseItem.blotterType || '').toLowerCase().includes(searchText) ||
          (caseItem.incidentType || '').toLowerCase().includes(searchText) ||
          (caseItem.barangay || '').toLowerCase().includes(searchText) ||
          (caseItem.reporter || '').toLowerCase().includes(searchText) ||
          (caseItem.email || '').toLowerCase().includes(searchText) ||
          (caseItem.description || '').toLowerCase().includes(searchText) ||
          (caseItem.specificLocation || '').toLowerCase().includes(searchText) ||
          (caseItem.status || '').toLowerCase().includes(searchText)
        )) return false;
        
        return true;
      });
      
      const tableRows = pdfCases.map(caseItem => [
        caseItem.caseNumber || 'N/A',
        caseItem.category || 'N/A',
        caseItem.blotterType || 'N/A',
        caseItem.incidentType || 'N/A',
        caseItem.barangay || 'N/A',
        caseItem.reporter || 'N/A',
        caseItem.dateSubmitted || 'N/A',
        caseItem.status || 'N/A'
      ]);
      
      // Add table
      doc.autoTable({
        head: [tableColumn],
        body: tableRows,
        startY: 40,
        theme: 'grid',
        headStyles: {
          fillColor: [220, 38, 38], // Red color for urgent cases
          textColor: 255
        },
        alternateRowStyles: {
          fillColor: [254, 242, 242] // Light red for alternate rows
        }
      });

      // Save the PDF
      doc.save("urgent_cases_report.pdf");
    }

    function logout() {
      window.location.href = "index.html";
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(event) {
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.querySelector('.sidebar-toggle');
      
      if (window.innerWidth <= 768 && 
          sidebar.classList.contains('active') && 
          !sidebar.contains(event.target) && 
          !sidebarToggle.contains(event.target)) {
        sidebar.classList.remove('active');
      }
    });

    // Initialize the application when page loads
    window.onload = function() {
      // Fetch only urgent cases from Firebase
      fetchUrgentCasesFromFirebase();
      
      // Add event listeners to filters
      document.getElementById('month-filter').addEventListener('change', renderCasesTable);
      document.getElementById('status-filter').addEventListener('change', renderCasesTable);
      document.getElementById('brgy-filter').addEventListener('change', renderCasesTable);
      document.getElementById('search-input').addEventListener('input', renderCasesTable);
    };
  </script>
</body>
</html>