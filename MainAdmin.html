<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Add jsPDF and html2canvas libraries for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      text-decoration: none;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      display: flex;
      height: 100vh;
      background-color: #f4f6f9;
      transition: background-color 0.5s ease;
    }

    /* Alarm overlay */
    .alarm-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(220, 38, 38, 0.3);
      z-index: 9999;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    
    .alarm-overlay.active {
      opacity: 1;
    }
    
    .alarm-flashing {
      animation: alarmFlash 1s infinite;
    }
    
    @keyframes alarmFlash {
      0% { background-color: rgba(220, 38, 38, 0.3); }
      50% { background-color: rgba(220, 38, 38, 0.7); }
      100% { background-color: rgba(220, 38, 38, 0.3); }
    }

    .sidebar {
      width: 260px;
      background-color: #1e293b;
      color: #ffffff;
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100%;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }

    .sidebar h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 40px;
      text-align: center;
    }

    .nav-link {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-radius: 6px;
      color: #cbd5e1;
      margin-bottom: 12px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .nav-link:hover,
    .nav-link:focus {
      background-color: #334155;
      color: #ffffff;
    }

    .nav-link span {
      margin-left: 10px;
      font-size: 15px;
    }

    .main-content {
      margin-left: 260px;
      padding: 40px;
      width: calc(100% - 260px);
      background: #f9fafb;
      height: 100vh;
      overflow-y: auto;
      position: relative;
    }

    /* Notification Banner */
    .notification-banner {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      margin-bottom: 30px;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .notification-banner span {
      font-size: 16px;
    }

    .notification-right {
      display: flex;
      align-items: center;
      gap: 24px;
      position: relative;
    }

    .admin-info {
      font-weight: 600;
      font-size: 15px;
    }

    .notif-icon, .about-btn {
      position: relative;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background-color 0.2s;
    }

    .notif-icon:hover, .about-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .notif-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #ef4444;
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 50%;
      font-weight: 600;
    }

    .notif-dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 32px;
      background: white;
      color: #1e293b;
      min-width: 280px;
      border-radius: 10px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      z-index: 100;
      overflow: hidden;
      max-height: 300px;
      overflow-y: auto;
    }

    .notif-dropdown div {
      padding: 12px 16px;
      border-bottom: 1px solid #f1f5f9;
      font-size: 14px;
      transition: background 0.2s;
    }

    .notif-dropdown div:last-child {
      border-bottom: none;
    }

    .notif-dropdown div:hover {
      background: #f9fafb;
    }

    /* Stat Boxes */
    .stat-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-box {
      background: white;
      border-radius: 12px;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      transition: transform 0.2s;
    }

    .stat-box:hover {
      transform: translateY(-3px);
    }

    .stat-box i {
      font-size: 28px;
      margin-bottom: 12px;
    }

    .stat-box h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
    }

    .stat-box p {
      margin: 6px 0 0;
      font-size: 22px;
      font-weight: bold;
      color: #2563eb;
    }

    .sections {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      height: 420px;
      position: relative;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .download-btn {
      background-color: #e5e7eb;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    
    .download-btn:hover {
      background-color: #d1d5db;
    }

    .logout-btn {
      margin-top: auto;
      background-color: #dc2626;
      padding: 12px;
      text-align: center;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background-color: #b91c1c;
    }

    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-live {
      background-color: #10b981;
    }
    
    .status-offline {
      background-color: #ef4444;
    }
    
    /* Enhanced Chart Styling */
    .chart-container {
      position: relative;
      height: 320px;
      width: 100%;
    }
    
    /* Alarm control panel */
    .alarm-control {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 200px;
    }
    
    .alarm-control h4 {
      margin: 0;
      font-size: 16px;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .alarm-control button {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }
    
    .alarm-control button:hover {
      background: #dc2626;
    }
    
    .alarm-active {
      background: #ef4444;
      color: white;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* About Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      transform: translateY(-20px);
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 20px;
      color: #1e293b;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #6b7280;
      transition: color 0.2s;
    }

    .close-btn:hover {
      color: #374151;
    }

    .modal-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .hotline-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s;
      border: none;
      font-family: 'Inter', sans-serif;
    }

    .btn-primary {
      background-color: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background-color: #2563eb;
    }

    .btn-secondary {
      background-color: #e5e7eb;
      color: #374151;
    }

    .btn-secondary:hover {
      background-color: #d1d5db;
    }

    .view-mode .form-group input,
    .view-mode .form-group textarea {
      background-color: #f9fafb;
      border-color: #e5e7eb;
      cursor: not-allowed;
    }

    .about-info-view {
      display: none;
    }

    .view-mode .about-info-view {
      display: block;
    }

    .view-mode .about-info-edit {
      display: none;
    }

    .about-info-edit {
      display: block;
    }

    .view-mode .modal-footer .btn-edit {
      display: block;
    }

    .view-mode .modal-footer .btn-save,
    .view-mode .modal-footer .btn-cancel {
      display: none;
    }

    .btn-edit {
      display: none;
    }

    /* Mayor Image Upload Styles */
    .mayor-image-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }

    .mayor-image-preview {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid #e5e7eb;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f9fafb;
    }

    .mayor-image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .mayor-image-preview .placeholder {
      font-size: 14px;
      color: #6b7280;
      text-align: center;
      padding: 20px;
    }

    .image-upload-btn {
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .image-upload-btn:hover {
      background-color: #2563eb;
    }

    .image-upload-btn input {
      display: none;
    }

    .image-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .image-actions button {
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .remove-image-btn {
      background-color: #ef4444;
      color: white;
      border: none;
    }

    .remove-image-btn:hover {
      background-color: #dc2626;
    }

    .change-image-btn {
      background-color: #e5e7eb;
      color: #374151;
      border: none;
    }

    .change-image-btn:hover {
      background-color: #d1d5db;
    }

    .image-upload-info {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Alarm overlay -->
  <div id="alarmOverlay" class="alarm-overlay"></div>
  
  <!-- About Modal -->
  <div id="aboutModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>About Jiabong Municipality</h3>
        <button class="close-btn" id="closeModalBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="about-info-view">
          <!-- Mayor Image in View Mode -->
          <div class="mayor-image-container">
            <div class="mayor-image-preview">
              <div id="viewMayorImagePlaceholder" class="placeholder">No Image Available</div>
              <img id="viewMayorImage" src="" alt="Mayor Image" style="display: none;">
            </div>
          </div>
          
          <div class="form-group">
            <label>Mayor</label>
            <div id="viewMayor" class="view-field"></div>
          </div>
          <div class="form-group">
            <label>Brief Biography of the Mayor</label>
            <div id="viewMayorBio" class="view-field"></div>
          </div>
          <div class="form-group">
            <label>Brief History of the Municipality</label>
            <div id="viewHistory" class="view-field"></div>
          </div>
          <div class="form-group">
            <label>Mission</label>
            <div id="viewMission" class="view-field"></div>
          </div>
          <div class="form-group">
            <label>Vision</label>
            <div id="viewVision" class="view-field"></div>
          </div>
          <div class="form-group">
            <label>Core Values</label>
            <div id="viewCoreValues" class="view-field"></div>
          </div>
          <div class="form-group">
            <label>Emergency Hotlines</label>
            <div class="hotline-container">
              <div>
                <strong>Police:</strong> <span id="viewPolice"></span>
              </div>
              <div>
                <strong>BFP:</strong> <span id="viewBFP"></span>
              </div>
              <div>
                <strong>Medical:</strong> <span id="viewMedical"></span>
              </div>
              <div>
                <strong>Disaster:</strong> <span id="viewDisaster"></span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="about-info-edit">
          <!-- Mayor Image in Edit Mode -->
          <div class="mayor-image-container">
            <div class="mayor-image-preview">
              <div id="editMayorImagePlaceholder" class="placeholder">No Image Available</div>
              <img id="editMayorImage" src="" alt="Mayor Image Preview" style="display: none;">
            </div>
            <button class="image-upload-btn" id="uploadImageBtn">
              <i class="fas fa-upload"></i> Upload Mayor Image
              <input type="file" id="mayorImageInput" accept="image/*">
            </button>
            <div class="image-actions">
              <button class="change-image-btn" id="changeImageBtn" style="display: none;">Change</button>
              <button class="remove-image-btn" id="removeImageBtn" style="display: none;">Remove</button>
            </div>
            <div class="image-upload-info">
              Recommended: Square image, at least 300x300 pixels, max 2MB
            </div>
          </div>
          
          <div class="form-group">
            <label for="editMayor">Mayor</label>
            <input type="text" id="editMayor" placeholder="Enter mayor's name">
          </div>
          <div class="form-group">
            <label for="editMayorBio">Brief Biography of the Mayor</label>
            <textarea id="editMayorBio" placeholder="Enter mayor's biography"></textarea>
          </div>
          <div class="form-group">
            <label for="editHistory">Brief History of the Municipality</label>
            <textarea id="editHistory" placeholder="Enter municipality history"></textarea>
          </div>
          <div class="form-group">
            <label for="editMission">Mission</label>
            <textarea id="editMission" placeholder="Enter municipality mission"></textarea>
          </div>
          <div class="form-group">
            <label for="editVision">Vision</label>
            <textarea id="editVision" placeholder="Enter municipality vision"></textarea>
          </div>
          <div class="form-group">
            <label for="editCoreValues">Core Values</label>
            <textarea id="editCoreValues" placeholder="Enter core values"></textarea>
          </div>
          <div class="form-group">
            <label>Emergency Hotlines</label>
            <div class="hotline-container">
              <div>
                <label for="editPolice">Police</label>
                <input type="text" id="editPolice" placeholder="Police hotline">
              </div>
              <div>
                <label for="editBFP">BFP</label>
                <input type="text" id="editBFP" placeholder="BFP hotline">
              </div>
              <div>
                <label for="editMedical">Medical</label>
                <input type="text" id="editMedical" placeholder="Medical hotline">
              </div>
              <div>
                <label for="editDisaster">Disaster</label>
                <input type="text" id="editDisaster" placeholder="Disaster hotline">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
        <button class="btn btn-primary" id="saveBtn">Save Changes</button>
        <button class="btn btn-primary btn-edit" id="editBtn">Edit Information</button>
      </div>
    </div>
  </div>
  
  <div class="sidebar">
    <h2>JIABONG LGU ADMIN</h2>

    <a class="nav-link" href="MainAdmin.html">
      <i class="fas fa-chart-bar"></i> <span>Dashboard</span>
    </a>

    <a class="nav-link" href="brgy-accounts.html">
      <i class="fas fa-users-cog"></i> <span>Manage Brgy Accounts</span>
    </a>
    <a class="nav-link" href="view-reports.html">
      <i class="fas fa-folder-open"></i> <span>View All Reports</span>
    </a>
    <a class="nav-link" href="urgent-cases.html">
      <i class="fas fa-exclamation-circle"></i> <span>Urgent Cases</span>
    </a>
    <a class="nav-link" href="schedule.html">
      <i class="fas fa-calendar-alt"></i> <span>Scheduled Responses</span>
    </a>

    <!-- Logout Button -->
    <div class="logout-btn" onclick="logout()">
      <i class="fas fa-sign-out-alt"></i> Logout
    </div>
  </div>

  <div class="main-content">
    <div class="notification-banner">
      <span>Admin Dashboard</span>
      <div class="notification-right">
        <div class="about-btn" id="aboutBtn" title="About Jiabong">
          <i class="fas fa-info-circle"></i>
        </div>
        <div class="admin-info">
          <span class="status-indicator status-live" id="dbStatus"></span>
          <span id="adminName">Loading...</span>
        </div>
        <div class="notif-icon" onclick="toggleDropdown()">
          <i class="fas fa-bell"></i>
          <span class="notif-badge" id="notifCount">0</span>
          <div class="notif-dropdown" id="notifDropdown">
            <div>Loading notifications...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alarm Control Panel (initially hidden) -->
    <div id="alarmControl" class="alarm-control" style="display: none;">
      <h4><i class="fas fa-bell"></i> Urgent Report Alert</h4>
      <p id="alarmMessage">Urgent reports detected!</p>
      <button id="silenceAlarmBtn">Silence Alarm</button>
    </div>

    <!-- Stat Boxes -->
    <div class="stat-container">
      <div class="stat-box">
        <i class="fas fa-file-alt" style="color:#3b82f6;"></i>
        <h3>Total Reports</h3>
        <p id="totalReports">0</p>
      </div>
      <div class="stat-box">
        <i class="fas fa-exclamation-triangle" style="color:#ef4444;"></i>
        <h3>Urgent Cases</h3>
        <p id="urgentCases">0</p>
      </div>
      <div class="stat-box">
        <i class="fas fa-calendar-alt" style="color:#f59e0b;"></i>
        <h3>Scheduled</h3>
        <p id="scheduledReports">0</p>
      </div>
    </div>

    <div class="sections">
      <div class="chart-header">
        <h3>Report Count by Barangay</h3>
        <button class="download-btn" onclick="downloadChart('reportChart', 'Barangay_Report_Count')">
          <i class="fas fa-file-pdf"></i> Download PDF
        </button>
      </div>
      <div class="chart-container">
        <canvas id="reportChart"></canvas>
      </div>
    </div>
    
    <!-- New Charts Container - Now with Bar Charts -->
    <div class="sections">
      <div class="chart-header">
        <h3>Reports by Incident Type</h3>
        <button class="download-btn" onclick="downloadChart('incidentTypeChart', 'Incident_Type_Reports')">
          <i class="fas fa-file-pdf"></i> Download PDF
        </button>
      </div>
      <div class="chart-container">
        <canvas id="incidentTypeChart"></canvas>
      </div>
    </div>
      
    <div class="sections">
      <div class="chart-header">
        <h3>Reports by Blotter Type</h3>
        <button class="download-btn" onclick="downloadChart('blotterTypeChart', 'Blotter_Type_Reports')">
          <i class="fas fa-file-pdf"></i> Download PDF
        </button>
      </div>
      <div class="chart-container">
        <canvas id="blotterTypeChart"></canvas>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
  import { getDatabase, ref, get, onValue, set } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";
  import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCSUCbCVKEYZx_-dySDrAauf1OZ6GIUMgI",
    authDomain: "bpoms-15479.firebaseapp.com",
    databaseURL: "https://bpoms-15479-default-rtdb.firebaseio.com",
    projectId: "bpoms-15479",
    storageBucket: "gs://bpoms-15479.firebasestorage.app",
    messagingSenderId: "461076757426",
    appId: "1:461076757426:web:61adf7d3f1734cc05702ab"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  // DOM elements
  const adminNameEl = document.getElementById("adminName");
  const totalReportsEl = document.getElementById("totalReports");
  const urgentCasesEl = document.getElementById("urgentCases");
  const scheduledReportsEl = document.getElementById("scheduledReports");
  const notifCountEl = document.getElementById("notifCount");
  const notifDropdownEl = document.getElementById("notifDropdown");
  const dbStatusEl = document.getElementById("dbStatus");
  const alarmOverlay = document.getElementById("alarmOverlay");
  const alarmControl = document.getElementById("alarmControl");
  const alarmMessage = document.getElementById("alarmMessage");
  const silenceAlarmBtn = document.getElementById("silenceAlarmBtn");
  
  // About modal elements
  const aboutBtn = document.getElementById("aboutBtn");
  const aboutModal = document.getElementById("aboutModal");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const saveBtn = document.getElementById("saveBtn");
  const editBtn = document.getElementById("editBtn");
  
  // View mode fields
  const viewMayor = document.getElementById("viewMayor");
  const viewMayorBio = document.getElementById("viewMayorBio");
  const viewHistory = document.getElementById("viewHistory");
  const viewMission = document.getElementById("viewMission");
  const viewVision = document.getElementById("viewVision");
  const viewCoreValues = document.getElementById("viewCoreValues");
  const viewPolice = document.getElementById("viewPolice");
  const viewBFP = document.getElementById("viewBFP");
  const viewMedical = document.getElementById("viewMedical");
  const viewDisaster = document.getElementById("viewDisaster");
  const viewMayorImage = document.getElementById("viewMayorImage");
  const viewMayorImagePlaceholder = document.getElementById("viewMayorImagePlaceholder");
  
  // Edit mode fields
  const editMayor = document.getElementById("editMayor");
  const editMayorBio = document.getElementById("editMayorBio");
  const editHistory = document.getElementById("editHistory");
  const editMission = document.getElementById("editMission");
  const editVision = document.getElementById("editVision");
  const editCoreValues = document.getElementById("editCoreValues");
  const editPolice = document.getElementById("editPolice");
  const editBFP = document.getElementById("editBFP");
  const editMedical = document.getElementById("editMedical");
  const editDisaster = document.getElementById("editDisaster");
  const editMayorImage = document.getElementById("editMayorImage");
  const editMayorImagePlaceholder = document.getElementById("editMayorImagePlaceholder");
  
  // Image upload elements
  const mayorImageInput = document.getElementById("mayorImageInput");
  const uploadImageBtn = document.getElementById("uploadImageBtn");
  const changeImageBtn = document.getElementById("changeImageBtn");
  const removeImageBtn = document.getElementById("removeImageBtn");

  // Global variables
  let reportChart = null;
  let incidentTypeChart = null;
  let blotterTypeChart = null;
  let notifications = [];
  let allReports = [];
  let urgentReports = [];
  let previousUrgentCount = 0;
  let alarmActive = false;
  let alarmInterval = null;
  let aboutInfo = null;
  let currentImageFile = null;
  let imageChanged = false;

  // Professional color palette
  const chartColors = {
    blue: {
      primary: 'rgba(59, 130, 246, 0.8)',
      hover: 'rgba(59, 130, 246, 1)',
      border: 'rgba(59, 130, 246, 1)'
    },
    green: {
      primary: 'rgba(16, 185, 129, 0.8)',
      hover: 'rgba(16, 185, 129, 1)',
      border: 'rgba(16, 185, 129, 1)'
    },
    red: {
      primary: 'rgba(239, 68, 68, 0.8)',
      hover: 'rgba(239, 68, 68, 1)',
      border: 'rgba(239, 68, 68, 1)'
    },
    yellow: {
      primary: 'rgba(245, 158, 11, 0.8)',
      hover: 'rgba(245, 158, 11, 1)',
      border: 'rgba(245, 158, 11, 1)'
    },
    purple: {
      primary: 'rgba(139, 92, 246, 0.8)',
      hover: 'rgba(139, 92, 246, 1)',
      border: 'rgba(139, 92, 246, 1)'
    },
    pink: {
      primary: 'rgba(236, 72, 153, 0.8)',
      hover: 'rgba(236, 72, 153, 1)',
      border: 'rgba(236, 72, 153, 1)'
    },
    cyan: {
      primary: 'rgba(6, 182, 212, 0.8)',
      hover: 'rgba(6, 182, 212, 1)',
      border: 'rgba(6, 182, 212, 1)'
    },
    indigo: {
      primary: 'rgba(99, 102, 241, 0.8)',
      hover: 'rgba(99, 102, 241, 1)',
      border: 'rgba(99, 102, 241, 1)'
    }
  };

  // Chart configuration
  const chartConfig = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top',
        labels: {
          font: {
            size: 12,
            family: "'Inter', sans-serif"
          },
          color: '#374151',
          padding: 15,
          usePointStyle: true,
          pointStyle: 'circle'
        }
      },
      tooltip: {
        backgroundColor: 'rgba(255, 255, 255, 0.95)',
        titleColor: '#1f2937',
        bodyColor: '#374151',
        borderColor: '#e5e7eb',
        borderWidth: 1,
        padding: 12,
        boxPadding: 6,
        usePointStyle: true,
        callbacks: {
          label: function(context) {
            return `${context.dataset.label}: ${context.raw}`;
          }
        }
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        grid: {
          color: 'rgba(229, 231, 235, 0.5)',
          drawBorder: false
        },
        ticks: {
          color: '#6b7280',
          font: {
            size: 11,
            family: "'Inter', sans-serif"
          },
          padding: 8
        }
      },
      x: {
        grid: {
          display: false
        },
        ticks: {
          color: '#6b7280',
          font: {
            size: 11,
            family: "'Inter', sans-serif"
          },
          padding: 8
        }
      }
    },
    elements: {
      bar: {
        borderRadius: 6,
        borderSkipped: false,
      }
    },
    animation: {
      duration: 1000,
      easing: 'easeOutQuart'
    }
  };

  // Load admin info
  const adminUid = "admin";
  const adminRef = ref(db, "BrgyAccounts/" + adminUid);

  get(adminRef).then((snapshot) => {
    if (snapshot.exists()) {
      const data = snapshot.val();
      adminNameEl.textContent = data.displayName || "LGU Admin";
    } else {
      adminNameEl.textContent = "LGU Admin";
    }
  }).catch(() => {
    adminNameEl.textContent = "LGU Admin";
  });

  // Load About information
  function loadAboutInfo() {
    const aboutRef = ref(db, "AboutInfo");
    
    get(aboutRef).then((snapshot) => {
      if (snapshot.exists()) {
        aboutInfo = snapshot.val();
        console.log("Loaded about info:", aboutInfo);
        populateViewFields();
      } else {
        console.log("No about info found, using defaults");
        // Initialize with default values if no data exists
        aboutInfo = {
          mayor: "",
          mayorBio: "",
          history: "",
          mission: "",
          vision: "",
          coreValues: "",
          police: "",
          bfp: "",
          medical: "",
          disaster: "",
          mayorImageUrl: ""
        };
      }
    }).catch((error) => {
      console.error("Error loading about info:", error);
    });
  }

  // Populate view fields with about info
  function populateViewFields() {
    if (!aboutInfo) return;
    
    viewMayor.textContent = aboutInfo.mayor || "Not set";
    viewMayorBio.textContent = aboutInfo.mayorBio || "Not set";
    viewHistory.textContent = aboutInfo.history || "Not set";
    viewMission.textContent = aboutInfo.mission || "Not set";
    viewVision.textContent = aboutInfo.vision || "Not set";
    viewCoreValues.textContent = aboutInfo.coreValues || "Not set";
    viewPolice.textContent = aboutInfo.police || "Not set";
    viewBFP.textContent = aboutInfo.bfp || "Not set";
    viewMedical.textContent = aboutInfo.medical || "Not set";
    viewDisaster.textContent = aboutInfo.disaster || "Not set";
    
    // Handle mayor image
    if (aboutInfo.mayorImageUrl) {
      viewMayorImage.src = aboutInfo.mayorImageUrl;
      viewMayorImage.style.display = "block";
      viewMayorImagePlaceholder.style.display = "none";
    } else {
      viewMayorImage.style.display = "none";
      viewMayorImagePlaceholder.style.display = "block";
    }
  }

  // Populate edit fields with about info
  function populateEditFields() {
    if (!aboutInfo) return;
    
    editMayor.value = aboutInfo.mayor || "";
    editMayorBio.value = aboutInfo.mayorBio || "";
    editHistory.value = aboutInfo.history || "";
    editMission.value = aboutInfo.mission || "";
    editVision.value = aboutInfo.vision || "";
    editCoreValues.value = aboutInfo.coreValues || "";
    editPolice.value = aboutInfo.police || "";
    editBFP.value = aboutInfo.bfp || "";
    editMedical.value = aboutInfo.medical || "";
    editDisaster.value = aboutInfo.disaster || "";
    
    // Handle mayor image
    if (aboutInfo.mayorImageUrl) {
      editMayorImage.src = aboutInfo.mayorImageUrl;
      editMayorImage.style.display = "block";
      editMayorImagePlaceholder.style.display = "none";
      uploadImageBtn.style.display = "none";
      changeImageBtn.style.display = "block";
      removeImageBtn.style.display = "block";
    } else {
      editMayorImage.style.display = "none";
      editMayorImagePlaceholder.style.display = "block";
      uploadImageBtn.style.display = "block";
      changeImageBtn.style.display = "none";
      removeImageBtn.style.display = "none";
    }
    
    // Reset image state
    currentImageFile = null;
    imageChanged = false;
  }

  // Simplified image upload function
  async function uploadMayorImage(file) {
    try {
      console.log("Starting image upload...");
      
      // Validate file
      if (!file || !file.type.startsWith('image/')) {
        throw new Error('Please select a valid image file');
      }
      
      // Validate file size (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        throw new Error('Image size must be less than 2MB');
      }
      
      // Create a unique filename
      const timestamp = Date.now();
      const filename = `mayor_${timestamp}.${file.name.split('.').pop()}`;
      const imageRef = storageRef(storage, `mayor-images/${filename}`);
      
      console.log(`Uploading to: mayor-images/${filename}`);
      
      // Upload the file
      const snapshot = await uploadBytes(imageRef, file);
      console.log("Upload completed:", snapshot);
      
      // Get the download URL
      const downloadURL = await getDownloadURL(snapshot.ref);
      console.log("Got download URL:", downloadURL);
      
      return downloadURL;
    } catch (error) {
      console.error("Error in uploadMayorImage:", error);
      throw error;
    }
  }

  // Delete image function
  async function deleteMayorImage(imageUrl) {
    try {
      if (!imageUrl) {
        console.log("No image URL to delete");
        return;
      }
      
      console.log("Attempting to delete image:", imageUrl);
      
      // Extract the path from the URL
      // The URL format is: https://firebasestorage.googleapis.com/v0/b/bpoms-15479.appspot.com/o/mayor-images%2Ffilename.jpg?alt=media
      const urlParts = imageUrl.split('/o/');
      if (urlParts.length < 2) {
        console.log("Invalid image URL format");
        return;
      }
      
      const encodedPath = urlParts[1].split('?')[0];
      const decodedPath = decodeURIComponent(encodedPath);
      console.log("Decoded path:", decodedPath);
      
      // Create reference to the file
      const imageRef = storageRef(storage, decodedPath);
      
      // Delete the file
      await deleteObject(imageRef);
      console.log("Image deleted successfully");
    } catch (error) {
      // If the file doesn't exist, that's okay
      if (error.code === 'storage/object-not-found') {
        console.log("Image already deleted or not found");
      } else {
        console.error("Error deleting image:", error);
        // Don't throw - we can continue without deleting the image
      }
    }
  }

  // Save about information
  async function saveAboutInfo() {
    // Show loading state
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;
    
    try {
      console.log("Starting save process...");
      
      let mayorImageUrl = aboutInfo ? aboutInfo.mayorImageUrl || "" : "";
      
      // Handle image operations
      if (currentImageFile) {
        console.log("Uploading new image...");
        try {
          // Upload the new image
          mayorImageUrl = await uploadMayorImage(currentImageFile);
          console.log("New image uploaded, URL:", mayorImageUrl);
          
          // Delete the old image if it exists
          if (aboutInfo && aboutInfo.mayorImageUrl && aboutInfo.mayorImageUrl !== mayorImageUrl) {
            console.log("Deleting old image...");
            await deleteMayorImage(aboutInfo.mayorImageUrl);
          }
        } catch (error) {
          console.error("Error handling image:", error);
          // If image upload fails, keep the old image URL
          if (aboutInfo && aboutInfo.mayorImageUrl) {
            mayorImageUrl = aboutInfo.mayorImageUrl;
          }
        }
      } else if (imageChanged && !currentImageFile) {
        // Image was removed
        console.log("Image was removed");
        if (aboutInfo && aboutInfo.mayorImageUrl) {
          await deleteMayorImage(aboutInfo.mayorImageUrl);
        }
        mayorImageUrl = "";
      }
      
      // Prepare updated info
      const updatedInfo = {
        mayor: editMayor.value.trim() || "",
        mayorBio: editMayorBio.value.trim() || "",
        history: editHistory.value.trim() || "",
        mission: editMission.value.trim() || "",
        vision: editVision.value.trim() || "",
        coreValues: editCoreValues.value.trim() || "",
        police: editPolice.value.trim() || "",
        bfp: editBFP.value.trim() || "",
        medical: editMedical.value.trim() || "",
        disaster: editDisaster.value.trim() || "",
        mayorImageUrl: mayorImageUrl,
        lastUpdated: new Date().toISOString()
      };
      
      console.log("Saving to database:", updatedInfo);
      
      // Save to database
      const aboutRef = ref(db, "AboutInfo");
      await set(aboutRef, updatedInfo);
      
      console.log("Save successful!");
      
      // Update local state
      aboutInfo = updatedInfo;
      populateViewFields();
      switchToViewMode();
      
      // Show success message
      alert("Information saved successfully!");
      
    } catch (error) {
      console.error("Error saving about info:", error);
      
      // Show specific error messages
      let errorMessage = "Error saving information. ";
      
      if (error.message.includes("permission-denied")) {
        errorMessage += "Permission denied. Please check Firebase rules.";
      } else if (error.message.includes("storage/")) {
        errorMessage += "Storage error. Please check file size (max 2MB) and try again.";
      } else if (error.message.includes("network") || error.message.includes("Failed to fetch")) {
        errorMessage += "Network error. Please check your internet connection.";
      } else {
        errorMessage += error.message || "Please try again.";
      }
      
      alert(errorMessage);
      
    } finally {
      // Reset button state
      saveBtn.innerHTML = originalText;
      saveBtn.disabled = false;
    }
  }

  // Switch to view mode
  function switchToViewMode() {
    aboutModal.classList.add("view-mode");
  }

  // Switch to edit mode
  function switchToEditMode() {
    populateEditFields();
    aboutModal.classList.remove("view-mode");
  }

  // Show about modal
  function showAboutModal() {
    aboutModal.classList.add("active");
    switchToViewMode();
  }

  // Hide about modal
  function hideAboutModal() {
    aboutModal.classList.remove("active");
  }

  // Handle image selection
  function handleImageSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file type
    if (!file.type.match('image.*')) {
      alert('Please select a valid image file (JPEG, PNG, etc.)');
      return;
    }
    
    // Validate file size (max 2MB)
    if (file.size > 2 * 1024 * 1024) {
      alert('Please select an image smaller than 2MB');
      return;
    }
    
    currentImageFile = file;
    imageChanged = true;
    
    // Create a preview
    const reader = new FileReader();
    reader.onload = function(e) {
      editMayorImage.src = e.target.result;
      editMayorImage.style.display = "block";
      editMayorImagePlaceholder.style.display = "none";
      uploadImageBtn.style.display = "none";
      changeImageBtn.style.display = "block";
      removeImageBtn.style.display = "block";
    };
    reader.readAsDataURL(file);
    
    // Reset the file input
    mayorImageInput.value = "";
  }

  // Handle remove image
  function handleRemoveImage() {
    currentImageFile = null;
    imageChanged = true;
    
    editMayorImage.style.display = "none";
    editMayorImagePlaceholder.style.display = "block";
    uploadImageBtn.style.display = "block";
    changeImageBtn.style.display = "none";
    removeImageBtn.style.display = "none";
  }

  // Load reports data from the "Submitted" node
  function loadReportsData() {
    const submittedRef = ref(db, "Submitted");
    
    onValue(submittedRef, (snapshot) => {
      if (snapshot.exists()) {
        // Update database status indicator
        dbStatusEl.className = "status-indicator status-live";
        
        // Get all reports from the Submitted node
        const submittedData = snapshot.val();
        allReports = Object.values(submittedData);
        
        // Filter urgent cases (where isUrgent is true)
        urgentReports = allReports.filter(report => 
          report.isUrgent === true || report.isUrgent === "true"
        );
        
        // Check for new urgent reports and trigger alarm if needed
        checkForNewUrgentReports(urgentReports);
        
        // Update statistics
        updateStatistics(allReports, urgentReports);
        
        // Update notifications
        updateNotifications(allReports);
        
        // Update charts
        updateReportChart(allReports);
        updateIncidentTypeChart(allReports);
        updateBlotterTypeChart(allReports);
      } else {
        console.log("No submitted reports data available");
        dbStatusEl.className = "status-indicator status-offline";
        resetDashboard();
      }
    }, (error) => {
      console.error("Error loading submitted reports:", error);
      dbStatusEl.className = "status-indicator status-offline";
      resetDashboard();
    });
  }

  // Check for new urgent reports and trigger alarm
  function checkForNewUrgentReports(urgentReports) {
    const currentUrgentCount = urgentReports.length;
    
    // If there are urgent reports and the count has increased
    if (currentUrgentCount > 0 && currentUrgentCount > previousUrgentCount) {
      const newUrgentCount = currentUrgentCount - previousUrgentCount;
      triggerAlarm(newUrgentCount);
    }
    
    // Update the previous count
    previousUrgentCount = currentUrgentCount;
  }

  // Trigger alarm for urgent reports
  function triggerAlarm(newUrgentCount) {
    if (alarmActive) return; // Don't trigger if already active
    
    alarmActive = true;
    
    // Update alarm message
    alarmMessage.textContent = `${newUrgentCount} new urgent report${newUrgentCount > 1 ? 's' : ''} detected!`;
    
    // Show alarm control
    alarmControl.style.display = 'flex';
    
    // Start flashing effect
    alarmOverlay.classList.add('active', 'alarm-flashing');
    
    // Create alarm sound using Web Audio API (if supported)
    try {
      playAlarmSound();
    } catch (error) {
      console.error("Could not play alarm sound:", error);
    }
  }

  // Play alarm sound using Web Audio API
  function playAlarmSound() {
    // Create audio context
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioContext = new AudioContext();
    
    // Create oscillator for beep sound
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
    
    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
    
    // Beep pattern (three short beeps)
    oscillator.start();
    
    // First beep
    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
    gainNode.gain.setValueAtTime(0, audioContext.currentTime + 0.2);
    
    // Second beep
    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime + 0.4);
    gainNode.gain.setValueAtTime(0, audioContext.currentTime + 0.6);
    
    // Third beep
    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime + 0.8);
    gainNode.gain.setValueAtTime(0, audioContext.currentTime + 1.0);
    
    // Stop oscillator after beeps
    oscillator.stop(audioContext.currentTime + 1.0);
    
    // Repeat the sound every 3 seconds while alarm is active
    if (alarmInterval) clearInterval(alarmInterval);
    alarmInterval = setInterval(() => {
      if (alarmActive) {
        playAlarmSound();
      } else {
        clearInterval(alarmInterval);
      }
    }, 3000);
  }

  // Silence the alarm
  function silenceAlarm() {
    alarmActive = false;
    
    // Remove flashing effect
    alarmOverlay.classList.remove('active', 'alarm-flashing');
    
    // Hide alarm control
    alarmControl.style.display = 'none';
    
    // Stop alarm sound
    if (alarmInterval) {
      clearInterval(alarmInterval);
      alarmInterval = null;
    }
  }

  // Update statistics
  function updateStatistics(reports, urgentCases) {
    // Total reports
    totalReportsEl.textContent = reports.length;
    
    // Urgent cases (reports with isUrgent field set to true)
    urgentCasesEl.textContent = urgentCases.length;
    
    // Scheduled reports (assuming scheduled reports have a scheduledDate field)
    const scheduledReports = reports.filter(report => 
      report.scheduledDate && report.scheduledDate !== ""
    );
    scheduledReportsEl.textContent = scheduledReports.length;
  }

  // Update notifications
  function updateNotifications(reports) {
    // Clear existing notifications
    notifications = [];
    
    // Get recent reports (last 24 hours)
    const oneDayAgo = new Date();
    oneDayAgo.setDate(oneDayAgo.getDate() - 1);
    
    const recentReports = reports.filter(report => {
      if (!report.timestamp) return false;
      const reportDate = new Date(report.timestamp);
      return reportDate > oneDayAgo;
    });
    
    // Create notifications for recent reports, prioritizing urgent ones
    recentReports.forEach(report => {
      const barangay = report.barangay || "Unknown Barangay";
      const type = report.type || "incident";
      const timestamp = report.timestamp ? new Date(report.timestamp).toLocaleString() : "Recently";
      const isUrgent = report.isUrgent === true || report.isUrgent === "true";
      
      const notificationText = `${isUrgent ? "ðŸš¨ URGENT: " : ""}New ${type} report from ${barangay} - ${timestamp}`;
      
      // Add urgent notifications at the beginning
      if (isUrgent) {
        notifications.unshift(notificationText);
      } else {
        notifications.push(notificationText);
      }
    });
    
    // Update notification UI
    renderNotifications();
  }

  // Render notifications
  function renderNotifications() {
    notifDropdownEl.innerHTML = "";
    
    if (notifications.length === 0) {
      notifDropdownEl.innerHTML = "<div>No new reports in the last 24 hours</div>";
      notifCountEl.textContent = "0";
    } else {
      notifications.forEach(notification => {
        const item = document.createElement("div");
        item.textContent = notification;
        
        // Style urgent notifications differently
        if (notification.includes("ðŸš¨ URGENT:")) {
          item.style.fontWeight = "bold";
          item.style.color = "#dc2626";
        }
        
        notifDropdownEl.appendChild(item);
      });
      notifCountEl.textContent = notifications.length;
    }
  }

  // Update report chart - Filter out N/A values
  function updateReportChart(reports) {
    // Group reports by barangay, excluding N/A values
    const reportsByBarangay = {};
    
    reports.forEach(report => {
      const barangay = report.barangay || "Unknown";
      // Skip if barangay is N/A
      if (barangay === "N/A" || barangay === "n/a") return;
      
      if (!reportsByBarangay[barangay]) {
        reportsByBarangay[barangay] = 0;
      }
      reportsByBarangay[barangay]++;
    });
    
    // Prepare chart data
    const labels = Object.keys(reportsByBarangay);
    const data = Object.values(reportsByBarangay);
    
    // Colors for chart
    const colorKeys = Object.keys(chartColors);
    const backgroundColors = labels.map((_, i) => {
      const color = chartColors[colorKeys[i % colorKeys.length]];
      return color.primary;
    });
    
    const borderColors = labels.map((_, i) => {
      const color = chartColors[colorKeys[i % colorKeys.length]];
      return color.border;
    });
    
    const hoverBackgroundColors = labels.map((_, i) => {
      const color = chartColors[colorKeys[i % colorKeys.length]];
      return color.hover;
    });
    
    // Destroy existing chart if it exists
    if (reportChart) {
      reportChart.destroy();
    }
    
    // Create new chart
    const ctx = document.getElementById('reportChart').getContext('2d');
    reportChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Number of Reports',
          data: data,
          backgroundColor: backgroundColors,
          borderColor: borderColors,
          borderWidth: 1,
          hoverBackgroundColor: hoverBackgroundColors
        }]
      },
      options: {
        ...chartConfig,
        plugins: {
          ...chartConfig.plugins,
          title: { 
            display: true, 
            text: 'Submitted Reports per Barangay',
            font: { size: 16, weight: 'bold' },
            padding: { bottom: 20 }
          }
        }
      }
    });
  }

  // Update incident type chart - Filter out N/A values
  function updateIncidentTypeChart(reports) {
    // Group reports by incident type, excluding N/A values
    const reportsByIncidentType = {};
    
    reports.forEach(report => {
      const incidentType = report.incidentType || "Unknown";
      // Skip if incidentType is N/A
      if (incidentType === "N/A" || incidentType === "n/a") return;
      
      if (!reportsByIncidentType[incidentType]) {
        reportsByIncidentType[incidentType] = 0;
      }
      reportsByIncidentType[incidentType]++;
    });
    
    // Prepare chart data
    const labels = Object.keys(reportsByIncidentType);
    const data = Object.values(reportsByIncidentType);
    
    // Colors for chart
    const colorKeys = Object.keys(chartColors);
    const backgroundColors = labels.map((_, i) => {
      const color = chartColors[colorKeys[i % colorKeys.length]];
      return color.primary;
    });
    
    const borderColors = labels.map((_, i) => {
      const color = chartColors[colorKeys[i % colorKeys.length]];
      return color.border;
    });
    
    const hoverBackgroundColors = labels.map((_, i) => {
      const color = chartColors[colorKeys[i % colorKeys.length]];
      return color.hover;
    });
    
    // Destroy existing chart if it exists
    if (incidentTypeChart) {
      incidentTypeChart.destroy();
    }
    
    // Create new chart as bar chart
    const ctx = document.getElementById('incidentTypeChart').getContext('2d');
    incidentTypeChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Number of Reports',
          data: data,
          backgroundColor: backgroundColors,
          borderColor: borderColors,
          borderWidth: 1,
          hoverBackgroundColor: hoverBackgroundColors
        }]
      },
      options: {
        ...chartConfig,
        plugins: {
          ...chartConfig.plugins,
          title: { 
            display: true, 
            text: 'Reports by Incident Type',
            font: { size: 16, weight: 'bold' },
            padding: { bottom: 20 }
          }
        }
      }
    });
  }

  // Update blotter type chart - Filter out N/A values
  function updateBlotterTypeChart(reports) {
    // Group reports by blotter type, excluding N/A values
    const reportsByBlotterType = {};
    
    reports.forEach(report => {
      const blotterType = report.blotterType || "Unknown";
      // Skip if blotterType is N/A
      if (blotterType === "N/A" || blotterType === "n/a") return;
      
      if (!reportsByBlotterType[blotterType]) {
        reportsByBlotterType[blotterType] = 0;
      }
      reportsByBlotterType[blotterType]++;
    });
    
    // Prepare chart data
    const labels = Object.keys(reportsByBlotterType);
    const data = Object.values(reportsByBlotterType);
    
    // Colors for chart
    const colorKeys = Object.keys(chartColors);
    const backgroundColors = labels.map((_, i) => {
      const color = chartColors[colorKeys[i % colorKeys.length]];
      return color.primary;
    });
    
    const borderColors = labels.map((_, i) => {
      const color = chartColors[colorKeys[i % colorKeys.length]];
      return color.border;
    });
    
    const hoverBackgroundColors = labels.map((_, i) => {
      const color = chartColors[colorKeys[i % colorKeys.length]];
      return color.hover;
    });
    
    // Destroy existing chart if it exists
    if (blotterTypeChart) {
      blotterTypeChart.destroy();
    }
    
    // Create new chart as bar chart
    const ctx = document.getElementById('blotterTypeChart').getContext('2d');
    blotterTypeChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Number of Reports',
          data: data,
          backgroundColor: backgroundColors,
          borderColor: borderColors,
          borderWidth: 1,
          hoverBackgroundColor: hoverBackgroundColors
        }]
      },
      options: {
        ...chartConfig,
        plugins: {
          ...chartConfig.plugins,
          title: { 
            display: true, 
            text: 'Reports by Blotter Type',
            font: { size: 16, weight: 'bold' },
            padding: { bottom: 20 }
          }
        }
      }
    });
  }

  // Reset dashboard when no data
  function resetDashboard() {
    totalReportsEl.textContent = "0";
    urgentCasesEl.textContent = "0";
    scheduledReportsEl.textContent = "0";
    notifCountEl.textContent = "0";
    notifDropdownEl.innerHTML = "<div>No submitted reports available</div>";
    
    // Destroy all charts
    if (reportChart) reportChart.destroy();
    if (incidentTypeChart) incidentTypeChart.destroy();
    if (blotterTypeChart) blotterTypeChart.destroy();
    
    // Create empty charts
    const emptyData = {
      labels: ['No data'],
      datasets: [{
        data: [0],
        backgroundColor: ['#cbd5e1']
      }]
    };
    
    const emptyOptions = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        title: { 
          display: true, 
          text: 'No data available',
          font: { size: 16, weight: 'bold' }
        }
      }
    };
    
    // Report chart
    const reportCtx = document.getElementById('reportChart').getContext('2d');
    reportChart = new Chart(reportCtx, {
      type: 'bar',
      data: emptyData,
      options: emptyOptions
    });
    
    // Incident type chart
    const incidentCtx = document.getElementById('incidentTypeChart').getContext('2d');
    incidentTypeChart = new Chart(incidentCtx, {
      type: 'bar',
      data: emptyData,
      options: emptyOptions
    });
    
    // Blotter type chart
    const blotterCtx = document.getElementById('blotterTypeChart').getContext('2d');
    blotterTypeChart = new Chart(blotterCtx, {
      type: 'bar',
      data: emptyData,
      options: emptyOptions
    });
  }

  // Toggle notification dropdown
  window.toggleDropdown = function() {
    notifDropdownEl.style.display = notifDropdownEl.style.display === "block" ? "none" : "block";
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(event) {
    const isClickInside = event.target.closest('.notif-icon');
    if (!isClickInside && notifDropdownEl.style.display === "block") {
      notifDropdownEl.style.display = "none";
    }
  });

  // Logout function
  window.logout = function() {
    localStorage.removeItem("adminUid");
    localStorage.removeItem("adminName");
    signOut(auth).then(() => {
      window.location.href = "index.html";
    }).catch((error) => {
      console.error("Logout error:", error);
    });
  }

  // Download chart as PDF
  window.downloadChart = function(canvasId, fileName) {
    const canvas = document.getElementById(canvasId);
    const chartTitle = document.querySelector(`#${canvasId}`).closest('.sections').querySelector('h3').textContent;
    const date = new Date().toLocaleDateString();
    
    // Use html2canvas to capture the chart
    html2canvas(canvas).then(canvasImg => {
      // Create PDF
      const pdf = new jspdf.jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a4'
      });
      
      // Add title and date
      pdf.setFontSize(16);
      pdf.text(chartTitle, 20, 15);
      pdf.setFontSize(10);
      pdf.text(`Generated on: ${date}`, 20, 22);
      
      // Add chart image
      const imgData = canvasImg.toDataURL('image/png');
      const imgWidth = 260; // mm
      const imgHeight = canvasImg.height * imgWidth / canvasImg.width;
      pdf.addImage(imgData, 'PNG', 20, 30, imgWidth, imgHeight);
      
      // Save the PDF
      pdf.save(`${fileName}_${date.replace(/\//g, '-')}.pdf`);
    });
  }

  // Initialize the dashboard
  loadReportsData();
  loadAboutInfo();
  
  // Add event listeners
  aboutBtn.addEventListener('click', showAboutModal);
  closeModalBtn.addEventListener('click', hideAboutModal);
  cancelBtn.addEventListener('click', hideAboutModal);
  saveBtn.addEventListener('click', saveAboutInfo);
  editBtn.addEventListener('click', switchToEditMode);
  silenceAlarmBtn.addEventListener('click', silenceAlarm);
  
  // Image upload event listeners
  uploadImageBtn.addEventListener('click', () => mayorImageInput.click());
  changeImageBtn.addEventListener('click', () => mayorImageInput.click());
  mayorImageInput.addEventListener('change', handleImageSelect);
  removeImageBtn.addEventListener('click', handleRemoveImage);
  
  // Close modal when clicking outside
  aboutModal.addEventListener('click', function(event) {
    if (event.target === aboutModal) {
      hideAboutModal();
    }
  });
</script>

</body>
</html>