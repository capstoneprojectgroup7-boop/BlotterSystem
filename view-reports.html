<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>View All Reports</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  
  <!-- Add Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
<style>
    * {
      box-sizing: border-box;
      text-decoration: none;
    }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      display: flex;
      min-height: 100vh;
      background-color: #f4f6f9;
    }
    
    /* Sidebar with responsive behavior */
    .sidebar {
      width: 260px;
      background-color: #1e293b;
      color: #ffffff;
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100%;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      transition: transform 0.3s ease;
    }
    
    .sidebar-toggle {
      display: none;
      position: fixed;
      top: 15px;
      left: 15px;
      background: #1e293b;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      z-index: 1100;
      cursor: pointer;
    }
    
    .sidebar h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 40px;
      text-align: center;
    }
    .nav-link {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-radius: 6px;
      color: #cbd5e1;
      margin-bottom: 12px;
      transition: background 0.3s ease, color 0.3s ease;
    }
    .nav-link:hover {
      background-color: #334155;
      color: #ffffff;
    }
    .nav-link span {
      margin-left: 10px;
      font-size: 15px;
    }
    
    /* Main content area */
    .main-content {
      margin-left: 260px;
      padding: 40px;
      width: calc(100% - 260px);
      background: #f9fafb;
      min-height: 100vh;
      overflow: auto;
      position: relative;
    }
    
   .notification-banner {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: white;
      padding: 18px 24px;
      border-radius: 12px;
      margin-bottom: 30px;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .notification-banner span {
      font-size: 16px;
    }

   .section {
      background-color: #ffffff;
      padding: 25px;
      margin-bottom: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      position: relative;
    }

    .section h3 {
      margin-top: 0;
      font-size: 20px;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 10px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* New table container styling */
    .table-container {
      background-color: #f9fafb;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      border: 1px solid #e5e7eb;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 1400px;
      background-color: #ffffff;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    table th, table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    table th {
      background-color: #f8fafc;
      font-weight: 600;
      position: sticky;
      top: 0;
      color: #374151;
      border-top: 1px solid #e5e7eb;
      border-bottom: 2px solid #e5e7eb;
    }

    table tr:last-child td {
      border-bottom: none;
    }

    table tr:hover {
      background-color: #f9fafb;
    }

    .status-resolved {
      color: #16a34a;
      font-weight: bold;
      background-color: #f0fdf4;
      padding: 4px 8px;
      border-radius: 20px;
      display: inline-block;
    }

    .status-unresolved {
      color: #dc2626;
      font-weight: bold;
      background-color: #fef2f2;
      padding: 4px 8px;
      border-radius: 20px;
      display: inline-block;
    }
    
    .status-pending {
      color: #d97706;
      font-weight: bold;
      background-color: #fffbeb;
      padding: 4px 8px;
      border-radius: 20px;
      display: inline-block;
    }

    .urgent-tag {
      background-color: #fef2f2;
      color: #dc2626;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      display: inline-block;
    }

    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background-color: #1d4ed8;
    }

    .export-btn {
      background-color: #16a34a;
      padding: 10px 16px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .export-btn:hover {
      background-color: #15803d;
    }

    /* Logout button styling */
    .logout-btn {
      margin-top: auto;
      background-color: #dc2626;
      padding: 12px;
      text-align: center;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .logout-btn:hover {
      background-color: #b91c1c;
    }

    /* Loading indicator */
    .loading {
      text-align: center;
      padding: 30px;
      font-style: italic;
      color: #6b7280;
    }

    /* Filter controls */
    .filter-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-controls select, 
    .filter-controls input {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      min-width: 150px;
    }
    
    /* Modal styles - UPDATED DESIGN */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .modal-header {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: white;
      padding: 20px 30px;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
    }
    
    .close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.3s;
    }
    
    .close:hover {
      opacity: 1;
    }
    
    .modal-body {
      padding: 30px;
    }
    
    /* Letter Editor Modal Styles - NEW */
    .letter-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
    }
    
    .letter-modal-content {
      background-color: white;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    }
    
    .letter-header {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      padding: 20px 30px;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .letter-header h2 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
    }
    
    .letter-close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.3s;
    }
    
    .letter-close:hover {
      opacity: 1;
    }
    
    .letter-body {
      padding: 30px;
      flex: 1;
      overflow-y: auto;
    }
    
    .letter-preview {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 30px;
      margin-bottom: 20px;
      background: white;
      font-family: 'Times New Roman', serif;
      line-height: 1.6;
      min-height: 400px;
      position: relative;
    }
    
    .letter-preview.editable {
      border: 2px dashed #3b82f6;
    }
    
    .letter-preview h3 {
      text-align: center;
      text-decoration: underline;
      margin-bottom: 30px;
    }
    
    .letter-preview p {
      margin-bottom: 15px;
    }
    
    .letter-editable {
      border: 1px solid #d1d5db;
      border-radius: 4px;
      padding: 8px;
      background-color: #f9fafb;
      width: 100%;
      font-family: 'Times New Roman', serif;
      font-size: 16px;
    }
    
    .letter-input-group {
      margin-bottom: 15px;
    }
    
    .letter-input-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #374151;
    }
    
    .letter-input-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .letter-input-row .letter-input-group {
      flex: 1;
    }
    
    .letter-signature-section {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }
    
    .letter-signature-row {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }
    
    .letter-signature {
      text-align: center;
      width: 45%;
    }
    
    .letter-signature-line {
      border-bottom: 1px solid #000;
      padding-bottom: 5px;
      margin-bottom: 10px;
      min-width: 200px;
    }
    
    .letter-actions {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }
    
    .letter-edit-btn {
      background-color: #f59e0b;
    }
    
    .letter-edit-btn:hover {
      background-color: #d97706;
    }
    
    .letter-preview-btn {
      background-color: #10b981;
    }
    
    .letter-preview-btn:hover {
      background-color: #059669;
    }
    
    .letter-download-btn {
      background-color: #3b82f6;
    }
    
    .letter-download-btn:hover {
      background-color: #2563eb;
    }
    
    .letter-cancel-btn {
      background-color: #6b7280;
    }
    
    .letter-cancel-btn:hover {
      background-color: #4b5563;
    }
    
    /* Edit mode toggle */
    .edit-mode-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .edit-mode-toggle label {
      font-weight: 500;
      color: #374151;
    }
    
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: #3b82f6;
    }
    
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .detail-card {
      background-color: #f9fafb;
      border-radius: 8px;
      padding: 18px;
      border-left: 4px solid #3b82f6;
    }
    
    .detail-card.urgent {
      border-left-color: #dc2626;
    }
    
    .detail-label {
      font-weight: 600;
      font-size: 13px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    
    .detail-value {
      font-size: 16px;
      color: #1f2937;
      line-height: 1.5;
    }
    
    .description-card {
      grid-column: 1 / -1;
      background-color: #f9fafb;
      border-radius: 8px;
      padding: 18px;
      border-left: 4px solid #10b981;
    }
    
    .action-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }
    
    .close-btn {
      background-color: #6b7280;
      padding: 10px 20px;
    }
    
    .close-btn:hover {
      background-color: #4b5563;
    }
    
    /* View details button */
    .view-btn {
      background-color: #8b5cf6;
    }
    
    .view-btn:hover {
      background-color: #7c3aed;
    }
    
    .view-details {
      background-color: #3b82f6;
      margin-right: 8px;
    }
    
    .view-details:hover {
      background-color: #2563eb;
    }
    
    /* Message button */
    .message-btn {
      background-color: #10b981;
      padding: 6px 10px;
      margin-right: 8px;
      position: relative;
    }
    
    .message-btn:hover {
      background-color: #059669;
    }
    
    /* Generate Letter button */
    .letter-btn {
      background-color: #8b5cf6;
      padding: 6px 10px;
      margin-right: 8px;
    }
    
    .letter-btn:hover {
      background-color: #7c3aed;
    }
    
    /* Media button styling */
    .media-btn {
      background: #3b82f6;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease-in-out;
      position: relative;
      margin-right: 8px;
    }
    
    .media-btn:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    
    /* Message notification badge */
    .message-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: #dc2626;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    /* Media count badge */
    .media-count-badge {
      background: #ef4444;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      position: absolute;
      top: -5px;
      right: -5px;
    }
    
    /* Message modal styles */
    .message-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }
    
    .message-modal-content {
      background-color: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }
    
    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .message-header h2 {
      margin: 0;
      font-size: 20px;
    }
    
    .message-close {
      color: #aaa;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .message-close:hover {
      color: black;
    }
    
    .message-container {
      flex: 1;
      overflow-y: auto;
      max-height: 300px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f1f5f9;
      border-radius: 8px;
    }
    
    .message {
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 8px;
      max-width: 80%;
      clear: both;
    }
    
    /* Main Admin messages (right side) */
    .message.admin {
      background-color: #dbeafe;
      float: right;
      text-align: right;
      margin-left: auto;
      border-right: 4px solid #2563eb;
    }
    
    /* Other users' messages (left side) */
    .message.other {
      background-color: #f0f0f0;
      float: left;
      text-align: left;
      margin-right: auto;
      border-left: 4px solid #6b7280;
    }
    
    .message-sender {
      font-weight: bold;
      font-size: 12px;
      margin-bottom: 5px;
    }
    
    .message.admin .message-sender {
      color: #2563eb;
    }
    
    .message.other .message-sender {
      color: #4b5563;
    }
    
    .message-time {
      font-size: 11px;
      color: #6b7280;
      margin-top: 5px;
    }
    
    .message-input {
      display: flex;
      gap: 10px;
    }
    
    .message-input input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .message-input button {
      padding: 12px 20px;
    }
    
    /* Media viewer modal styles */
    .media-modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }
    
    .media-modal-content {
      background-color: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }
    
    .media-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .media-header h2 {
      margin: 0;
      font-size: 20px;
    }
    
    .media-close {
      color: #aaa;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .media-close:hover {
      color: black;
    }
    
    /* Media tabs */
    .media-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 10px;
    }
    
    .media-tab {
      padding: 8px 16px;
      background: none;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      color: #6b7280;
      position: relative;
    }
    
    .media-tab:hover {
      color: #4f46e5;
    }
    
    .media-tab.active {
      color: #4f46e5;
    }
    
    .media-tab.active::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 0;
      right: 0;
      height: 2px;
      background: #4f46e5;
    }
    
    .media-tab-badge {
      background: #ef4444;
      color: white;
      border-radius: 10px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 500;
      margin-left: 6px;
    }
    
    /* Media container */
    .media-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      max-height: 500px;
      overflow-y: auto;
      padding: 10px;
    }
    
    .media-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      transition: transform 0.3s ease;
    }
    
    .media-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .media-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    
    .media-image:hover {
      transform: scale(1.05);
    }
    
    .media-video {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #000;
    }
    
    .media-type-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .media-empty {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
      grid-column: 1 / -1;
    }
    
    .media-empty i {
      font-size: 48px;
      margin-bottom: 15px;
      color: #d1d5db;
    }
    
    /* Full screen image viewer */
    .full-image-modal {
      display: none;
      position: fixed;
      z-index: 1002;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      align-items: center;
      justify-content: center;
    }
    
    .full-image-content {
      max-width: 90vw;
      max-height: 90vh;
      position: relative;
    }
    
    .full-image {
      max-width: 100%;
      max-height: 90vh;
      object-fit: contain;
    }
    
    .full-image-close {
      position: absolute;
      top: 15px;
      right: 15px;
      color: white;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
      background: rgba(0,0,0,0.5);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Clearfix for message container */
    .message-container::after {
      content: "";
      display: table;
      clear: both;
    }
    
    /* Card view for mobile */
    .reports-cards-container {
      display: none;
      flex-direction: column;
      gap: 15px;
    }
    
    .report-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .report-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .report-card-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .report-card-field {
      margin-bottom: 8px;
    }
    
    .report-card-field .label {
      font-weight: 600;
      color: #64748b;
      font-size: 12px;
      margin-bottom: 3px;
    }
    
    .report-card-field .value {
      font-size: 14px;
      word-break: break-word;
    }
    
    .report-card-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }
    
    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .sidebar {
        width: 220px;
      }
      
      .main-content {
        margin-left: 220px;
        width: calc(100% - 220px);
        padding: 30px;
      }
      
      .detail-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
      
      table {
        min-width: 1200px;
      }
    }
    
    @media (max-width: 992px) {
      .filter-controls {
        flex-direction: column;
      }
      
      .filter-controls select, 
      .filter-controls input {
        width: 100%;
      }
    }
    
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .sidebar-toggle {
        display: block;
      }
      
      .main-content {
        margin-left: 0;
        width: 100%;
        padding: 60px 15px 15px;
      }
      
      .notification-banner {
        flex-direction: column;
        text-align: center;
        gap: 10px;
      }
      
      .section h3 {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      /* Switch to card view on mobile */
      .table-container {
        display: none;
      }
      
      .reports-cards-container {
        display: flex;
      }
      
      .message {
        max-width: 90%;
      }
      
      .detail-grid {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .modal-content {
        width: 95%;
      }
      
      .letter-modal-content {
        width: 95%;
        padding: 15px;
      }
      
      .letter-input-row {
        flex-direction: column;
      }
      
      .letter-signature-row {
        flex-direction: column;
        gap: 20px;
      }
      
      .letter-signature {
        width: 100%;
      }
      
      .letter-actions {
        flex-direction: column;
      }
      
      .letter-actions button {
        width: 100%;
      }
      
      .media-container {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      
      .media-modal-content {
        padding: 15px;
      }
    }
    
    @media (max-width: 576px) {
      .report-card-body {
        grid-template-columns: 1fr;
      }
      
      .report-card-actions {
        flex-direction: column;
      }
      
      .report-card-actions button {
        width: 100%;
      }
      
      .section {
        padding: 15px;
      }
      
      .message-modal-content {
        padding: 15px;
      }
      
      .message-input {
        flex-direction: column;
      }
      
      .media-container {
        grid-template-columns: 1fr;
      }
      
      .letter-body {
        padding: 15px;
      }
      
      .letter-preview {
        padding: 15px;
      }
    }
    
    @media (min-width: 769px) {
      .sidebar {
        transform: translateX(0) !important;
      }
    }
  </style>
</head>
<body>
  <button class="sidebar-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
  </button>
  
  <div class="sidebar" id="sidebar">
    <h2>JIABONG LGU ADMIN</h2>

     <a class="nav-link" href="MainAdmin.html">
      <i class="fas fa-chart-bar"></i> <span>Dashboard</span>
    </a>

    <a class="nav-link" href="brgy-accounts.html">
      <i class="fas fa-users-cog"></i> <span>Manage Brgy Accounts</span>
    </a>
    <a class="nav-link" href="view-reports.html">
      <i class="fas fa-folder-open"></i> <span>View All Reports</span>
    </a>
    <a class="nav-link" href="urgent-cases.html">
      <i class="fas fa-exclamation-circle"></i> <span>Urgent Cases</span>
    </a>
    <a class="nav-link" href="schedule.html">
      <i class="fas fa-calendar-alt"></i> <span>Scheduled Responses</span>
    </a>
  

  <!-- Logout Button -->
    <div class="logout-btn" onclick="logout()">
      <i class="fas fa-sign-out-alt"></i> Logout
    </div>
  </div>


  <div class="main-content">
    <div class="notification-banner">
      <span>All Barangay Reports</span>
      <span id="report-count">0 reports found</span>
    </div>
    
    <div class="filter-controls">
      <select id="month-filter">
        <option value="all">All Months</option>
        <option value="01">January</option>
        <option value="02">February</option>
        <option value="03">March</option>
        <option value="04">April</option>
        <option value="05">May</option>
        <option value="06">June</option>
        <option value="07">July</option>
        <option value="08">August</option>
        <option value="09">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
      </select>
      
      <select id="status-filter">
        <option value="all">All Statuses</option>
        <option value="Resolved">Resolved</option>
        <option value="Unresolved">Unresolved</option>
        <option value="Pending">Pending</option>
      </select>
      
      <select id="barangay-filter">
        <option value="all">All Barangays</option>
        <!-- Options will be populated dynamically -->
      </select>
      
      <select id="category-filter">
        <option value="all">All Categories</option>
        <!-- Options will be populated dynamically -->
      </select>
      
      <select id="incidentType-filter">
        <option value="all">All Incident Types</option>
        <!-- Options will be populated dynamically -->
      </select>
      
      <select id="blotterType-filter">
        <option value="all">All Blotter Types</option>
        <!-- Options will be populated dynamically -->
      </select>
      
      <input type="text" id="search-input" placeholder="Search reports...">
    </div>
    
    <section class="section">
      <h3>
        <span>Reports</span>
        <button class="export-btn" onclick="exportToPDF()">
          <i class="fas fa-file-pdf"></i> Export to PDF
        </button>
      </h3>
      
      <!-- Table view for larger screens -->
      <div class="table-container">
        <table id="reportTable">
          <thead>
            <tr>
              <th>Case #</th>
              <th>Barangay</th>
              <th>Date Submitted</th>
              <th>Reporter</th>
              <th>Category</th>
              <th>Incident Type</th>
              <th>Blotter Type</th>
              <th>Description</th>
              <th>Status</th>
              <th>Urgent</th>
              <th>Media</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="12" class="loading">Loading reports...</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Card view for mobile screens -->
      <div class="reports-cards-container" id="reports-cards-container">
        <!-- Cards will be dynamically populated -->
        <div class="loading">Loading reports...</div>
      </div>
    </section>
  </div>

  <!-- Modal for report details -->
  <div id="detailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Report Details</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div id="modal-body-content">
          <!-- Details will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for messaging -->
  <div id="messageModal" class="message-modal">
    <div class="message-modal-content">
      <div class="message-header">
        <h2>Messages for Report: <span id="message-report-id"></span></h2>
        <span class="message-close">&times;</span>
      </div>
      
      <div class="message-container" id="message-container">
        <!-- Messages will be populated here -->
      </div>
      
      <div class="message-input">
        <input type="text" id="message-input" placeholder="Type your message here...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- Letter Editor Modal - NEW -->
  <div id="letterModal" class="letter-modal">
    <div class="letter-modal-content">
      <div class="letter-header">
        <h2><i class="fas fa-file-alt"></i> Generate Official Letter</h2>
        <span class="letter-close">&times;</span>
      </div>
      
      <div class="letter-body">
        <div class="edit-mode-toggle">
          <label for="edit-mode">Edit Mode:</label>
          <label class="switch">
            <input type="checkbox" id="edit-mode" onchange="toggleEditMode()">
            <span class="slider"></span>
          </label>
        </div>
        
        <div class="letter-preview" id="letter-preview">
          <!-- Letter preview will be generated here -->
        </div>
        
        <div id="letter-editor" style="display: none;">
          <h3>Edit Letter Content</h3>
          
          <div class="letter-input-row">
            <div class="letter-input-group">
              <label for="letter-title">Letter Title:</label>
              <input type="text" id="letter-title" class="letter-editable" value="CERTIFICATION TO FILE ACTION">
            </div>
            
            <div class="letter-input-group">
              <label for="letter-date">Date:</label>
              <input type="text" id="letter-date" class="letter-editable" placeholder="DD/MM/YYYY">
            </div>
          </div>
          
          <div class="letter-input-group">
            <label for="complainant-name">Complainant Name:</label>
            <input type="text" id="complainant-name" class="letter-editable">
          </div>
          
          <div class="letter-input-group">
            <label for="respondent-name">Respondent Name:</label>
            <input type="text" id="respondent-name" class="letter-editable">
          </div>
          
          <div class="letter-input-row">
            <div class="letter-input-group">
              <label for="case-number">Case Number:</label>
              <input type="text" id="case-number" class="letter-editable">
            </div>
            
            <div class="letter-input-group">
              <label for="case-for">Case For:</label>
              <input type="text" id="case-for" class="letter-editable" placeholder="e.g., ALARMING SCANDAL">
            </div>
          </div>
          
          <div class="letter-input-group">
            <label for="certification-text">Certification Text:</label>
            <textarea id="certification-text" class="letter-editable" rows="4" placeholder="Enter certification text..."></textarea>
          </div>
          
          <div class="letter-signature-section">
            <div class="letter-input-row">
              <div class="letter-input-group">
                <label for="secretary-name">Barangay Secretary Name:</label>
                <input type="text" id="secretary-name" class="letter-editable" value="_________________________">
              </div>
              
              <div class="letter-input-group">
                <label for="barangay-captain">Punong Barangay Name:</label>
                <input type="text" id="barangay-captain" class="letter-editable" value="_________________________">
              </div>
            </div>
            
            <div class="letter-input-group">
              <label for="footer-note">Footer Note:</label>
              <textarea id="footer-note" class="letter-editable" rows="2">Official Document - Not Valid Without Seal</textarea>
            </div>
          </div>
        </div>
        
        <div class="letter-actions">
          <button class="letter-cancel-btn" onclick="closeLetterModal()">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button class="letter-edit-btn" onclick="toggleEditMode()" id="edit-toggle-btn">
            <i class="fas fa-edit"></i> Edit Letter
          </button>
          <button class="letter-preview-btn" onclick="updateLetterPreview()" id="preview-btn" style="display: none;">
            <i class="fas fa-eye"></i> Update Preview
          </button>
          <button class="letter-download-btn" onclick="downloadEditedLetter()">
            <i class="fas fa-download"></i> Download PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Media Viewer Modal -->
  <div id="mediaModal" class="media-modal">
    <div class="media-modal-content">
      <div class="media-header">
        <h2><i class="fas fa-images"></i> Report Media</h2>
        <span class="media-close">&times;</span>
      </div>
      
      <div style="margin-bottom: 20px;">
        <p><strong>Case #:</strong> <span id="mediaCaseNumber"></span></p>
        <p><strong>Report Type:</strong> <span id="mediaReportType"></span></p>
      </div>
      
      <div class="media-tabs" id="mediaTabs">
        <!-- Tabs will be generated here -->
      </div>
      
      <div class="media-container" id="imagesContainer">
        <!-- Images will be loaded here -->
      </div>
      
      <div class="media-container" id="videosContainer" style="display: none;">
        <!-- Videos will be loaded here -->
      </div>
      
      <div style="text-align: center; margin-top: 20px; color: #6b7280; font-size: 14px;">
        <i class="fas fa-info-circle"></i> Click on an image to view full size
      </div>
    </div>
  </div>

  <!-- Full Screen Image Modal -->
  <div id="fullImageModal" class="full-image-modal">
    <div class="full-image-content">
      <span class="full-image-close" onclick="closeFullImage()">&times;</span>
      <img id="fullImageView" class="full-image" src="">
    </div>
  </div>

<script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCSUCbCVKEYZx_-dySDrAauf1OZ6GIUMgI",
        authDomain: "bpoms-15479.firebaseapp.com",
        databaseURL: "https://bpoms-15479-default-rtdb.firebaseio.com",
        projectId: "bpoms-15479",
        storageBucket: "bpoms-15479.appspot.com",
        messagingSenderId: "461076757426",
        appId: "1:461076757426:web:61adf7d3f1734cc05702ab"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const db = firebase.database();

    // Array to store reports
    let reports = [];
    let filteredReports = [];
    let currentReportId = null;
    let currentUser = null;
    let unreadMessages = {};
    let messageListeners = {};
    let currentReportData = null;
    
    // Letter editing variables
    let currentLetterReport = null;
    let isEditMode = false;
    let originalLetterData = {};

    // Helper function to check if a URL is a video
    function isVideoUrl(url) {
      if (!url) return false;
      
      const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov', '.avi', '.wmv', '.flv', '.mkv'];
      const urlLower = url.toLowerCase();
      
      for (const ext of videoExtensions) {
        if (urlLower.includes(ext) || urlLower.endsWith(ext)) {
          return true;
        }
      }
      
      const videoPatterns = [
        '/video/', '/videos/', 'video=true', 'type=video',
        'firebasestorage.googleapis.com/v0/b/.*/o/.*\.mp4'
      ];
      
      for (const pattern of videoPatterns) {
        const regex = new RegExp(pattern, 'i');
        if (regex.test(url)) {
          return true;
        }
      }
      
      return false;
    }

    // Function to open letter editor modal
    function openLetterEditor(reportId) {
        const report = reports.find(r => r.id === reportId);
        if (!report) {
            alert('Report not found!');
            return;
        }
        
        currentLetterReport = report;
        
        // Store original data
        originalLetterData = {
            complainantName: report.reporter || 'N/A',
            respondentName: report.fullData?.respondentName || 'N/A',
            caseNumber: report.caseNumber,
            barangay: report.barangay,
            category: report.category,
            incidentType: report.incidentType,
            blotterType: report.blotterType,
            currentDate: new Date()
        };
        
        // Initialize letter content
        initializeLetterContent();
        
        // Show the modal
        document.getElementById('letterModal').style.display = 'flex';
    }

    // Initialize letter content with default values
    function initializeLetterContent() {
        if (!currentLetterReport) return;
        
        const currentDate = new Date();
        const day = currentDate.getDate();
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const month = monthNames[currentDate.getMonth()];
        const year = currentDate.getFullYear();
        
        // Set form values
        document.getElementById('letter-date').value = `${day}${getOrdinalSuffix(day)} day of ${month}, ${year}`;
        document.getElementById('complainant-name').value = originalLetterData.complainantName;
        document.getElementById('respondent-name').value = originalLetterData.respondentName;
        document.getElementById('case-number').value = originalLetterData.caseNumber;
        
        // Set case for based on category
        let caseFor = '';
        if (originalLetterData.category === 'Blotter') {
            caseFor = originalLetterData.blotterType || 'ALARMING SCANDAL';
        } else {
            caseFor = originalLetterData.incidentType || 'ALARMING SCANDAL';
        }
        document.getElementById('case-for').value = caseFor;
        
        // Set certification text based on category
        let certificationText = '';
        if (originalLetterData.category === 'Blotter') {
            certificationText = `The respondents, ${originalLetterData.respondentName}, residents of Barangay ${originalLetterData.barangay}, Jiabong, Samar failed to fulfill the agreement settlement that was scheduled on ______ for the overdue credits and therefore the corresponding complaints for the dispute may now be filed in Jiabong Philippine National Police, Jiabong, Samar or in court.`;
        } else {
            certificationText = `This is to certify that the above-mentioned case has been duly filed and recorded in this barangay. After careful review and consideration, it has been determined that the matter requires further legal action. The parties involved are hereby certified to file appropriate action with the proper authorities or courts of law.`;
        }
        document.getElementById('certification-text').value = certificationText;
        
        // Update preview
        updateLetterPreview();
    }

    // Toggle edit mode
    function toggleEditMode() {
        isEditMode = !isEditMode;
        const editModeCheckbox = document.getElementById('edit-mode');
        const editorSection = document.getElementById('letter-editor');
        const previewSection = document.getElementById('letter-preview');
        const editButton = document.getElementById('edit-toggle-btn');
        const previewButton = document.getElementById('preview-btn');
        
        if (isEditMode) {
            editorSection.style.display = 'block';
            previewSection.classList.add('editable');
            editButton.innerHTML = '<i class="fas fa-eye"></i> View Preview';
            previewButton.style.display = 'inline-block';
            editModeCheckbox.checked = true;
        } else {
            editorSection.style.display = 'none';
            previewSection.classList.remove('editable');
            editButton.innerHTML = '<i class="fas fa-edit"></i> Edit Letter';
            previewButton.style.display = 'none';
            editModeCheckbox.checked = false;
            updateLetterPreview();
        }
    }

    // Update letter preview based on form inputs
    function updateLetterPreview() {
        const previewSection = document.getElementById('letter-preview');
        
        // Get values from form
        const letterTitle = document.getElementById('letter-title').value;
        const letterDate = document.getElementById('letter-date').value;
        const complainantName = document.getElementById('complainant-name').value;
        const respondentName = document.getElementById('respondent-name').value;
        const caseNumber = document.getElementById('case-number').value;
        const caseFor = document.getElementById('case-for').value;
        const certificationText = document.getElementById('certification-text').value;
        const secretaryName = document.getElementById('secretary-name').value;
        const barangayCaptain = document.getElementById('barangay-captain').value;
        const footerNote = document.getElementById('footer-note').value;
        
        // Get current date for generation info
        const currentDate = new Date();
        const generatedDate = currentDate.toLocaleDateString();
        
        // Generate preview HTML
        previewSection.innerHTML = `
            <div style="text-align: center;">
                <h3>Republic of the Philippines</h3>
                <p>Province of Samar</p>
                <p>Municipality of Jiabong</p>
                <p><strong>BARANGAY ${(currentLetterReport?.barangay || '').toUpperCase()}</strong></p>
                <p>OFFICE OF THE PUNONG BARANGAY</p>
            </div>
            
            <div style="margin: 30px 0; text-align: center;">
                <p><strong>${complainantName}</strong></p>
                <p>&gt;Complainants&lt;</p>
                <p>Against</p>
                <p><strong>${respondentName}</strong></p>
                <p>&gt;Respondents&lt;</p>
            </div>
            
            <div style="margin: 20px 0;">
                <p><strong>Barangay Case No. ${caseNumber}</strong></p>
                <p><strong>For: ${caseFor}</strong></p>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <h3>${letterTitle}</h3>
            </div>
            
            <div style="margin: 20px 0;">
                <p><strong>THIS IS TO CERTIFY THAT:</strong></p>
                <p style="text-align: justify; margin-left: 20px; margin-right: 20px;">
                    ${certificationText}
                </p>
                <p style="margin-top: 30px;">GIVEN this ${letterDate}, Barangay ${currentLetterReport?.barangay || ''}, Jiabong, Samar.</p>
            </div>
            
            <div style="margin-top: 50px; display: flex; justify-content: space-between;">
                <div style="text-align: center;">
                    <div class="letter-signature-line">${secretaryName}</div>
                    <p>Barangay Secretary</p>
                </div>
                
                <div style="text-align: center;">
                    <p>ATTESTED:</p>
                    <div class="letter-signature-line">${barangayCaptain}</div>
                    <p>Punong Barangay</p>
                </div>
            </div>
            
            <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #666;">
                <p>${footerNote}</p>
                <p>Generated by BPOMS System on ${generatedDate}</p>
                <p>Case Reference: ${currentLetterReport?.id || ''}</p>
            </div>
        `;
    }

    // Download the edited letter as PDF
    function downloadEditedLetter() {
        if (!currentLetterReport) return;
        
        // Get values from form
        const letterTitle = document.getElementById('letter-title').value;
        const letterDate = document.getElementById('letter-date').value;
        const complainantName = document.getElementById('complainant-name').value;
        const respondentName = document.getElementById('respondent-name').value;
        const caseNumber = document.getElementById('case-number').value;
        const caseFor = document.getElementById('case-for').value;
        const certificationText = document.getElementById('certification-text').value;
        const secretaryName = document.getElementById('secretary-name').value;
        const barangayCaptain = document.getElementById('barangay-captain').value;
        const footerNote = document.getElementById('footer-note').value;
        
        // Create a new jsPDF instance
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Set document properties
        doc.setProperties({
            title: `${letterTitle} - ${caseNumber}`,
            subject: 'Barangay Certification',
            author: 'Municipality of Jiabong, Samar',
            keywords: 'certification, barangay, official',
            creator: 'BPOMS System'
        });

        // Add letter content
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Republic of the Philippines', 105, 20, { align: 'center' });
        doc.text('Province of Samar', 105, 27, { align: 'center' });
        doc.text('Municipality of Jiabong', 105, 34, { align: 'center' });
        doc.text(`BARANGAY ${(currentLetterReport?.barangay || '').toUpperCase()}`, 105, 44, { align: 'center' });

        doc.setFontSize(12);
        doc.text('OFFICE OF THE PUNONG BARANGAY', 105, 55, { align: 'center' });

        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        
        // Complainant and Respondent information
        doc.text(complainantName, 105, 75, { align: 'center' });
        doc.text('>Complainants<', 105, 80, { align: 'center' });
        doc.text('Against', 105, 90, { align: 'center' });
        doc.text(respondentName, 105, 95, { align: 'center' });
        doc.text('>Respondents<', 105, 100, { align: 'center' });

        // Case information
        doc.text(`Barangay Case No. ${caseNumber}`, 20, 115);
        doc.text(`For: ${caseFor}`, 20, 122);

        // Title
        doc.setFont('helvetica', 'bold');
        doc.text(letterTitle, 105, 135, { align: 'center' });

        // Certification content
        doc.setFont('helvetica', 'normal');
        doc.text('THIS IS TO CERTIFY THAT:', 20, 145);

        // Split text into lines that fit the page width
        const splitText = doc.splitTextToSize(certificationText, 170);
        doc.text(splitText, 20, 155);

        // Date and location
        doc.text(`GIVEN this ${letterDate}, Barangay ${currentLetterReport?.barangay || ''}, Jiabong, Samar.`, 20, 195);

        // Signature lines
        doc.text(secretaryName, 30, 215);
        doc.text('Barangay Secretary', 30, 222);
        
        doc.text('ATTESTED:', 140, 215);
        doc.text(barangayCaptain, 140, 225);
        doc.text('Punong Barangay', 140, 232);

        // Footer note
        const currentDate = new Date();
        doc.setFontSize(9);
        doc.setTextColor(100);
        doc.text(footerNote, 105, 260, { align: 'center' });
        doc.text(`Generated by BPOMS System on ${currentDate.toLocaleDateString()}`, 105, 265, { align: 'center' });
        doc.text(`Case Reference: ${currentLetterReport?.id || ''}`, 105, 270, { align: 'center' });

        // Save the PDF
        doc.save(`${letterTitle.replace(/\s+/g, '_')}_${caseNumber}_${currentLetterReport?.barangay || ''}.pdf`);
        
        console.log(`Letter generated for case ${caseNumber}`);
    }

    // Close letter modal
    function closeLetterModal() {
        document.getElementById('letterModal').style.display = 'none';
        currentLetterReport = null;
        isEditMode = false;
        
        // Reset form
        document.getElementById('edit-mode').checked = false;
        document.getElementById('letter-editor').style.display = 'none';
        document.getElementById('preview-btn').style.display = 'none';
        document.getElementById('edit-toggle-btn').innerHTML = '<i class="fas fa-edit"></i> Edit Letter';
        document.getElementById('letter-preview').classList.remove('editable');
    }

    // Helper function for ordinal suffixes
    function getOrdinalSuffix(day) {
        if (day > 3 && day < 21) return 'th';
        switch (day % 10) {
            case 1: return "st";
            case 2: return "nd";
            case 3: return "rd";
            default: return "th";
        }
    }

    // Toggle sidebar on mobile
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('active');
    }

    // Function to fetch reports from Firebase
    function fetchReports() {
        const reportsRef = database.ref('Submitted');
        const loadingElement = document.querySelector("#reportTable tbody");
        const cardsContainer = document.getElementById('reports-cards-container');
        
        loadingElement.innerHTML = `
        <tr>
            <td colspan="12" class="loading">
            <i class="fas fa-spinner fa-spin"></i> Loading reports...
            </td>
        </tr>
        `;
        
        cardsContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading reports...</div>';
        
        reportsRef.on('value', (snapshot) => {
        reports = [];
        const barangays = new Set();
        const categories = new Set();
        const incidentTypes = new Set();
        const blotterTypes = new Set();
        
        snapshot.forEach((childSnapshot) => {
            const reportData = childSnapshot.val();
            const reportKey = childSnapshot.key;
            
            // Add to sets for filters
            if (reportData.barangay) barangays.add(reportData.barangay);
            if (reportData.category) categories.add(reportData.category);
            if (reportData.incidentType) incidentTypes.add(reportData.incidentType);
            if (reportData.blotterType) blotterTypes.add(reportData.blotterType);
            
            // Calculate media count
            let mediaCount = 0;
            if (reportData.category === "Blotter") {
                mediaCount = (reportData.imageUrls ? reportData.imageUrls.length : 0) + 
                            (reportData.videoUrls ? reportData.videoUrls.length : 0);
            } else {
                mediaCount = reportData.mediaUrls ? reportData.mediaUrls.length : 0;
            }
            
            // Format the data for our table
            reports.push({
            id: reportKey,
            caseNumber: reportData.caseNumber || reportKey.substring(0, 8),
            barangay: reportData.barangay || 'N/A',
            dateSubmitted: reportData.dateSubmitted || 'N/A',
            reporter: reportData.reporter || 'N/A',
            email: reportData.email || 'N/A',
            category: reportData.category || 'N/A',
            incidentType: reportData.incidentType || 'N/A',
            blotterType: reportData.blotterType || 'N/A',
            description: reportData.description || 'No description provided',
            incidentTime: reportData.incidentTime || 'N/A',
            specificLocation: reportData.specificLocation || 'N/A',
            isUrgent: reportData.isUrgent || false,
            status: reportData.status || 'Unresolved',
            schedule: reportData.schedule || 'N/A',
            feedback: reportData.feedback || 'N/A',
            submittedAt: reportData.submittedAt || 'N/A',
            submittedBy: reportData.submittedBy || {},
            originalReportId: reportData.originalReportId || 'N/A',
            mediaCount: mediaCount,
            fullData: reportData
            });
        });
        
        // Update filter dropdowns
        updateFilterDropdown('barangay-filter', barangays);
        updateFilterDropdown('category-filter', categories);
        updateFilterDropdown('incidentType-filter', incidentTypes);
        updateFilterDropdown('blotterType-filter', blotterTypes);
        
        // Apply filters and render
        filterReports();
        
        // Update report count
        document.getElementById('report-count').textContent = `${reports.length} reports found`;
        
        // Set up message listeners for each report
        setupMessageListeners();
        }, (error) => {
        console.error('Error fetching reports:', error);
        document.querySelector("#reportTable tbody").innerHTML = `
            <tr>
            <td colspan="12" class="loading">
                <i class="fas fa-exclamation-triangle"></i> Error loading reports. Please try again.
            </td>
            </tr>
        `;
        document.getElementById('reports-cards-container').innerHTML = `
            <div class="loading">
                <i class="fas fa-exclamation-triangle"></i> Error loading reports. Please try again.
            </div>
        `;
        });
    }

    // Set up listeners for messages for each report
    function setupMessageListeners() {
        // Clear existing listeners
        Object.values(messageListeners).forEach(off => off());
        messageListeners = {};
        unreadMessages = {};
        
        // Set up listeners for each report
        reports.forEach(report => {
            const reportId = report.id;
            unreadMessages[reportId] = 0;
            
            // Listen for new messages
            const messagesRef = database.ref(`ReportChats`).orderByChild('reportId').equalTo(reportId);
            
            const listener = messagesRef.on('child_added', (snapshot) => {
                const messageData = snapshot.val();
                
                // Check if message is not from Main Admin and hasn't been read
                if (messageData.senderName !== "Main Admin" && !messageData.read) {
                    unreadMessages[reportId] = (unreadMessages[reportId] || 0) + 1;
                    updateMessageBadge(reportId);
                }
            });
            
            messageListeners[reportId] = () => {
                messagesRef.off('child_added', listener);
            };
        });
    }

    // Update the message badge for a specific report
    function updateMessageBadge(reportId) {
        const badgeCount = unreadMessages[reportId] || 0;
        
        // Find the message button for this report
        const messageButtons = document.querySelectorAll(`button[onclick="openMessageModal('${reportId}')"]`);
        
        messageButtons.forEach(button => {
            // Remove existing badge if any
            const existingBadge = button.querySelector('.message-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // Add badge if there are unread messages
            if (badgeCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'message-badge';
                badge.textContent = badgeCount > 9 ? '9+' : badgeCount;
                button.appendChild(badge);
            }
        });
    }

    // Update filter dropdown with options
    function updateFilterDropdown(selectId, valuesSet) {
        const select = document.getElementById(selectId);
        // Clear existing options except the first one
        while (select.options.length > 1) {
        select.remove(1);
        }
        
        // Add new options
        const values = Array.from(valuesSet).sort();
        values.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
        });
    }

    // Filter reports based on selected filters
    function filterReports() {
        const monthFilter = document.getElementById('month-filter').value;
        const statusFilter = document.getElementById('status-filter').value;
        const barangayFilter = document.getElementById('barangay-filter').value;
        const categoryFilter = document.getElementById('category-filter').value;
        const incidentTypeFilter = document.getElementById('incidentType-filter').value;
        const blotterTypeFilter = document.getElementById('blotterType-filter').value;
        const searchText = document.getElementById('search-input').value.toLowerCase();
        
        filteredReports = reports.filter(report => {
        // Month filter
        if (monthFilter !== 'all') {
            const dateParts = report.dateSubmitted.split('/');
            if (dateParts.length >= 1) {
                const month = dateParts[0].padStart(2, '0');
                if (month !== monthFilter) {
                    return false;
                }
            } else {
                return false;
            }
        }
        
        // Status filter
        if (statusFilter !== 'all' && report.status !== statusFilter) {
            return false;
        }
        
        // Barangay filter
        if (barangayFilter !== 'all' && report.barangay !== barangayFilter) {
            return false;
        }
        
        // Category filter
        if (categoryFilter !== 'all' && report.category !== categoryFilter) {
            return false;
        }
        
        // Incident Type filter
        if (incidentTypeFilter !== 'all' && report.incidentType !== incidentTypeFilter) {
            return false;
        }
        
        // Blotter Type filter
        if (blotterTypeFilter !== 'all' && report.blotterType !== blotterTypeFilter) {
            return false;
        }
        
        // Search text
        if (searchText) {
            const searchableText = [
            report.caseNumber,
            report.barangay,
            report.reporter,
            report.category,
            report.incidentType,
            report.blotterType,
            report.description,
            report.status
            ].join(' ').toLowerCase();
            
            if (!searchableText.includes(searchText)) {
            return false;
            }
        }
        
        return true;
        });
        
        renderReports();
    }

    function renderReports() {
        const tbody = document.querySelector("#reportTable tbody");
        const cardsContainer = document.getElementById('reports-cards-container');
        
        if (filteredReports.length === 0) {
        tbody.innerHTML = `
            <tr>
            <td colspan="12" class="loading">No reports match your filters.</td>
            </tr>
        `;
        cardsContainer.innerHTML = '<div class="loading">No reports match your filters.</div>';
        return;
        }
        
        tbody.innerHTML = '';
        cardsContainer.innerHTML = '';
        
        filteredReports.forEach((report) => {
        const statusClass = 
            report.status === 'Resolved' ? 'status-resolved' : 
            report.status === 'Pending' ? 'status-pending' : 'status-unresolved';
            
        // Table row
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${report.caseNumber}</td>
            <td>${report.barangay}</td>
            <td>${report.dateSubmitted}</td>
            <td>${report.reporter}</td>
            <td>${report.category}</td>
            <td>${report.incidentType}</td>
            <td>${report.blotterType}</td>
            <td>${report.description.length > 50 ? report.description.substring(0, 50) + '...' : report.description}</td>
            <td><span class="${statusClass}">${report.status}</span></td>
            <td>${report.isUrgent ? '<span class="urgent-tag">URGENT</span>' : 'No'}</td>
            <td>
                <button class="media-btn" onclick="viewMedia('${report.id}', this)">
                  <i class="fas fa-folder"></i>
                  ${report.mediaCount > 0 ? 
                    `<span class="media-count-badge">${report.mediaCount}</span>` : ''}
                  View
                </button>
            </td>
            <td>
                <button class="message-btn" onclick="openMessageModal('${report.id}')">
                  <i class="fas fa-comment"></i>
                </button>
                <button class="letter-btn" onclick="openLetterEditor('${report.id}')">
                  <i class="fas fa-file-alt"></i> Letter
                </button>
                <button class="view-details" onclick="viewDetails('${report.id}')">
                <i class="fas fa-eye"></i> Details
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
        
        // Card view
        const card = document.createElement('div');
        card.className = 'report-card';
        card.innerHTML = `
          <div class="report-card-header">
            <div><strong>${report.caseNumber} - ${report.barangay}</strong></div>
            <div>${report.isUrgent ? '<span class="urgent-tag">URGENT</span>' : ''}</div>
          </div>
          <div class="report-card-body">
            <div class="report-card-field">
              <div class="label">Case Number</div>
              <div class="value">${report.caseNumber}</div>
            </div>
            <div class="report-card-field">
              <div class="label">Date Submitted</div>
              <div class="value">${report.dateSubmitted}</div>
            </div>
            <div class="report-card-field">
              <div class="label">Reporter</div>
              <div class="value">${report.reporter}</div>
            </div>
            <div class="report-card-field">
              <div class="label">Category</div>
              <div class="value">${report.category}</div>
            </div>
            <div class="report-card-field">
              <div class="label">Incident Type</div>
              <div class="value">${report.incidentType}</div>
            </div>
            <div class="report-card-field">
              <div class="label">Blotter Type</div>
              <div class="value">${report.blotterType}</div>
            </div>
            <div class="report-card-field" style="grid-column: 1 / -1;">
              <div class="label">Description</div>
              <div class="value">${report.description}</div>
            </div>
            <div class="report-card-field">
              <div class="label">Status</div>
              <div class="value"><span class="${statusClass}">${report.status}</span></div>
            </div>
            <div class="report-card-field">
              <div class="label">Media Files</div>
              <div class="value">${report.mediaCount} file(s)</div>
            </div>
          </div>
          <div class="report-card-actions">
            <button class="media-btn" onclick="viewMedia('${report.id}', this)">
              <i class="fas fa-folder"></i> 
              ${report.mediaCount > 0 ? 
                `<span class="media-count-badge">${report.mediaCount}</span>` : ''}
              Media
            </button>
            <button class="message-btn" onclick="openMessageModal('${report.id}')">
              <i class="fas fa-comment"></i> Message
            </button>
            <button class="letter-btn" onclick="openLetterEditor('${report.id}')">
              <i class="fas fa-file-alt"></i> Letter
            </button>
            <button class="view-details" onclick="viewDetails('${report.id}')">
              <i class="fas fa-eye"></i> Details
            </button>
          </div>
        `;
        
        cardsContainer.appendChild(card);
        
        // Update message badge after rendering
        updateMessageBadge(report.id);
        });
    }

    // View media files
    function viewMedia(reportId, button) {
      db.ref("Submitted/" + reportId).once("value")
        .then((snapshot) => {
          if (snapshot.exists()) {
            const report = snapshot.val();
            currentReportData = report;
            
            let imageUrls = [];
            let videoUrls = [];
            
            if (report.category === "Blotter") {
              imageUrls = report.imageUrls || [];
              videoUrls = report.videoUrls || [];
            } else {
              const allMedia = report.mediaUrls || [];
              
              allMedia.forEach(mediaItem => {
                if (typeof mediaItem === 'string') {
                  if (isVideoUrl(mediaItem)) {
                    videoUrls.push(mediaItem);
                  } else {
                    imageUrls.push(mediaItem);
                  }
                } else if (mediaItem && mediaItem.url) {
                  if (mediaItem.type === 'video' || isVideoUrl(mediaItem.url)) {
                    videoUrls.push(mediaItem.url);
                  } else {
                    imageUrls.push(mediaItem.url);
                  }
                }
              });
            }
            
            const imagesContainer = document.getElementById('imagesContainer');
            const videosContainer = document.getElementById('videosContainer');
            imagesContainer.innerHTML = '';
            videosContainer.innerHTML = '';
            
            document.getElementById('mediaCaseNumber').textContent = report.caseNumber || 'N/A';
            document.getElementById('mediaReportType').textContent = 
              `${report.category || ''} - ${report.blotterType || ''} - ${report.incidentType || ''}`;
            
            const mediaTabs = document.getElementById('mediaTabs');
            mediaTabs.innerHTML = '';
            
            const imagesTab = document.createElement('button');
            imagesTab.className = 'media-tab active';
            imagesTab.innerHTML = `
              <i class="fas fa-image"></i> Images
              ${imageUrls.length > 0 ? `<span class="media-tab-badge">${imageUrls.length}</span>` : ''}
            `;
            imagesTab.onclick = () => {
              document.querySelectorAll('.media-tab').forEach(tab => tab.classList.remove('active'));
              imagesTab.classList.add('active');
              imagesContainer.style.display = 'grid';
              videosContainer.style.display = 'none';
            };
            mediaTabs.appendChild(imagesTab);
            
            const videosTab = document.createElement('button');
            videosTab.className = 'media-tab';
            videosTab.innerHTML = `
              <i class="fas fa-video"></i> Videos
              ${videoUrls.length > 0 ? `<span class="media-tab-badge">${videoUrls.length}</span>` : ''}
            `;
            videosTab.onclick = () => {
              document.querySelectorAll('.media-tab').forEach(tab => tab.classList.remove('active'));
              videosTab.classList.add('active');
              imagesContainer.style.display = 'none';
              videosContainer.style.display = 'grid';
            };
            mediaTabs.appendChild(videosTab);
            
            if (imageUrls.length === 0) {
              imagesContainer.innerHTML = `
                <div class="media-empty">
                  <i class="fas fa-image"></i>
                  <p>No images attached to this report</p>
                </div>
              `;
            } else {
              imageUrls.forEach((imageUrl, index) => {
                const mediaItem = document.createElement('div');
                mediaItem.className = 'media-item';
                
                mediaItem.innerHTML = `
                  <div style="position: relative;">
                    <img src="${imageUrl}" alt="Report Image ${index + 1}" 
                         class="media-image" onclick="viewFullImage('${imageUrl}')">
                    <span class="media-type-badge">Image ${index + 1}</span>
                  </div>
                  <div style="padding: 10px; text-align: center;">
                    <small>Image ${index + 1}</small>
                  </div>
                `;
                
                imagesContainer.appendChild(mediaItem);
              });
            }
            
            if (videoUrls.length === 0) {
              videosContainer.innerHTML = `
                <div class="media-empty">
                  <i class="fas fa-video"></i>
                  <p>No videos attached to this report</p>
                </div>
              `;
            } else {
              videoUrls.forEach((videoUrl, index) => {
                const mediaItem = document.createElement('div');
                mediaItem.className = 'media-item';
                
                mediaItem.innerHTML = `
                  <div style="position: relative;">
                    <video controls class="media-video">
                      <source src="${videoUrl}" type="video/mp4">
                      Your browser does not support the video tag.
                    </video>
                    <span class="media-type-badge">Video ${index + 1}</span>
                  </div>
                  <div style="padding: 10px; text-align: center;">
                    <small>Video ${index + 1}</small>
                  </div>
                `;
                
                videosContainer.appendChild(mediaItem);
              });
            }
            
            openMediaModal();
            
          } else {
            alert("Report not found in Submitted records!");
          }
        })
        .catch((error) => {
          console.error("Error loading media:", error);
          alert("Error loading media files. Please try again.");
        });
    }

    function openMediaModal() {
      document.getElementById('mediaModal').style.display = 'flex';
    }

    function closeMediaModal() {
      document.getElementById('mediaModal').style.display = 'none';
    }

    function viewFullImage(imageUrl) {
      const modal = document.getElementById('fullImageModal');
      const img = document.getElementById('fullImageView');
      img.src = imageUrl;
      modal.style.display = 'flex';
    }

    function closeFullImage() {
      document.getElementById('fullImageModal').style.display = 'none';
    }

    // View detailed report
    function viewDetails(reportId) {
        const report = reports.find(r => r.id === reportId);
        if (!report) return;
        
        const modalBody = document.getElementById('modal-body-content');
        const urgentClass = report.isUrgent ? ' urgent' : '';
        
        modalBody.innerHTML = `
        <div class="detail-grid">
            <div class="detail-card${urgentClass}">
                <div class="detail-label">Case Number</div>
                <div class="detail-value">${report.caseNumber}</div>
            </div>
            
            <div class="detail-card${urgentClass}">
                <div class="detail-label">Report ID</div>
                <div class="detail-value">${report.id}</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Barangay</div>
                <div class="detail-value">${report.barangay}</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Date Submitted</div>
                <div class="detail-value">${report.dateSubmitted}</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Reporter Name</div>
                <div class="detail-value">${report.reporter}</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Reporter Email</div>
                <div class="detail-value">${report.email}</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Category</div>
                <div class="detail-value">${report.category}</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Incident Type</div>
                <div class="detail-value">${report.incidentType}</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Blotter Type</div>
                <div class="detail-value">${report.blotterType}</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Incident Time</div>
                <div class="detail-value">${report.incidentTime}</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Specific Location</div>
                <div class="detail-value">${report.specificLocation}</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Status</div>
                <div class="detail-value">${report.status}</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Urgent</div>
                <div class="detail-value">${report.isUrgent ? 'Yes' : 'No'}</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Scheduled Response</div>
                <div class="detail-value">${report.schedule}</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Submitted At</div>
                <div class="detail-value">${report.submittedAt}</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Submitted By</div>
                <div class="detail-value">${report.submittedBy.firstName || 'N/A'} ${report.submittedBy.lastName || ''} (${report.submittedBy.position || 'N/A'})</div>
            </div>
            
            <div class="description-card">
                <div class="detail-label">Description</div>
                <div class="detail-value">${report.description}</div>
            </div>
            
            <div class="description-card">
                <div class="detail-label">Admin Feedback</div>
                <div class="detail-value">${report.feedback}</div>
            </div>
            
            <div class="description-card">
                <div class="detail-label">Media Files</div>
                <div class="detail-value">${report.mediaCount} file(s) attached</div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="close-btn" onclick="closeModal()">Close</button>
        </div>
        `;
        
        document.getElementById('detailsModal').style.display = 'flex';
    }

    // Close modal
    function closeModal() {
        document.getElementById('detailsModal').style.display = 'none';
    }

    // Open message modal
    function openMessageModal(reportId) {
        currentReportId = reportId;
        document.getElementById('message-report-id').textContent = reportId;
        document.getElementById('messageModal').style.display = 'flex';
        
        loadMessages(reportId);
        
        unreadMessages[reportId] = 0;
        updateMessageBadge(reportId);
        
        markMessagesAsRead(reportId);
    }

    // Mark all messages in a report as read
    function markMessagesAsRead(reportId) {
        const messagesRef = database.ref(`ReportChats`).orderByChild('reportId').equalTo(reportId);
        messagesRef.once('value', (snapshot) => {
            if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                    const messageData = childSnapshot.val();
                    if (messageData.senderName !== "Main Admin" && !messageData.read) {
                        childSnapshot.ref.update({ read: true });
                    }
                });
            }
        });
    }

    // Close message modal
    function closeMessageModal() {
        document.getElementById('messageModal').style.display = 'none';
        currentReportId = null;
    }

    // Load messages for a specific report
    function loadMessages(reportId) {
        const messagesRef = database.ref(`ReportChats`).orderByChild('reportId').equalTo(reportId);
        const messageContainer = document.getElementById('message-container');
        
        messageContainer.innerHTML = '<div class="loading">Loading messages...</div>';
        
        messagesRef.on('value', (snapshot) => {
            messageContainer.innerHTML = '';
            
            if (!snapshot.exists()) {
                messageContainer.innerHTML = '<div class="loading">No messages yet. Start the conversation!</div>';
                return;
            }
            
            const messages = [];
            snapshot.forEach((childSnapshot) => {
                const messageData = childSnapshot.val();
                messages.push({
                    id: childSnapshot.key,
                    ...messageData
                });
            });
            
            messages.sort((a, b) => a.timestamp - b.timestamp);
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                const isMainAdmin = message.senderName === "Main Admin";
                
                messageDiv.className = `message ${isMainAdmin ? 'admin' : 'other'}`;
                
                const senderName = message.senderName || 'Unknown Sender';
                
                messageDiv.innerHTML = `
                    <div class="message-sender">${senderName}</div>
                    <div>${message.text}</div>
                    <div class="message-time">${formatTimestamp(message.timestamp)}</div>
                `;
                
                messageContainer.appendChild(messageDiv);
            });
            
            messageContainer.scrollTop = messageContainer.scrollHeight;
        });
    }

    // Format timestamp to readable format
    function formatTimestamp(timestamp) {
        if (!timestamp) return '';
        
        const date = new Date(timestamp);
        return date.toLocaleString();
    }

    // Send a new message
    function sendMessage() {
        if (!currentReportId) return;
        
        const messageInput = document.getElementById('message-input');
        const messageText = messageInput.value.trim();
        
        if (!messageText) return;
        
        const adminName = "Main Admin";
        const adminId = "admin-user-id";
        
        const message = {
            text: messageText,
            senderId: adminId,
            senderName: adminName,
            senderType: 'admin',
            timestamp: Date.now(),
            reportId: currentReportId,
            read: true
        };
        
        const messagesRef = database.ref('ReportChats');
        messagesRef.push(message)
            .then(() => {
                messageInput.value = '';
            })
            .catch((error) => {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            });
    }

    // Export reports to PDF
    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.text("Barangay Reports", 14, 15);
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text(`Generated on ${new Date().toLocaleDateString()}`, 14, 22);
        
        doc.autoTable({
        head: [['Case #', 'Barangay', 'Date', 'Reporter', 'Category', 'Incident Type', 'Blotter Type', 'Status', 'Urgent']],
        body: filteredReports.map(r => [
            r.caseNumber,
            r.barangay, 
            r.dateSubmitted, 
            r.reporter,
            r.category,
            r.incidentType,
            r.blotterType,
            r.status,
            r.isUrgent ? 'Yes' : 'No'
        ]),
        startY: 30,
        theme: 'grid',
        headStyles: {
            fillColor: [37, 99, 235],
            textColor: 255
        },
        alternateRowStyles: {
            fillColor: [243, 244, 246]
        }
        });

        doc.save("barangay_reports.pdf");
    }

    // Logout function
    function logout() {
        window.location.href = "index.html";
    }

    // Initialize the page
    window.onload = function() {
        fetchReports();
        
        // Add event listeners to filters
        document.getElementById('month-filter').addEventListener('change', filterReports);
        document.getElementById('status-filter').addEventListener('change', filterReports);
        document.getElementById('barangay-filter').addEventListener('change', filterReports);
        document.getElementById('category-filter').addEventListener('change', filterReports);
        document.getElementById('incidentType-filter').addEventListener('change', filterReports);
        document.getElementById('blotterType-filter').addEventListener('change', filterReports);
        document.getElementById('search-input').addEventListener('input', filterReports);
        
        // Close modal when clicking on X
        document.querySelector('.close').addEventListener('click', closeModal);
        document.querySelector('.message-close').addEventListener('click', closeMessageModal);
        document.querySelector('.media-close').addEventListener('click', closeMediaModal);
        document.querySelector('.letter-close').addEventListener('click', closeLetterModal);
        document.querySelector('.full-image-close').addEventListener('click', closeFullImage);
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
        if (event.target === document.getElementById('detailsModal')) {
            closeModal();
        }
        if (event.target === document.getElementById('messageModal')) {
            closeMessageModal();
        }
        if (event.target === document.getElementById('mediaModal')) {
            closeMediaModal();
        }
        if (event.target === document.getElementById('letterModal')) {
            closeLetterModal();
        }
        if (event.target === document.getElementById('fullImageModal')) {
            closeFullImage();
        }
        });
        
        // Send message on Enter key
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
          const sidebar = document.getElementById('sidebar');
          const sidebarToggle = document.querySelector('.sidebar-toggle');
          
          if (window.innerWidth <= 768 && 
              sidebar.classList.contains('active') && 
              !sidebar.contains(event.target) && 
              !sidebarToggle.contains(event.target)) {
            sidebar.classList.remove('active');
          }
        });
        
        // Close full image modal with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeFullImage();
            }
        });
    };
</script>
</body>
</html>