<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reports Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <style>
    * {margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif;}
    
    /* Prevent scrolling on the entire page */
    html, body {
      height: 100%;
      overflow: hidden;
      background-color: #f8fafc;
    }
    
    body {
      display: flex; 
      min-height: 100vh; 
      background-color: #f8fafc;
    }

    /* Sidebar */
    .sidebar {
      width: 250px; 
      background-color: #1e293b; 
      color: white; 
      flex-shrink: 0; 
      display: flex; 
      flex-direction: column; 
      box-shadow: 2px 0 8px rgba(0,0,0,0.15);
      transition: transform 0.3s ease;
      z-index: 1000;
    }
    .sidebar h2 {
      text-align: center; 
      padding: 20px; 
      border-bottom: 1px solid #334155; 
      font-weight: 600;
      font-size: 18px;
    }
    .sidebar a {
      padding: 14px 20px; 
      color: #cbd5e1; 
      text-decoration: none; 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      font-size: 14px; 
      transition: all 0.2s ease-in-out; 
      cursor: pointer;
      font-weight: 500;
    }
    .sidebar a:hover {
      background-color: #334155; 
      padding-left: 25px;
      color: white;
    }
    .sidebar a.active {
      background-color: #374151;
      color: white;
    }
    .logout-btn {
      margin-top: auto; 
      background-color: #dc2626; 
      color: white; 
      text-align: center; 
      padding: 14px 20px; 
      text-decoration: none; 
      font-size: 14px; 
      transition: 0.2s; 
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .logout-btn:hover {
      background-color: #b91c1c;
    }

    /* Main */
    .main {
      flex: 1; 
      display: flex; 
      flex-direction: column;
      overflow: hidden;
      width: 100%;
    }

    /* Topbar */
    .topbar {
      background-color: white; 
      padding: 16px 28px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
      font-size: 18px; 
      font-weight: 600; 
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      border-bottom: 1px solid #e2e8f0;
      position: relative;
    }
    .topbar span {
      color: #1e293b; 
      letter-spacing: 0.5px;
    }

    /* Hamburger menu for mobile */
    .hamburger {
      display: none;
      background: none;
      border: none;
      font-size: 24px;
      color: #1e293b;
      cursor: pointer;
      padding: 5px;
    }

    /* Admin info display */
    .admin-info {
      background-color: #eff6ff;
      color: #1e40af;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid #dbeafe;
    }

    /* Content */
    .content {
      padding: 0 28px 28px 28px;
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    /* Header container for buttons and search */
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    /* Button Container */
    .button-container {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    /* Type Buttons */
    .type-btn {
      background: white;
      color: #4f46e5;
      padding: 10px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      transition: all 0.2s ease-in-out;
      white-space: nowrap;
    }
    .type-btn:hover {
      background: #4f46e5;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
    }
    
    /* Filter container */
    .filter-container {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* Search Box */
    .search-box {
      position: relative; 
      width: 280px;
      min-width: 200px;
    }
    .search-box input {
      width: 100%; 
      padding: 10px 40px 10px 16px; 
      font-size: 14px;
      border: 1px solid #d1d5db; 
      border-radius: 8px; 
      outline: none;
      background-color: white; 
      transition: all 0.3s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .search-box input:focus {
      border-color: #4f46e5; 
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }
    .search-box i {
      position: absolute; 
      right: 14px; 
      top: 50%;
      transform: translateY(-50%); 
      color: #6b7280;
      font-size: 15px; 
      pointer-events: none;
    }

    /* Filter dropdowns */
    .filter-dropdown {
      padding: 10px 16px;
      font-size: 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      outline: none;
      background-color: white;
      color: #374151;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      min-width: 140px;
    }

    .filter-dropdown:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }

    /* Table wrapper - horizontal and vertical scroll inside only */
    .table-container {
      width: 100%;
      flex: 1;
      overflow: auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      border: 1px solid #e2e8f0;
    }

    /* Export Button Container - positioned at bottom right after the table */
    .export-container {
      display: flex;
      justify-content: flex-end;
    }

    /* Export Button */
    .export-btn {
      background: #4f46e5;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s ease-in-out;
    }
    .export-btn:hover {
      background: #4338ca; 
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* Table */
    .report-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 1800px; /* Adjusted for new column */
    }

    .report-table th, .report-table td {
      padding: 14px 16px;
      text-align: left;
      font-size: 14px;
      line-height: 1.5;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: top;
    }

    /* Table Head */
    .report-table thead th {
      background-color: #f8fafc;
      color: #374151;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 2;
      border-bottom: 2px solid #e2e8f0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Column Width Adjustments */
    .report-table th:nth-child(1), .report-table td:nth-child(1) { width: 80px; } /* Case# */
    .report-table th:nth-child(2), .report-table td:nth-child(2) { width: 100px; } /* Category */
    .report-table th:nth-child(3), .report-table td:nth-child(3) { width: 120px; } /* Blotter Type */
    .report-table th:nth-child(4), .report-table td:nth-child(4) { width: 120px; } /* Incident Type */
    .report-table th:nth-child(5), .report-table td:nth-child(5) { width: 120px; } /* Barangay */
    .report-table th:nth-child(6), .report-table td:nth-child(6) { width: 120px; } /* Reporter */
    .report-table th:nth-child(7), .report-table td:nth-child(7) { width: 150px; } /* Email */
    .report-table th:nth-child(8), .report-table td:nth-child(8) { 
      width: 350px; /* Increased width for Description column */
      min-width: 350px;
      max-width: 350px;
    }
    .report-table th:nth-child(9), .report-table td:nth-child(9) { width: 120px; } /* Date Submitted */
    .report-table th:nth-child(10), .report-table td:nth-child(10) { width: 120px; } /* Incident Time */
    .report-table th:nth-child(11), .report-table td:nth-child(11) { width: 150px; } /* Specific Location */
    .report-table th:nth-child(12), .report-table td:nth-child(12) { width: 120px; } /* Accused */
    .report-table th:nth-child(13), .report-table td:nth-child(13) { width: 80px; } /* Urgent? */
    .report-table th:nth-child(14), .report-table td:nth-child(14) { width: 130px; } /* Status */
    .report-table th:nth-child(15), .report-table td:nth-child(15) { width: 180px; } /* Schedule */
    .report-table th:nth-child(16), .report-table td:nth-child(16) { width: 250px; min-width: 250px;
      max-width: 250px;} /* Admin Feedback */
    .report-table th:nth-child(17), .report-table td:nth-child(17) { 
      width: 100px; /* Picture/Videos column */
      text-align: center;
    } 
    .report-table th:nth-child(18), .report-table td:nth-child(18) { width: 150px; } /* Actions */

    /* Zebra striping for readability */
    .report-table tbody tr:nth-child(even) {
      background-color: #f8fafc;
    }

    /* Row hover */
    .report-table tbody tr:hover {
      background-color: #f1f5f9;
    }
    
    /* Form controls inside table */
    select, input[type="datetime-local"], textarea, input[type="text"] {
      width: 100%; 
      font-size: 14px; 
      padding: 8px 10px; 
      margin-top: 5px;
      border: 1px solid #d1d5db; 
      border-radius: 6px; 
      resize: none;
      transition: border 0.2s, box-shadow 0.2s;
      background: white;
    }
    select:focus, input[type="datetime-local"]:focus, textarea:focus, input[type="text"]:focus {
      border-color: #4f46e5; 
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      outline: none;
    }
    textarea {
      min-height: 60px;
      line-height: 1.4;
      resize: vertical;
      width: 100%;
      font-family: 'Inter', sans-serif;
    }

    select {
      width: 130px;
    }

    /* Style for datetime-local input */
    input[type="datetime-local"] {
      width: 100%; 
      font-size: 14px; 
      padding: 8px 10px; 
      margin-top: 5px;
      border: 1px solid #d1d5db; 
      border-radius: 6px; 
      transition: border 0.2s, box-shadow 0.2s;
      background: white;
    }
    
    input[type="datetime-local"]:focus {
      border-color: #4f46e5; 
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      outline: none;
    }

    /* Buttons inside table */
    .urgent-btn, .submit-btn, .letter-btn {
      margin-top: 6px; 
      padding: 8px 14px; 
      border: none; 
      border-radius: 6px;
      cursor: pointer; 
      font-size: 13px; 
      font-weight: 500;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
      transition: 0.2s;
      display: inline-block;
      width: 100%;
      text-align: center;
    }
    .urgent-btn {
      background-color: #dc2626; 
      color: white;
    }
    .urgent-btn:hover {
      background-color: #b91c1c; 
      transform: translateY(-1px);
    }
    .submit-btn {
      background-color: #16a34a; 
      color: white;
    }
    .submit-btn:hover {
      background-color: #15803d; 
      transform: translateY(-1px);
    }
    .letter-btn {
      background-color: #7e22ce;
      color: white;
      margin-top: 8px;
    }
    .letter-btn:hover {
      background-color: #6b21a8;
      transform: translateY(-1px);
    }

    /* Media folder icon button */
    .media-btn {
      background: #3b82f6;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease-in-out;
      width: 100%;
      justify-content: center;
      margin-top: 5px;
      position: relative;
    }

    .media-btn:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
    }

    .media-btn i {
      font-size: 16px;
    }

    .media-count-badge {
      background: #ef4444;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      position: absolute;
      top: -8px;
      right: -8px;
    }

    /* Status badges */
    .status-badge {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      display: inline-block;
    }
    
    .status-pending {
      background-color: #fef3c7;
      color: #d97706;
    }
    
    .status-in-progress {
      background-color: #dbeafe;
      color: #1d4ed8;
    }
    
    .status-resolved {
      background-color: #dcfce7;
      color: #16a34a;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 40px;
      color: #6b7280;
    }
    
    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      color: #d1d5db;
    }
    
    .empty-state p {
      font-size: 16px;
      margin-bottom: 8px;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal-content {
      background-color: white;
      padding: 28px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      position: relative;
    }
    
    .letter-modal-content {
      max-width: 800px;
      padding: 0;
    }
    
    .letter-content {
      padding: 40px;
      background: white;
    }
    
    .letter-header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #1e293b;
      padding-bottom: 20px;
    }
    
    .letter-header h2 {
      font-size: 24px;
      color: #1e293b;
      margin-bottom: 10px;
    }
    
    .letter-header p {
      font-size: 16px;
      color: #64748b;
    }
    
    .letter-body {
      margin-bottom: 30px;
    }
    
    .letter-date {
      text-align: right;
      margin-bottom: 20px;
      color: #64748b;
    }
    
    .letter-to {
      margin-bottom: 20px;
    }
    
    .letter-subject {
      font-weight: 600;
      margin-bottom: 20px;
      font-size: 18px;
      color: #1e293b;
    }
    
    .letter-message {
      line-height: 1.6;
      margin-bottom: 30px;
    }
    
    .letter-footer {
      margin-top: 50px;
    }
    
    .letter-signature {
      margin-top: 60px;
    }
    
    .letter-signature p {
      margin-bottom: 5px;
    }
    
    .letter-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 30px;
      padding: 20px;
      background: #f8fafc;
      border-top: 1px solid #e2e8f0;
    }
    
    .letter-btn-primary {
      background: #4f46e5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .letter-btn-primary:hover {
      background: #4338ca;
    }
    
    .letter-btn-secondary {
      background: #64748b;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .letter-btn-secondary:hover {
      background: #475569;
    }
    
    .close {
      position: absolute;
      top: 20px;
      right: 24px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: #6b7280;
      transition: color 0.2s;
    }
    
    .close:hover {
      color: #374151;
    }
    
    .modal-title {
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: 600;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Form Styles */
    .form-group {
      margin-bottom: 18px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
      font-size: 14px;
    }
    
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      border-color: #4f46e5;
      outline: none;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }
    
    .add-btn {
      background: #4f46e5;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      transition: all 0.2s;
    }
    
    .add-btn:hover {
      background: #4338ca;
      transform: translateY(-1px);
    }
    
    /* List Styles */
    .type-list {
      margin-top: 24px;
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      background: #f9fafb;
    }
    
    .type-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
      background: white;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    
    .type-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    
    .delete-btn {
      background-color: #ef4444;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: background 0.2s;
    }
    
    .delete-btn:hover {
      background-color: #dc2626;
    }

    /* Media viewer styles */
    .media-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      max-height: 500px;
      overflow-y: auto;
      padding: 10px;
    }

    .media-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      transition: transform 0.3s ease;
    }

    .media-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .media-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .media-image:hover {
      transform: scale(1.05);
    }

    .media-video {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #000;
    }

    .media-type-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    /* Media tabs */
    .media-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #e2e8f0;
    }

    .media-tab {
      padding: 10px 20px;
      background: none;
      border: none;
      font-size: 14px;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .media-tab:hover {
      color: #4f46e5;
    }

    .media-tab.active {
      color: #4f46e5;
    }

    .media-tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: #4f46e5;
    }

    .media-tab-badge {
      background: #ef4444;
      color: white;
      border-radius: 10px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 500;
      margin-left: 6px;
    }

    /* Empty media state */
    .media-empty {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
      grid-column: 1 / -1;
    }

    .media-empty i {
      font-size: 48px;
      margin-bottom: 15px;
      color: #d1d5db;
    }

    /* Full screen image viewer */
    .full-image-modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      align-items: center;
      justify-content: center;
    }

    .full-image-content {
      max-width: 90vw;
      max-height: 90vh;
      position: relative;
    }

    .full-image {
      max-width: 100%;
      max-height: 90vh;
      object-fit: contain;
    }

    .full-image-close {
      position: absolute;
      top: 15px;
      right: 15px;
      color: white;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
      background: rgba(0,0,0,0.5);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Status notification styles */
    .status-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 9999;
      animation: slideIn 0.3s ease;
      max-width: 350px;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .status-notification-success {
      border-left: 4px solid #10b981;
      color: #047857;
    }
    
    .status-notification-warning {
      border-left: 4px solid #f59e0b;
      color: #b45309;
    }
    
    .status-notification-error {
      border-left: 4px solid #ef4444;
      color: #b91c1c;
    }
    
    .status-notification i {
      font-size: 18px;
    }

    /* Overlay for mobile when sidebar is open */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .header-container {
        flex-direction: column;
        align-items: stretch;
      }
      
      .button-container {
        justify-content: center;
      }
      
      .filter-container {
        width: 100%;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      
      .search-box {
        width: 100%;
      }
    }

    @media (max-width: 992px) {
      .content {
        padding: 0 20px 20px 20px;
      }
      
      .topbar {
        padding: 16px 20px;
      }
      
      .report-table th, .report-table td {
        padding: 12px 10px;
        font-size: 13px;
      }
      
      .search-box {
        min-width: 180px;
      }
      
      .filter-dropdown {
        min-width: 120px;
      }
    }

    @media (max-width: 768px) {
      .hamburger {
        display: block;
      }
      
      .sidebar {
        position: fixed;
        height: 100%;
        transform: translateX(-100%);
        z-index: 1000;
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .sidebar-overlay.active {
        display: block;
      }
      
      .main {
        width: 100%;
      }
      
      .topbar span {
        font-size: 16px;
      }
      
      .admin-info {
        font-size: 12px;
        padding: 6px 12px;
      }
      
      .content {
        padding: 0 15px 15px 15px;
      }
      
      .header-container {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      
      .button-container, .filter-container {
        width: 100%;
        justify-content: center;
      }
      
      .search-box {
        width: 100%;
        min-width: 100%;
      }
      
      .filter-container {
        gap: 8px;
      }
      
      .filter-dropdown {
        min-width: calc(50% - 4px);
        flex-grow: 1;
      }
      
      .export-btn {
        width: 100%;
        justify-content: center;
      }
      
      .export-container {
        justify-content: center;
      }
      
      .modal-content {
        padding: 20px;
        width: 95%;
      }
      
      .letter-content {
        padding: 20px;
      }
      
      .letter-buttons {
        flex-direction: column;
      }
      
      .media-container {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
      
      .media-tabs {
        overflow-x: auto;
      }
      
      .media-tab {
        padding: 8px 12px;
        font-size: 13px;
        white-space: nowrap;
      }
      
      .status-notification {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
      }
    }

    @media (max-width: 576px) {
      .topbar {
        padding: 12px 15px;
        margin-bottom: 15px;
      }
      
      .content {
        padding: 0 10px 10px 10px;
      }
      
      .type-btn {
        padding: 8px 12px;
        font-size: 13px;
        flex-grow: 1;
        justify-content: center;
      }
      
      .filter-dropdown {
        min-width: 100%;
      }
      
      .modal-content {
        padding: 15px;
      }
      
      .letter-content {
        padding: 15px;
      }
      
      .letter-header h2 {
        font-size: 20px;
      }
      
      .letter-header p {
        font-size: 14px;
      }
      
      .letter-subject {
        font-size: 16px;
      }
      
      .letter-btn-primary, .letter-btn-secondary {
        width: 100%;
        justify-content: center;
      }
      
      .media-container {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .admin-info {
        display: none;
      }
      
      .report-table th, .report-table td {
        padding: 10px 8px;
        font-size: 12px;
      }
      
      .type-btn {
        font-size: 12px;
        padding: 6px 10px;
      }
      
      .filter-dropdown, .search-box input {
        padding: 8px 12px;
        font-size: 13px;
      }
      
      .urgent-btn, .submit-btn, .letter-btn, .media-btn {
        padding: 6px 10px;
        font-size: 12px;
      }
      
      .modal-title {
        font-size: 18px;
      }
      
      .form-group label {
        font-size: 13px;
      }
      
      .form-group input, .form-group textarea, .form-group select {
        padding: 8px 12px;
        font-size: 13px;
      }
      
      .add-btn {
        padding: 8px 14px;
        font-size: 13px;
      }
    }

    @media print {
      body * {
        visibility: hidden;
      }
      .letter-modal-content, .letter-modal-content * {
        visibility: visible;
      }
      .letter-modal-content {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 0;
        margin: 0;
        box-shadow: none;
      }
      .letter-buttons {
        display: none;
      }
    }

  </style>
</head>
<body>
  <!-- Sidebar Overlay for Mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <h2>Admin Panel</h2>
    <a href="SubAdmin.html"><i class="fas fa-home"></i> Dashboard</a>
    <a href="approve.html"><i class="fas fa-user-check"></i> Approve Accounts</a>
    <a href="reports.html" class="active"><i class="fas fa-file-alt"></i> Reports</a>
    <a href="ReportToAdmin.html" ><i class="fas fa-flag"></i> Submitted to Admin</a>
    <a href="index.html" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>
  
  <div class="main">
    <div class="topbar">
      <button class="hamburger" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
      <span>REPORTS MANAGEMENT</span>
      <div class="admin-info" id="adminInfo">
        <i class="fas fa-user-shield"></i>
        <span>Loading...</span>
      </div>
    </div>

    <div class="content">
      <!-- Header container for buttons and search -->
      <div class="header-container">
        <div class="button-container">
          <button class="type-btn" onclick="openModal('blotter')">
            <i class="fas fa-stamp"></i> Blotter Types
          </button>
          <button class="type-btn" onclick="openModal('incident')">
            <i class="fas fa-clipboard-list"></i> Incident Types
          </button>
        </div>
        
        <!-- Filter container with search and dropdowns -->
        <div class="filter-container">
          <!-- Search box -->
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search reports...">
            <i class="fas fa-search"></i>
          </div>
          
          <!-- Month filter dropdown -->
          <select class="filter-dropdown" id="monthFilter">
            <option value="">All Months</option>
            <option value="01">January</option>
            <option value="02">February</option>
            <option value="03">March</option>
            <option value="04">April</option>
            <option value="05">May</option>
            <option value="06">June</option>
            <option value="07">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
          
          <!-- Status filter dropdown -->
          <select class="filter-dropdown" id="statusFilter">
            <option value="">All Statuses</option>
            <option value="Pending">Pending</option>
            <option value="In Progress">In Progress</option>
            <option value="Resolved">Resolved</option>
          </select>
          
          <!-- Urgent filter dropdown -->
          <select class="filter-dropdown" id="urgentFilter">
            <option value="">All Reports</option>
            <option value="true">Urgent Only</option>
            <option value="false">Non-Urgent Only</option>
          </select>
        </div>
      </div>

      <div class="table-container">
        <table class="report-table" id="reportTable">
          <thead>
            <tr>
              <th>Case#</th>
              <th>Category</th>
              <th>Blotter Type</th>
              <th>Incident Type</th>
              <th>Barangay</th>
              <th>Reporter</th>
              <th>Email</th>
              <th>Description</th>
              <th>Date Submitted</th>
              <th>Incident Time</th>
              <th>Specific Location</th>
              <th>Accused</th>
              <th>Urgent?</th>
              <th>Status</th>
              <th>Schedule</th>
              <th>Admin Feedback</th>
              <th>Picture/Videos</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Export button positioned at bottom right after the table -->
      <div class="export-container">
        <button class="export-btn" onclick="exportPDF()">
          <i class="fas fa-file-pdf"></i> Export to PDF
        </button>
      </div>
    </div>
  </div>

  <!-- Blotter Type Modal -->
  <div id="blotterModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('blotter')">&times;</span>
      <h2 class="modal-title"><i class="fas fa-stamp"></i> Manage Blotter Types</h2>
      
      <div class="form-group">
        <label for="blotterName">Add New Blotter Type</label>
        <input type="text" id="blotterName" placeholder="Enter blotter type name">
      </div>
      
      <button class="add-btn" onclick="addType('blotter')">
        <i class="fas fa-plus"></i> Add Blotter Type
      </button>
      
      <div class="type-list" id="blotterList">
        <!-- Blotter types will be listed here -->
      </div>
    </div>
  </div>

  <!-- Incident Type Modal -->
  <div id="incidentModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('incident')">&times;</span>
      <h2 class="modal-title"><i class="fas fa-clipboard-list"></i> Manage Incident Types</h2>
      
      <div class="form-group">
        <label for="incidentName">Add New Incident Type</label>
        <input type="text" id="incidentName" placeholder="Enter incident type name">
      </div>
      
      <button class="add-btn" onclick="addType('incident')">
        <i class="fas fa-plus"></i> Add Incident Type
      </button>
      
      <div class="type-list" id="incidentList">
        <!-- Incident types will be listed here -->
      </div>
    </div>
  </div>

  <!-- Letter Editor Modal -->
  <div id="letterEditorModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <span class="close" onclick="closeModal('letterEditor')">&times;</span>
      <h2 class="modal-title"><i class="fas fa-edit"></i> Compose Letter</h2>
      
      <div class="form-group">
        <label for="letterDate">Date</label>
        <input type="date" id="letterDate" value="${new Date().toISOString().split('T')[0]}">
      </div>
      
      <div class="form-group">
        <label for="letterCaseNumber">Case Number</label>
        <input type="text" id="letterCaseNumber" placeholder="Enter case number">
      </div>
      
      <div class="form-group">
        <label for="letterComplainant">Complainant Details</label>
        <textarea id="letterComplainant" rows="3" placeholder="Name, Barangay, Contact Number"></textarea>
      </div>
      
      <div class="form-group">
        <label for="letterRespondent">Respondent Details</label>
        <textarea id="letterRespondent" rows="3" placeholder="Name, Barangay, Contact Number (if known)"></textarea>
      </div>
      
      <div class="form-group">
        <label for="complaintNature">Nature of Complaint</label>
        <input type="text" id="complaintNature" placeholder="e.g., harassment, misconduct, violation, etc.">
      </div>
      
      <div class="form-group">
        <label for="incidentDetails">Incident Details</label>
        <textarea id="incidentDetails" rows="4" placeholder="Brief description of what happened..."></textarea>
      </div>
      
      <div class="form-group">
        <label for="letterNarrative">Narrative (Auto-generated)</label>
        <textarea id="letterNarrative" rows="8" readonly></textarea>
      </div>
      
      <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
        <button class="letter-btn-secondary" onclick="closeModal('letterEditor')">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button class="letter-btn-primary" onclick="generateLetterFromForm()">
          <i class="fas fa-file-alt"></i> Generate Letter
        </button>
      </div>
    </div>
  </div>

  <!-- Letter Modal -->
  <div id="letterModal" class="modal">
    <div class="modal-content letter-modal-content">
      <span class="close" onclick="closeModal('letter')">&times;</span>
      <div class="letter-content" id="letterContent">
        <!-- Letter content will be generated here -->
      </div>
      <div class="letter-buttons">
        <button class="letter-btn-primary" onclick="printLetter()">
          <i class="fas fa-print"></i> Print Letter
        </button>
        <button class="letter-btn-secondary" onclick="downloadLetter()">
          <i class="fas fa-download"></i> Download as PDF
        </button>
      </div>
    </div>
  </div>

  <!-- Media Viewer Modal -->
  <div id="mediaModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <span class="close" onclick="closeModal('media')">&times;</span>
      <h2 class="modal-title"><i class="fas fa-images"></i> Report Media</h2>
      
      <div style="margin-bottom: 20px;">
        <p><strong>Case #:</strong> <span id="mediaCaseNumber"></span></p>
        <p><strong>Report Type:</strong> <span id="mediaReportType"></span></p>
      </div>
      
      <div class="media-tabs" id="mediaTabs">
        <!-- Tabs will be generated here -->
      </div>
      
      <div class="media-container" id="imagesContainer">
        <!-- Images will be loaded here -->
      </div>
      
      <div class="media-container" id="videosContainer" style="display: none;">
        <!-- Videos will be loaded here -->
      </div>
      
      <div style="text-align: center; margin-top: 20px; color: #6b7280; font-size: 14px;">
        <i class="fas fa-info-circle"></i> Click on an image to view full size
      </div>
    </div>
  </div>

  <!-- Full Screen Image Modal -->
  <div id="fullImageModal" class="full-image-modal">
    <div class="full-image-content">
      <span class="full-image-close" onclick="closeFullImage()">&times;</span>
      <img id="fullImageView" class="full-image" src="">
    </div>
  </div>

  <script>
    // ðŸ”¹ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCSUCbCVKEYZx_-dySDrAauf1OZ6GIUMgI",
      authDomain: "bpoms-15479.firebaseapp.com",
      databaseURL: "https://bpoms-15479-default-rtdb.firebaseio.com",
      projectId: "bpoms-15479",
      storageBucket: "bpoms-15479.appspot.com",
      messagingSenderId: "461076757426",
      appId: "1:461076757426:web:61adf7d3f1734cc05702ab"
    };

    // ðŸ”¹ Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // ðŸ”¹ Initialize EmailJS
    (function() {
      emailjs.init("CTRAIfHl_uk2KADOE");
    })();

    // Global variable to store admin's barangay
    let adminBarangay = '';
    let currentReportData = null;
    let allReports = []; // Store all reports for filtering

    // Helper function to check if a URL is a video
    function isVideoUrl(url) {
      if (!url) return false;
      
      const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov', '.avi', '.wmv', '.flv', '.mkv'];
      const urlLower = url.toLowerCase();
      
      // Check by file extension
      for (const ext of videoExtensions) {
        if (urlLower.includes(ext) || urlLower.endsWith(ext)) {
          return true;
        }
      }
      
      // Check by common video URL patterns
      const videoPatterns = [
        '/video/', '/videos/', 'video=true', 'type=video',
        'firebasestorage.googleapis.com/v0/b/.*/o/.*\.mp4'
      ];
      
      for (const pattern of videoPatterns) {
        const regex = new RegExp(pattern, 'i');
        if (regex.test(url)) {
          return true;
        }
      }
      
      return false;
    }

    // ðŸ”¹ Toggle sidebar for mobile
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // ðŸ”¹ Check if admin is logged in and get their barangay
    function checkAdminAuth() {
      auth.onAuthStateChanged((user) => {
        if (user) {
          // User is signed in, get admin details from BrgyAccounts
          db.ref('BrgyAccounts').orderByChild('email').equalTo(user.email).once('value')
            .then((snapshot) => {
              if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                  const adminData = childSnapshot.val();
                  adminBarangay = adminData.barangay || '';
                  
                  // Update admin info display
                  document.getElementById('adminInfo').innerHTML = `
                    <i class="fas fa-user-shield"></i>
                    <span>${adminData.firstName} - ${adminBarangay}</span>
                  `;
                  
                  // Now load reports filtered by barangay
                  loadReports();
                  
                  // Load types
                  loadTypes('blotter');
                  loadTypes('incident');
                });
              } else {
                alert('Admin account not found. Please log in again.');
                window.location.href = 'index.html';
              }
            })
            .catch((error) => {
              console.error('Error fetching admin data:', error);
              alert('Error loading admin information.');
            });
        } else {
          // No user is signed in, redirect to login
          window.location.href = 'index.html';
        }
      });
    }

    // ðŸ”¹ Fetch user details from Users node based on email
    function getUserDetails(userEmail) {
      return new Promise((resolve, reject) => {
        if (!userEmail) {
          resolve({ firstName: "", lastName: "" });
          return;
        }
        
        // Look for user with matching email in Users node
        db.ref('users').orderByChild('email').equalTo(userEmail).once('value')
          .then((snapshot) => {
            if (snapshot.exists()) {
              let userData = null;
              snapshot.forEach((childSnapshot) => {
                userData = childSnapshot.val();
              });
              resolve({
                firstName: userData.firstName || "",
                lastName: userData.lastName || ""
              });
            } else {
              // If not found in Users, try BrgyAccounts (for admin reports)
              db.ref('BrgyAccounts').orderByChild('email').equalTo(userEmail).once('value')
                .then((adminSnapshot) => {
                  if (adminSnapshot.exists()) {
                    let adminData = null;
                    adminSnapshot.forEach((childSnapshot) => {
                      adminData = childSnapshot.val();
                    });
                    resolve({
                      firstName: adminData.firstName || "",
                      lastName: adminData.lastName || ""
                    });
                  } else {
                    resolve({ firstName: "", lastName: "" });
                  }
                })
                .catch((error) => {
                  console.error('Error fetching admin details:', error);
                  resolve({ firstName: "", lastName: "" });
                });
            }
          })
          .catch((error) => {
            console.error('Error fetching user details:', error);
            resolve({ firstName: "", lastName: "" });
          });
      });
    }

    // ðŸ”¹ Format date to mm/dd/yy time format
    function formatDateToMMDDYYTime(dateString) {
      if (!dateString) return "";
      
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return "";
        
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const year = date.getFullYear().toString().slice(-2);
        const hours = date.getHours();
        const minutes = date.getMinutes().toString().padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const formattedHours = hours % 12 || 12;
        
        return `${month}/${day}/${year} ${formattedHours}:${minutes} ${ampm}`;
      } catch (error) {
        console.error("Error formatting date:", error);
        return "";
      }
    }

    // ðŸ”¹ Parse formatted date back to datetime-local input format
    function parseFormattedDate(formattedDate) {
      if (!formattedDate) return "";
      
      try {
        // Extract date and time parts from the formatted string
        const [datePart, timePart, ampm] = formattedDate.split(' ');
        if (!datePart || !timePart) return "";
        
        const [month, day, year] = datePart.split('/');
        const [hours, minutes] = timePart.split(':');
        
        // Convert to 24-hour format if needed
        let hourValue = parseInt(hours);
        if (ampm === 'PM' && hourValue < 12) hourValue += 12;
        if (ampm === 'AM' && hourValue === 12) hourValue = 0;
        
        // Create a full year from the 2-digit year
        const fullYear = 2000 + parseInt(year);
        
        // Format as YYYY-MM-DDTHH:MM for datetime-local input
        const formatted = `${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${hourValue.toString().padStart(2, '0')}:${minutes}`;
        return formatted;
      } catch (error) {
        console.error("Error parsing formatted date:", error);
        return "";
      }
    }

    // ðŸ”¹ Show notification
    function showNotification(message, type = 'success') {
      // Remove existing notification
      const existingNotification = document.querySelector('.status-notification');
      if (existingNotification) existingNotification.remove();
      
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `status-notification status-notification-${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
      `;
      
      // Add to document
      document.body.appendChild(notification);
      
      // Auto-remove after 3 seconds
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (notification.parentNode) notification.parentNode.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // ðŸ”¹ Send Email Notification using EmailJS (Updated with feedback and schedule)
    async function sendStatusEmail(userEmail, reportData, newStatus, feedback = '', schedule = '') {
      try {
        // Get admin info
        const currentUser = auth.currentUser;
        let adminData = null;
        
        if (currentUser) {
          const adminSnapshot = await db.ref('BrgyAccounts')
            .orderByChild('email')
            .equalTo(currentUser.email)
            .once('value');
          
          if (adminSnapshot.exists()) {
            adminSnapshot.forEach((childSnapshot) => {
              adminData = childSnapshot.val();
            });
          }
        }
        
        // Format schedule for email if it exists
        let formattedSchedule = 'Not scheduled yet';
        if (schedule) {
          // Parse the schedule string to a more readable format
          try {
            const [datePart, timePart, ampm] = schedule.split(' ');
            formattedSchedule = `${datePart} at ${timePart} ${ampm}`;
          } catch (e) {
            formattedSchedule = schedule; // Use as-is if parsing fails
          }
        }
        
        // Prepare email template parameters
        const templateParams = {
          to_email: userEmail,
          case_number: reportData.caseNumber || 'N/A',
          category: reportData.category || 'N/A',
          blotter_type: reportData.blotterType || 'N/A',
          incident_type: reportData.type || 'N/A',
          old_status: reportData.status || 'Pending',
          new_status: newStatus,
          barangay: reportData.barangay || 'N/A',
          admin_name: adminData ? `${adminData.firstName} ${adminData.lastName}` : 'Barangay Admin',
          admin_barangay: adminBarangay,
          date_updated: new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }),
          update_message: getStatusUpdateMessage(newStatus),
          feedback: feedback || 'No feedback provided.',
          schedule: formattedSchedule,
          specific_location: reportData.specificLocation || 'Not specified',
          accused_person: reportData.accused || 'Not specified',
          incident_date: reportData.incidentDate || 'Not specified',
          incident_time: reportData.incidentTime || 'Not specified',
          reply_to: adminData ? adminData.email : 'noreply@barangay.gov'
        };
        
        // Send email using EmailJS
        const response = await emailjs.send(
          'service_avhuukt',     // Replace with your EmailJS service ID
          'template_wge8vmi',    // Replace with your EmailJS template ID
          templateParams
        );
        
        console.log('Email sent successfully:', response);
        return true;
      } catch (error) {
        console.error('Failed to send email:', error);
        return false;
      }
    }

    // ðŸ”¹ Helper function to get status update message
    function getStatusUpdateMessage(status) {
      const messages = {
        'Pending': 'Your report has been received and is pending review by our barangay officials.',
        'In Progress': 'Your report is now being processed. Our barangay officials are working on your case.',
        'Resolved': 'Your report has been resolved. Thank you for bringing this matter to our attention.'
      };
      
      return messages[status] || 'Your report status has been updated.';
    }

    // ðŸ”¹ Filter reports based on search and dropdown filters
    function filterReports() {
      const searchText = document.getElementById('searchInput').value.toLowerCase();
      const selectedMonth = document.getElementById('monthFilter').value;
      const selectedStatus = document.getElementById('statusFilter').value;
      const selectedUrgent = document.getElementById('urgentFilter').value;
      
      const tableBody = document.querySelector("#reportTable tbody");
      const rows = tableBody.querySelectorAll('tr');
      
      rows.forEach(row => {
        // Skip if this is an empty state row or doesn't have enough cells
        if (row.classList.contains('empty-state-row') || row.cells.length < 18) return;
        
        let showRow = true;
        
        // Search filter
        if (searchText) {
          let found = false;
          for (let i = 0; i < row.cells.length; i++) {
            const cellText = row.cells[i].textContent.toLowerCase();
            if (cellText.includes(searchText)) {
              found = true;
              break;
            }
          }
          // Also check select values
          if (!found) {
            const select = row.querySelector("select");
            if (select && select.value.toLowerCase().includes(searchText)) {
              found = true;
            }
          }
          if (!found) showRow = false;
        }
        
        // Month filter
        if (selectedMonth && showRow) {
          const dateCell = row.cells[8]; // Date Submitted column
          if (dateCell) {
            const dateText = dateCell.textContent;
            if (dateText) {
              const date = new Date(dateText);
              const month = (date.getMonth() + 1).toString().padStart(2, '0');
              if (month !== selectedMonth) {
                showRow = false;
              }
            } else {
              showRow = false;
            }
          }
        }
        
        // Status filter
        if (selectedStatus && showRow) {
          const statusSelect = row.querySelector("select");
          if (statusSelect && statusSelect.value !== selectedStatus) {
            showRow = false;
          }
        }
        
        // Urgent filter
        if (selectedUrgent && showRow) {
          const urgentCell = row.cells[12]; // Urgent column
          if (urgentCell) {
            const isUrgent = urgentCell.textContent.includes("âœ…");
            if (selectedUrgent === "true" && !isUrgent) {
              showRow = false;
            } else if (selectedUrgent === "false" && isUrgent) {
              showRow = false;
            }
          }
        }
        
        row.style.display = showRow ? "" : "none";
      });
      
      // Check if any rows are visible
      const visibleRows = Array.from(rows).some(row => 
        row.style.display !== 'none' && 
        !row.classList.contains('empty-state-row') && 
        row.cells.length > 17
      );
      
      // If no rows are visible, show a message
      if (!visibleRows) {
        // Remove any existing empty state
        const existingEmptyState = tableBody.querySelector('.empty-state-row');
        if (existingEmptyState) existingEmptyState.remove();
        
        const emptyRow = document.createElement('tr');
        emptyRow.className = 'empty-state-row';
        emptyRow.innerHTML = `
          <td colspan="18" class="empty-state">
            <i class="fas fa-search"></i>
            <p>No reports match your filters</p>
            <p>Try adjusting your search criteria</p>
          </td>
        `;
        tableBody.appendChild(emptyRow);
      } else {
        // Remove empty state if there are visible rows
        const existingEmptyState = tableBody.querySelector('.empty-state-row');
        if (existingEmptyState) existingEmptyState.remove();
      }
    }

    // ðŸ”¹ Fetch Reports from Firebase filtered by admin's barangay
    function loadReports() {
      const tableBody = document.querySelector("#reportTable tbody");
      tableBody.innerHTML = ""; // Clear old rows

      if (!adminBarangay) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="18" class="empty-state">
              <i class="fas fa-exclamation-circle"></i>
              <p>Cannot determine your barangay. Please contact support.</p>
            </td>
          </tr>
        `;
        return;
      }

      db.ref("Reports").orderByChild("barangay").equalTo(adminBarangay).once("value")
        .then(async (snapshot) => {
          tableBody.innerHTML = "";
          allReports = []; // Reset the allReports array
          
          if (!snapshot.exists()) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="18" class="empty-state">
                  <i class="fas fa-file-alt"></i>
                  <p>No reports found for ${adminBarangay}</p>
                  <p>When reports are submitted for your barangay, they will appear here</p>
                </td>
              </tr>
            `;
            return;
          }
          
          // Process each report
          const reportsPromises = [];
          
          snapshot.forEach(childSnapshot => {
            const report = childSnapshot.val();
            const key = childSnapshot.key;
            
            // Store the report data for filtering
            allReports.push({ key, report });
            
            // Create a promise for each report to fetch user details
            const reportPromise = getUserDetails(report.userEmail).then(userDetails => {
              return { key, report, userDetails };
            });
            
            reportsPromises.push(reportPromise);
          });
          
          // Wait for all user details to be fetched
          const reportsWithUserDetails = await Promise.all(reportsPromises);
          
          // Now create table rows with the complete data
          reportsWithUserDetails.forEach(({ key, report, userDetails }) => {
            const row = document.createElement("tr");

            // Determine status class
            let statusClass = 'status-pending';
            if (report.status === "In Progress") statusClass = 'status-in-progress';
            if (report.status === "Resolved") statusClass = 'status-resolved';

            // Parse the schedule value for datetime-local input if it exists
            let scheduleValue = "";
            if (report.schedule && !report.isUrgent) {
              scheduleValue = parseFormattedDate(report.schedule);
            }

            // Calculate total media count based on category
            let totalMediaCount = 0;
            if (report.category === "Blotter") {
              // For Blotter: count images + videos separately
              const imageCount = report.imageUrls ? report.imageUrls.length : 0;
              const videoCount = report.videoUrls ? report.videoUrls.length : 0;
              totalMediaCount = imageCount + videoCount;
            } else {
              // For Incident: count all media in mediaUrls array
              totalMediaCount = report.mediaUrls ? report.mediaUrls.length : 0;
            }

            row.innerHTML = `
              <td>${report.caseNumber || "N/A"}</td>
              <td>${report.category || "N/A"}</td>
              <td>${report.blotterType || "N/A"}</td>
              <td>${report.type || "N/A"}</td>
              <td>${report.barangay || ""}</td>
              <td>${userDetails.firstName || "N/A"} ${userDetails.lastName || ""}</td>
              <td>${report.userEmail || ""}</td>
              <td>${report.description || ""}</td>
              <td>${report.incidentDate || ""}</td>
              <td>${report.incidentTime || ""}</td>
              <td>${report.specificLocation || ""}</td>
              <td>${report.accused || ""}</td>
              <td>${report.isUrgent ? "âœ… Yes" : "âŒ No"}</td>
              <td>
                <select>
                  <option ${report.status === "Pending" ? "selected" : ""}>Pending</option>
                  <option ${report.status === "In Progress" ? "selected" : ""}>In Progress</option>
                  <option ${report.status === "Resolved" ? "selected" : ""}>Resolved</option>
                </select>
                <div class="status-badge ${statusClass}">${report.status || "Pending"}</div>
              </td>
              <td>
                ${!report.isUrgent ? `<input type="datetime-local" value="${scheduleValue}">` : "N/A"}
              </td>
              <td><textarea placeholder="Enter feedback...">${report.feedback || ""}</textarea></td>
              <td>
                <button class="media-btn" onclick="viewMedia('${key}', this)">
                  <i class="fas fa-folder"></i>
                  ${totalMediaCount > 0 ? 
                    `<span class="media-count-badge">${totalMediaCount}</span>` : ''}
                  Media
                </button>
              </td>
              <td>
                <button class="${report.isUrgent ? 'urgent-btn' : 'submit-btn'}" 
                  onclick="submitToMain(this, '${key}')">Submit</button>
                <button class="letter-btn" onclick="openLetterEditor('${key}')">
                  <i class="fas fa-file-alt"></i> Generate Letter
                </button>
              </td>
            `;

            tableBody.appendChild(row);

            // ðŸ”¹ Auto-save when fields change WITH EMAIL NOTIFICATION (Updated with feedback and schedule)
            const statusSelect = row.querySelector("select");
            const feedbackTextarea = row.querySelector("textarea");

            statusSelect.addEventListener("change", async () => {
              const newStatus = statusSelect.value;
              const feedbackText = feedbackTextarea.value;
              const scheduleInput = row.querySelector('input[type="datetime-local"]');
              const schedule = scheduleInput ? scheduleInput.value : '';
              
              // Update database first
              await db.ref("Reports/" + key).update({ 
                status: newStatus,
                feedback: feedbackText || ''
              });
              
              // Update status badge
              const statusBadge = row.querySelector('.status-badge');
              statusBadge.textContent = newStatus;
              
              // Update class
              statusBadge.className = 'status-badge';
              if (newStatus === "Pending") statusBadge.classList.add('status-pending');
              if (newStatus === "In Progress") statusBadge.classList.add('status-in-progress');
              if (newStatus === "Resolved") statusBadge.classList.add('status-resolved');
              
              // Send email notification with feedback and schedule
              if (report.userEmail) {
                try {
                  // Format schedule for email if it exists
                  let formattedSchedule = '';
                  if (schedule) {
                    formattedSchedule = formatDateToMMDDYYTime(schedule);
                  }
                  
                  const emailSent = await sendStatusEmail(
                    report.userEmail, 
                    report, 
                    newStatus, 
                    feedbackText, 
                    formattedSchedule
                  );
                  
                  if (emailSent) {
                    showNotification('Status updated and email notification sent');
                  } else {
                    showNotification('Status updated (failed to send email)', 'warning');
                  }
                } catch (error) {
                  console.error('Error in status update:', error);
                  showNotification('Status updated (email notification failed)', 'warning');
                }
              } else {
                showNotification('Status updated (no email to notify)');
              }
            });

            // Only add event listener for schedule input if it's a non-urgent case (Updated with feedback)
            if (!report.isUrgent) {
              const scheduleInput = row.querySelector('input[type="datetime-local"]');
              if (scheduleInput) {
                scheduleInput.addEventListener("change", async () => {
                  // Format the date to mm/dd/yy time
                  const formattedDate = formatDateToMMDDYYTime(scheduleInput.value);
                  const feedbackText = feedbackTextarea.value;
                  
                  if (formattedDate) {
                    // Update database with formatted date and set status to In Progress
                    await db.ref("Reports/" + key).update({ 
                      schedule: formattedDate,
                      status: "In Progress", // Automatically set status to In Progress
                      feedback: feedbackText || ''
                    });
                    
                    // Update the status select and badge in the UI
                    statusSelect.value = "In Progress";
                    const statusBadge = row.querySelector('.status-badge');
                    statusBadge.textContent = "In Progress";
                    statusBadge.className = 'status-badge status-in-progress';
                    
                    // Send email notification with schedule and feedback
                    if (report.userEmail) {
                      try {
                        const emailSent = await sendStatusEmail(
                          report.userEmail, 
                          report, 
                          "In Progress", 
                          feedbackText, 
                          formattedDate
                        );
                        
                        if (emailSent) {
                          showNotification('Schedule set and email notification sent');
                        } else {
                          showNotification('Schedule set (failed to send email)', 'warning');
                        }
                      } catch (error) {
                        console.error('Error in schedule update:', error);
                        showNotification('Schedule set (email notification failed)', 'warning');
                      }
                    } else {
                      showNotification('Schedule set (no email to notify)');
                    }
                  } else {
                    alert("Invalid date format. Please select a valid date and time.");
                  }
                });
              }
            }

            feedbackTextarea.addEventListener("blur", () => {
              db.ref("Reports/" + key).update({ feedback: feedbackTextarea.value });
            });
          });
        })
        .catch((error) => {
          console.error("Error loading reports:", error);
          tableBody.innerHTML = `
            <tr>
              <td colspan="18" class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Error loading reports. Please try again.</p>
              </td>
            </tr>
          `;
        });
    }

    // ðŸ”¹ View Media Files (both images and videos)
    function viewMedia(reportId, button) {
      db.ref("Reports/" + reportId).once("value")
        .then((snapshot) => {
          if (snapshot.exists()) {
            const report = snapshot.val();
            currentReportData = report;
            
            // Get image and video URLs based on report category
            let imageUrls = [];
            let videoUrls = [];
            
            if (report.category === "Blotter") {
              // For Blotter reports: separate arrays for images and videos
              imageUrls = report.imageUrls || [];
              videoUrls = report.videoUrls || [];
            } else {
              // For Incident reports: one array for all media
              const allMedia = report.mediaUrls || [];
              
              // Separate images and videos from the mixed array
              allMedia.forEach(mediaItem => {
                if (typeof mediaItem === 'string') {
                  // Check if it's a video by extension or URL pattern
                  if (isVideoUrl(mediaItem)) {
                    videoUrls.push(mediaItem);
                  } else {
                    imageUrls.push(mediaItem);
                  }
                } else if (mediaItem && mediaItem.url) {
                  // If it's an object with url property
                  if (mediaItem.type === 'video' || isVideoUrl(mediaItem.url)) {
                    videoUrls.push(mediaItem.url);
                  } else {
                    imageUrls.push(mediaItem.url);
                  }
                }
              });
            }
            
            // Clear previous media
            const imagesContainer = document.getElementById('imagesContainer');
            const videosContainer = document.getElementById('videosContainer');
            imagesContainer.innerHTML = '';
            videosContainer.innerHTML = '';
            
            // Update modal info
            document.getElementById('mediaCaseNumber').textContent = report.caseNumber || 'N/A';
            document.getElementById('mediaReportType').textContent = 
              `${report.category || ''} - ${report.blotterType || ''} - ${report.incidentType || ''}`;
            
            // Create tabs
            const mediaTabs = document.getElementById('mediaTabs');
            mediaTabs.innerHTML = '';
            
            // Images tab
            const imagesTab = document.createElement('button');
            imagesTab.className = 'media-tab active';
            imagesTab.innerHTML = `
              <i class="fas fa-image"></i> Images
              ${imageUrls.length > 0 ? `<span class="media-tab-badge">${imageUrls.length}</span>` : ''}
            `;
            imagesTab.onclick = () => {
              // Activate images tab
              document.querySelectorAll('.media-tab').forEach(tab => tab.classList.remove('active'));
              imagesTab.classList.add('active');
              imagesContainer.style.display = 'grid';
              videosContainer.style.display = 'none';
            };
            mediaTabs.appendChild(imagesTab);
            
            // Videos tab
            const videosTab = document.createElement('button');
            videosTab.className = 'media-tab';
            videosTab.innerHTML = `
              <i class="fas fa-video"></i> Videos
              ${videoUrls.length > 0 ? `<span class="media-tab-badge">${videoUrls.length}</span>` : ''}
            `;
            videosTab.onclick = () => {
              // Activate videos tab
              document.querySelectorAll('.media-tab').forEach(tab => tab.classList.remove('active'));
              videosTab.classList.add('active');
              imagesContainer.style.display = 'none';
              videosContainer.style.display = 'grid';
            };
            mediaTabs.appendChild(videosTab);
            
            // Display images
            if (imageUrls.length === 0) {
              imagesContainer.innerHTML = `
                <div class="media-empty">
                  <i class="fas fa-image"></i>
                  <p>No images attached to this report</p>
                </div>
              `;
            } else {
              imageUrls.forEach((imageUrl, index) => {
                const mediaItem = document.createElement('div');
                mediaItem.className = 'media-item';
                
                mediaItem.innerHTML = `
                  <div style="position: relative;">
                    <img src="${imageUrl}" alt="Report Image ${index + 1}" 
                         class="media-image" onclick="viewFullImage('${imageUrl}')">
                    <span class="media-type-badge">Image ${index + 1}</span>
                  </div>
                  <div style="padding: 10px; text-align: center;">
                    <small>Image ${index + 1}</small>
                  </div>
                `;
                
                imagesContainer.appendChild(mediaItem);
              });
            }
            
            // Display videos
            if (videoUrls.length === 0) {
              videosContainer.innerHTML = `
                <div class="media-empty">
                  <i class="fas fa-video"></i>
                  <p>No videos attached to this report</p>
                </div>
              `;
            } else {
              videoUrls.forEach((videoUrl, index) => {
                const mediaItem = document.createElement('div');
                mediaItem.className = 'media-item';
                
                mediaItem.innerHTML = `
                  <div style="position: relative;">
                    <video controls class="media-video">
                      <source src="${videoUrl}" type="video/mp4">
                      Your browser does not support the video tag.
                    </video>
                    <span class="media-type-badge">Video ${index + 1}</span>
                  </div>
                  <div style="padding: 10px; text-align: center;">
                    <small>Video ${index + 1}</small>
                  </div>
                `;
                
                videosContainer.appendChild(mediaItem);
              });
            }
            
            // Show modal
            openModal('media');
            
          } else {
            alert("Report not found!");
          }
        })
        .catch((error) => {
          console.error("Error loading media:", error);
          alert("Error loading media files. Please try again.");
        });
    }

    // ðŸ”¹ View Full Size Image
    function viewFullImage(imageUrl) {
      const modal = document.getElementById('fullImageModal');
      const img = document.getElementById('fullImageView');
      img.src = imageUrl;
      modal.style.display = 'flex';
    }

    // ðŸ”¹ Close Full Screen Image
    function closeFullImage() {
      document.getElementById('fullImageModal').style.display = 'none';
    }

    // ðŸ”¹ Open Letter Editor
    function openLetterEditor(reportId) {
      console.log("Opening letter editor for report:", reportId);
      
      // Get the report data
      db.ref("Reports/" + reportId).once("value")
        .then((snapshot) => {
          if (snapshot.exists()) {
            const report = snapshot.val();
            console.log("Report data:", report);
            currentReportData = report;
            
            // Get user details
            getUserDetails(report.userEmail).then(userDetails => {
              const reporterName = `${userDetails.firstName || ''} ${userDetails.lastName || ''}`.trim();
              
              // Pre-fill the form with data
              document.getElementById('letterCaseNumber').value = report.caseNumber || '';
              document.getElementById('letterComplainant').value = 
                `${reporterName}, ${adminBarangay}, ${report.contactNumber || ''}`;
              
              // Pre-fill respondent with accused information if available
              document.getElementById('letterRespondent').value = 
                `${report.accused || ''},,`;
              
              // Set default date to today if not already set
              if (!document.getElementById('letterDate').value) {
                document.getElementById('letterDate').value = new Date().toISOString().split('T')[0];
              }
              
              // Set default complaint nature based on incident type
              document.getElementById('complaintNature').value = 
                report.incidentType || report.blotterType || '';
              
              // Set incident details from report description
              document.getElementById('incidentDetails').value = report.description || '';
              
              // Generate the default narrative
              generateNarrative();
              
              // Show the editor modal
              openModal('letterEditor');
            });
          } else {
            alert("Report not found!");
          }
        })
        .catch((error) => {
          console.error("Error fetching report:", error);
          alert("Error loading report data. Please try again.");
        });
    }

    // ðŸ”¹ Generate the narrative based on the form inputs
    function generateNarrative() {
      const complainant = document.getElementById('letterComplainant').value;
      const respondent = document.getElementById('letterRespondent').value;
      const complaintNature = document.getElementById('complaintNature').value;
      const incidentDetails = document.getElementById('incidentDetails').value;
      
      // Parse complainant and respondent details
      const complainantParts = complainant.split(',');
      const respondentParts = respondent.split(',');
      
      const complainantName = complainantParts[0] || '[name]';
      const complainantBarangay = complainantParts[1] || adminBarangay || '[barangay]';
      const respondentName = respondentParts[0] || '[Respondent\'s Name]';
      
      // Use the actual incident date and time from the report data
      const incidentDate = currentReportData.incidentDate || '';
      const incidentTime = currentReportData.incidentTime || '';
      
      // Format the incident date if available
      const formattedDate = incidentDate ? new Date(incidentDate).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      }) : '[date]';
      
      // Generate the narrative using the template with actual incident data
      const narrative = `I, ${complainantName}, a resident of ${complainantBarangay}, respectfully file this complaint against ${respondentName} for ${complaintNature || '[nature of the complaint]'}.

On ${formattedDate}, at around ${incidentTime || '[time]'}, while I was at ${currentReportData?.specificLocation || '[address]'}, the respondent ${incidentDetails || '[briefly describe what happened]'}.`;

      // Update the narrative textarea
      document.getElementById('letterNarrative').value = narrative;
    }

    // ðŸ”¹ Add event listeners to update the narrative when inputs change
    document.addEventListener('DOMContentLoaded', function() {
      // Add event listeners to form inputs to auto-update the narrative
      const inputsToWatch = [
        'letterComplainant', 
        'letterRespondent', 
        'complaintNature', 
        'incidentDetails',
        'letterDate'
      ];
      
      inputsToWatch.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
          input.addEventListener('input', generateNarrative);
        }
      });
      
      // Add event listeners to filter dropdowns
      document.getElementById('monthFilter').addEventListener('change', filterReports);
      document.getElementById('statusFilter').addEventListener('change', filterReports);
      document.getElementById('urgentFilter').addEventListener('change', filterReports);
      
      // Close full image modal when clicking outside
      document.getElementById('fullImageModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeFullImage();
        }
      });
      
      // Close full image modal with ESC key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeFullImage();
        }
      });
    });

    // ðŸ”¹ Generate Letter from Form Data
    function generateLetterFromForm() {
      // Check if we have current report data
      if (!currentReportData) {
        alert("No report data found. Please try opening the letter editor again.");
        return;
      }
      
      const caseNumber = document.getElementById('letterCaseNumber').value || '_____________________________';
      const letterDate = document.getElementById('letterDate').value;
      const formattedDate = letterDate ? new Date(letterDate).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      }) : '________________';
      
      const complainant = document.getElementById('letterComplainant').value;
      const respondent = document.getElementById('letterRespondent').value;
      const narrative = document.getElementById('letterNarrative').value;
      
      const letterContent = document.getElementById("letterContent");
      
      // Parse complainant details with fallbacks
      const complainantParts = complainant.split(',');
      const respondentParts = respondent.split(',');
      
      letterContent.innerHTML = `
        <div class="letter-header">
          <h2>OFFICE OF THE BARANGAY CAPTAIN</h2>
          <p>${adminBarangay.toUpperCase()}</p>
        </div>
        
        <div class="letter-date">
          <p><strong>Case#:</strong> ${caseNumber}</p>
          <p><strong>Type:</strong> ${currentReportData.blotterType || ''}, ${currentReportData.incidentType || ''}</p>
          <p><strong>Date:</strong> ${formattedDate}</p>
        </div>
        
        <div class="letter-to">
          <p><strong>COMPLAINANT/ NAGRERELAMO</strong></p>
          <p><strong>Name:</strong> ${complainantParts[0] || '________________'}</p>
          <p><strong>Barangay:</strong> ${complainantParts[1] || adminBarangay || '________________'}</p>
          <p><strong>Contact Number:</strong> ${complainantParts[2] || '____________________'}</p>
        </div>
        
        <div class="letter-to">
          <p><strong>RESPONDENT/ GINREREKLAMO</strong></p>
          <p><strong>Name:</strong> ${respondentParts[0] || '____________________________________________________'}</p>
          <p><strong>Barangay:</strong> ${respondentParts[1] || '________________________________________________'}</p>
          <p><strong>Contact Number (if known):</strong> ${respondentParts[2] || '______________________________'}</p>
        </div>
        
        <div class="letter-subject">REKLAMO (Narrative)</div>
        
        <div class="letter-message">
          ${narrative.replace(/\n/g, '<br>')}
        </div>
        
        <div style="margin-top: 40px;">
          <p style="margin: 5px 0; text-align: center;"><strong>COMPLAINANT SIGNATURE:</strong></p>
          <div style="display: flex; justify-content: center; margin-top: 20px;">
            <div style="text-align: center; margin-right: 50px;">
              <p style="margin: 30px 0 5px 0;">________________________________</p>
              <p style="margin: 0;"> Signature over printed name</p>
            </div>
            <div style="text-align: center;">
              <p style="margin: 30px 0 5px 0;">________________________________</p>
              <p style="margin: 0;"> Signature over printed name</p>
            </div>
          </div>
        </div>
      `;
      
      // Close the editor and show the letter
      closeModal('letterEditor');
      openModal('letter');
    }

    // ðŸ”¹ Print Letter
    function printLetter() {
      window.print();
    }

    // ðŸ”¹ Download Letter as PDF
    function downloadLetter() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Get the incident date and time from the report data
      const incidentDate = currentReportData.incidentDate || '';
      const incidentTime = currentReportData.incidentTime || '';
      
      // Format the incident date if available
      const formattedIncidentDate = incidentDate ? new Date(incidentDate).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      }) : '________________';
      
      // Get case number
      const caseNumber = document.getElementById('letterCaseNumber').value || '___________________________';
      
      // Get complainant and respondent details
      const complainant = document.getElementById('letterComplainant').value;
      const respondent = document.getElementById('letterRespondent').value;
      
      // Parse details
      const complainantParts = complainant.split(',');
      const respondentParts = respondent.split(',');
      
      const complainantName = complainantParts[0] || '[name]';
      const complainantBarangay = complainantParts[1] || adminBarangay || '[barangay]';
      const complainantContact = complainantParts[2] || '____________________';
      
      const respondentName = respondentParts[0] || '[Respondent\'s Name]';
      const respondentBarangay = respondentParts[1] || '________________________________________________';
      const respondentContact = respondentParts[2] || '______________________________';
      
      // Get narrative
      const narrative = document.getElementById('letterNarrative').value;
      
      // Set initial y position
      let y = 30;
      
      // Add header
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text('OFFICE OF THE BARANGAY CAPTAIN', 105, y, { align: 'center' });
      
      y += 8;
      doc.setFontSize(14);
      doc.text(`${adminBarangay.toUpperCase()}`, 105, y, { align: 'center' });
      
      // Add decorative line under header
      y += 8;
      doc.line(20, y, 200, y);
      
      // Add case number and date
      y += 15;
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      doc.text(`Case#: ${caseNumber}`, 190, y, { align: 'right' });
      
      y += 7;
      const reportType = `${currentReportData.blotterType || ''}, ${currentReportData.incidentType || ''}`;
      doc.text(`Type: ${reportType}`, 190, y, { align: 'right' });
      
      y += 7;
      doc.text(`Date: ${formattedIncidentDate}`, 190, y, { align: 'right' });
      
      // Add complainant section
      y += 20;
      doc.setFont(undefined, 'bold');
      doc.text('COMPLAINANT/ NAGRERELAMO', 20, y);
      
      y += 8;
      doc.setFont(undefined, 'normal');
      doc.text(`Name: ${complainantName}`, 20, y);
      
      y += 8;
      doc.text(`Barangay: ${complainantBarangay}`, 20, y);
      
      y += 8;
      doc.text(`Contact Number: ${complainantContact}`, 20, y);
      
      // Add respondent section
      y += 15;
      doc.setFont(undefined, 'bold');
      doc.text('RESPONDENT/ GINREREKLAMO', 20, y);
      
      y += 8;
      doc.setFont(undefined, 'normal');
      doc.text(`Name: ${respondentName}`, 20, y);
      
      y += 8;
      doc.text(`Barangay: ${respondentBarangay}`, 20, y);
      
      y += 8;
      doc.text(`Contact Number (if known): ${respondentContact}`, 20, y);
      
      // Add subject
      y += 15;
      doc.setFont(undefined, 'bold');
      doc.text('REKLAMO (Narrative)', 105, y, { align: 'center' });
      
      // Add narrative
      y += 10;
      doc.setFont(undefined, 'normal');
      const splitText = doc.splitTextToSize(narrative, 170);
      doc.text(splitText, 20, y);
      
      // Calculate height of narrative to position signature area correctly
      const textHeight = splitText.length * 6;
      y += textHeight + 20;
      
      // Add signature area
      doc.setFont(undefined, 'bold');
      doc.text('COMPLAINANT SIGNATURE:', 105, y, { align: 'center' });
      
      y += 15;
      doc.setFont(undefined, 'normal');
      doc.text('_________________________', 60, y, { align: 'center' });
      doc.text('_________________________', 140, y, { align: 'center' });
      
      y += 8;
      doc.text('Signature over printed name', 60, y, { align: 'center' });
      doc.text('Signature over printed name', 140, y, { align: 'center' });
      
      // Save the PDF
      doc.save(`Barangay_Letter_${caseNumber || new Date().getTime()}.pdf`);
    }

    // ðŸ”¹ Submit Updates to Main Admin + Save to Firebase
    function submitToMain(button, reportId) {
      const row = button.closest("tr");
      
      // Get the correct values from the table cells using the correct indices
      const caseNumber = row.cells[0].innerText;
      const category = row.cells[1].innerText;
      const blotterType = row.cells[2].innerText;
      const incidentType = row.cells[3].innerText;
      const barangay = row.cells[4].innerText;
      const reporter = row.cells[5].innerText;
      const email = row.cells[6].innerText;
      const description = row.cells[7].innerText;
      const dateSubmitted = row.cells[8].innerText;
      const incidentTime = row.cells[9].innerText;
      const specificLocation = row.cells[10].innerText;
      const accused = row.cells[11].innerText;
      const isUrgent = row.cells[12].innerText.includes("âœ…") ? true : false;
      const status = row.cells[13].querySelector("select").value;
      
      // Get the schedule value only if it's a non-urgent case
      let schedule = "N/A";
      if (!isUrgent) {
        const scheduleInput = row.cells[14].querySelector('input[type="datetime-local"]');
        if (scheduleInput && scheduleInput.value) {
          // Format the date to mm/dd/yy time
          schedule = formatDateToMMDDYYTime(scheduleInput.value);
        }
      }
      
      const feedback = row.cells[15].querySelector("textarea").value || "No feedback";
      
      // Get current admin user info
      const currentUser = auth.currentUser;
      
      if (!currentUser) {
        alert("âŒ You must be logged in to submit reports.");
        return;
      }

      // Fetch the report to get media URLs
      db.ref("Reports/" + reportId).once("value")
        .then((snapshot) => {
          if (!snapshot.exists()) {
            alert("Report not found!");
            return;
          }

          const report = snapshot.val();
          
          // Get media URLs based on category
          let mediaUrls = [];
          let videoUrls = [];
          
          if (report.category === "Blotter") {
            // For Blotter reports: separate arrays
            mediaUrls = report.imageUrls || [];  // Images only
            videoUrls = report.videoUrls || [];  // Videos only
          } else {
            // For Incident reports: one array for all media
            mediaUrls = report.mediaUrls || [];  // Both images and videos
            // For incident reports, we don't separate videos - they stay in mediaUrls
          }

          // Fetch admin details from BrgyAccounts
          return db.ref('BrgyAccounts').orderByChild('email').equalTo(currentUser.email).once('value')
            .then((adminSnapshot) => {
              if (!adminSnapshot.exists()) {
                alert("âŒ Admin account not found. Please log in again.");
                return;
              }

              let adminData = null;
              adminSnapshot.forEach((childSnapshot) => {
                adminData = childSnapshot.val();
              });

              // Create submission data object with admin info including mediaUrls and videoUrls
              const submissionData = {
                caseNumber: caseNumber,
                category: category,
                blotterType: blotterType,
                incidentType: incidentType,
                barangay: barangay,
                reporter: reporter,
                email: email,
                description: description,
                dateSubmitted: dateSubmitted,
                incidentTime: incidentTime,
                specificLocation: specificLocation,
                accused: accused,
                isUrgent: isUrgent,
                status: status,
                schedule: schedule,
                feedback: feedback,
                submittedAt: new Date().toISOString(),
                submittedBy: {
                  uid: currentUser.uid,
                  email: currentUser.email,
                  firstName: adminData.firstName,
                  lastName: adminData.lastName,
                  barangay: adminData.barangay,
                  position: adminData.position || "Barangay Admin"
                },
                originalReportId: reportId
              };

              // Add media based on category
              if (category === "Blotter") {
                // For Blotter: separate arrays
                submissionData.imageUrls = mediaUrls;  // From imageUrls
                submissionData.videoUrls = videoUrls;  // From videoUrls
              } else {
                // For Incident: one array for all media
                submissionData.mediaUrls = mediaUrls;  // From mediaUrls (mixed images & videos)
              }

              // Save to Submitted node with a new unique key
              const newSubmissionKey = db.ref().child('Submitted').push().key;
              
              return db.ref("Submitted/" + newSubmissionKey).set(submissionData)
                .then(() => {
                  alert(`âœ… Report successfully submitted to Main Admin!`);
                  
                  // Update the status in the original report to indicate it's been submitted
                  db.ref("Reports/" + reportId).update({
                    status: status,
                    schedule: schedule,
                    feedback: feedback,
                    accused: accused,
                    submitted: true,
                    submittedAt: new Date().toISOString(),
                    submittedBy: currentUser.uid
                  });
                })
                .catch((error) => {
                  console.error("Error submitting report:", error);
                  alert("âŒ Error submitting report. Please try again.");
                });
            });
        })
        .catch((error) => {
          console.error("Error fetching report:", error);
          alert("âŒ Error fetching report data. Please try again.");
        });
    }

    // ðŸ”¹ Export Table to PDF with filtering and landscape orientation
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      
      // Create PDF in landscape orientation
      const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'legal'
      });

      // Get filter values for filename
      const selectedMonth = document.getElementById('monthFilter').value;
      const selectedStatus = document.getElementById('statusFilter').value;
      const selectedUrgent = document.getElementById('urgentFilter').value;
      const searchText = document.getElementById('searchInput').value;
      
      // Create filename with filter information
      let filename = `Reports_${adminBarangay}`;
      if (selectedMonth) {
        const monthNames = ["January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"];
        filename += `_${monthNames[parseInt(selectedMonth)-1]}`;
      }
      if (selectedStatus) filename += `_${selectedStatus.replace(' ', '')}`;
      if (selectedUrgent) filename += `_${selectedUrgent === 'true' ? 'Urgent' : 'NonUrgent'}`;
      if (searchText) filename += `_Search`;

      // Title with filter information
      let title = `Reports Table - ${adminBarangay}`;
      let subtitle = '';
      
      if (selectedMonth || selectedStatus || selectedUrgent || searchText) {
        subtitle = 'Filtered by: ';
        const filters = [];
        
        if (selectedMonth) {
          const monthNames = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"];
          filters.push(`Month: ${monthNames[parseInt(selectedMonth)-1]}`);
        }
        if (selectedStatus) filters.push(`Status: ${selectedStatus}`);
        if (selectedUrgent) filters.push(`Urgent: ${selectedUrgent === 'true' ? 'Yes' : 'No'}`);
        if (searchText) filters.push(`Search: "${searchText}"`);
        
        subtitle += filters.join(', ');
      }

      // Add title and subtitle
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text(title, 14, 15);
      
      if (subtitle) {
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(subtitle, 14, 22);
      }

      const table = document.getElementById("reportTable");
      
      // Get only visible rows (respecting current filters)
      const visibleRows = Array.from(table.querySelectorAll("tbody tr"))
        .filter(row => row.style.display !== 'none' && !row.classList.contains('empty-state-row') && row.cells.length > 17);

      const head = [[
        "Case#", "Category", "Blotter Type", "Incident Type", "Barangay", "Reporter", "Email", 
        "Description", "Date Submitted", "Incident Time", "Specific Location", "Accused",
        "Urgent?", "Status", "Schedule", "Admin Feedback", "Media Count"
      ]];

      const body = [];

      visibleRows.forEach(row => {
        const cells = row.querySelectorAll("td");
        const rowData = [];

        for (let i = 0; i < cells.length - 1; i++) {  // skip "Actions"
          // Skip the media button cell (index 16)
          if (i === 16) {
            // Get media count from the button
            const mediaBtn = cells[i].querySelector('.media-btn');
            const countBadge = mediaBtn ? mediaBtn.querySelector('.media-count-badge') : null;
            const mediaCount = countBadge ? countBadge.textContent : '0';
            rowData.push(mediaCount);
            continue;
          }
          
          const select = cells[i].querySelector("select");
          const input = cells[i].querySelector("input");
          const textarea = cells[i].querySelector("textarea");

          if (select) {
            rowData.push(select.value);
          } else if (input) {
            rowData.push(input.value || "â€”");
          } else if (textarea) {
            // Truncate long feedback text to prevent PDF overflow
            const text = textarea.value || "No feedback";
            rowData.push(text.length > 100 ? text.substring(0, 100) + "..." : text);
          } else {
            // Truncate long description text to prevent PDF overflow
            let cellText = cells[i].innerText.trim();
            if (i === 7 && cellText.length > 100) { // Description column
              cellText = cellText.substring(0, 100) + "...";
            }
            rowData.push(cellText);
          }
        }

        body.push(rowData);
      });

      // Add the table to PDF
      doc.autoTable({
        head: head,
        body: body,
        startY: subtitle ? 28 : 20,
        styles: { 
          fontSize: 7,
          cellPadding: 2,
          overflow: 'linebreak'
        },
        headStyles: { 
          fillColor: [30, 41, 59],
          textColor: 255,
          fontStyle: 'bold'
        },
        theme: 'grid',
        margin: { top: 10 },
        tableWidth: 'auto',
        columnStyles: {
          0: { cellWidth: 20 }, // Case#
          1: { cellWidth: 15 }, // Category
          2: { cellWidth: 15 }, // Blotter Type
          3: { cellWidth: 15 }, // Incident Type
          4: { cellWidth: 20 }, // Barangay
          5: { cellWidth: 20 }, // Reporter
          6: { cellWidth: 35 }, // Email
          7: { cellWidth: 50 }, // Description
          8: { cellWidth: 20 }, // Date Submitted
          9: { cellWidth: 15 }, // Incident Time
          10: { cellWidth: 30 }, // Specific Location
          11: { cellWidth: 25 }, // Accused
          12: { cellWidth: 15 }, // Urgent?
          13: { cellWidth: 15 }, // Status
          14: { cellWidth: 25 }, // Schedule
          15: { cellWidth: 40 }, // Admin Feedback
          16: { cellWidth: 15 }, // Media Count
        }
      });

      // Save the PDF
      doc.save(`${filename}.pdf`);
    }

    // ðŸ”¹ Search Filter
    document.getElementById("searchInput").addEventListener("keyup", function() {
      filterReports();
    });

    // ðŸ”¹ Modal Functions
    function openModal(type) {
      document.getElementById(`${type}Modal`).style.display = 'flex';
    }

    function closeModal(type) {
      document.getElementById(`${type}Modal`).style.display = 'none';
    }

    // ðŸ”¹ Load Types from Firebase
    function loadTypes(type) {
      const listElement = document.getElementById(`${type}List`);
      listElement.innerHTML = '<p>Loading...</p>';
      
      db.ref(`${type}Type`).once('value')
        .then((snapshot) => {
          if (snapshot.exists()) {
            listElement.innerHTML = '';
            snapshot.forEach((childSnapshot) => {
              const typeName = childSnapshot.val();
              const typeKey = childSnapshot.key;
              
              const typeItem = document.createElement('div');
              typeItem.className = 'type-item';
              typeItem.innerHTML = `
                <span>${typeName}</span>
                <button class="delete-btn" onclick="deleteType('${type}', '${typeKey}')">
                  <i class="fas fa-trash"></i> Delete
                </button>
              `;
              
              listElement.appendChild(typeItem);
            });
          } else {
            listElement.innerHTML = '<p>No types added yet.</p>';
          }
        })
        .catch((error) => {
          console.error(`Error loading ${type} types:`, error);
          listElement.innerHTML = '<p>Error loading types. Please try again.</p>';
        });
    }

    // ðŸ”¹ Add New Type
    function addType(type) {
      const inputElement = document.getElementById(`${type}Name`);
      const typeName = inputElement.value.trim();
      
      if (!typeName) {
        alert('Please enter a type name');
        return;
      }
      
      // Add to Firebase
      db.ref(`${type}Type`).push(typeName)
        .then(() => {
          inputElement.value = '';
          loadTypes(type);
        })
        .catch((error) => {
          console.error(`Error adding ${type} type:`, error);
          alert('Error adding type. Please try again.');
        });
    }

    // ðŸ”¹ Delete Type
    function deleteType(type, key) {
      if (!confirm('Are you sure you want to delete this type?')) {
        return;
      }
      
      db.ref(`${type}Type/${key}`).remove()
        .then(() => {
          loadTypes(type);
        })
        .catch((error) => {
          console.error(`Error deleting ${type} type:`, error);
          alert('Error deleting type. Please try again.');
        });
    }

    // Auto-resize feedback textareas
    document.addEventListener("input", function(e) {
      if (e.target.tagName.toLowerCase() === "textarea") {
        e.target.style.height = "auto";
        e.target.style.height = (e.target.scrollHeight) + "px";
      }
    });

    // Check admin authentication when page loads
    checkAdminAuth();
  </script>
</body>
</html>