<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Add jsPDF library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Add html2canvas library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    html, body {
      width: 100%;
      height: 100%;
    }

    body {
      display: flex;
      background: #f8fafc;
    }

    /* Alarm overlay */
    .alarm-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(220, 38, 38, 0.3);
      z-index: 9999;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    
    .alarm-overlay.active {
      opacity: 1;
    }
    
    .alarm-flashing {
      animation: alarmFlash 1s infinite;
    }
    
    @keyframes alarmFlash {
      0% { background-color: rgba(220, 38, 38, 0.3); }
      50% { background-color: rgba(220, 38, 38, 0.7); }
      100% { background-color: rgba(220, 38, 38, 0.3); }
    }

    /* Sidebar */
    .sidebar {
      width: 250px; 
      background-color: #1e293b; 
      color: white; 
      flex-shrink: 0; 
      display: flex; 
      flex-direction: column; 
      box-shadow: 2px 0 8px rgba(0,0,0,0.15);
      transition: transform 0.3s ease;
      z-index: 1000;
    }
    .sidebar h2 {
      text-align: center; 
      padding: 20px; 
      border-bottom: 1px solid #334155; 
      font-weight: 600;
      font-size: 18px;
    }
    .sidebar a {
      padding: 14px 20px; 
      color: #cbd5e1; 
      text-decoration: none; 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      font-size: 14px; 
      transition: all 0.2s ease-in-out; 
      cursor: pointer;
      font-weight: 500;
    }
    .sidebar a:hover {
      background-color: #334155; 
      padding-left: 25px;
      color: white;
    }
    .sidebar a.active {
      background-color: #374151;
      color: white;
    }
    .logout-btn {
      margin-top: auto; 
      background-color: #dc2626; 
      color: white; 
      text-align: center; 
      padding: 14px 20px; 
      text-decoration: none; 
      font-size: 14px; 
      transition: 0.2s; 
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .logout-btn:hover {
      background-color: #b91c1c;
    }

    /* Main */
    .main {
      flex: 1; 
      display: flex; 
      flex-direction: column;
      overflow: hidden;
      width: 100%;
    }

    /* Topbar */
    .topbar {
      background-color: white; 
      padding: 16px 28px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
      font-size: 18px; 
      font-weight: 600; 
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      border-bottom: 1px solid #e2e8f0;
      position: relative;
    }

    /* Hamburger menu for mobile */
    .hamburger {
      display: none;
      background: none;
      border: none;
      font-size: 24px;
      color: #1e293b;
      cursor: pointer;
      padding: 5px;
    }

    /* Topbar span */
    .topbar span {
      color: #1e293b; 
      letter-spacing: 0.5px;
    }

    /* Notification */
    .notification {
      position: relative;
      cursor: pointer;
      font-size: 20px;
    }

    .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: red;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 12px;
      font-weight: bold;
    }

    .notif-dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 30px;
      background: white;
      color: #333;
      width: 250px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      z-index: 100;
    }

    .notif-dropdown p {
      padding: 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    .notif-dropdown p:last-child {
      border-bottom: none;
    }

    /* About Icon */
    .about-icon {
      cursor: pointer;
      font-size: 20px;
      color: #1e293b;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .about-icon:hover {
      background-color: #f1f5f9;
      color: #2563eb;
      transform: scale(1.1);
    }

    /* Content */
    .content {
      flex: 1;
      padding: 20px;
      height: 70%;
      overflow-y: auto;
    }

    /* Stats */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-box {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 15px;
      transition: transform 0.2s ease;
    }

    .stat-box:hover {
      transform: translateY(-5px);
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 22px;
      flex-shrink: 0;
    }

    .stat-content h3 {
      font-size: 14px;
      font-weight: 600;
      color: #555;
      margin-bottom: 5px;
    }

    .stat-content p {
      font-size: 24px;
      font-weight: bold;
      color: #1e293b;
    }

    /* Chart cards */
    .chart-card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      position: relative;
    }

    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .chart-header h3 {
      font-size: 16px;
      font-weight: 600;
      color: #1e293b;
    }

    .chart-header i {
      font-size: 20px;
      color: #1e40af;
    }

    /* Updated charts layout - stacked vertically */
    .charts-stacked {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Logout button styling */
    .logout-btn {
      margin-top: auto; 
      background-color: #dc2626; 
      color: white; 
      text-align: center; 
      padding: 15px 20px; 
      text-decoration: none; 
      font-size: 15px; 
      transition: 0.2s; 
      cursor: pointer;
    }
    .logout-btn:hover {
      background-color: #b91c1c;
    }

    /* User info box */
    #userInfoBox {
      background-color: #dbeafe;
      color: #1e40af;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #userInfoBox strong {
      color: #1e40af;
    }

    /* Download button styles */
    .download-container {
      position: relative;
      display: inline-block;
    }

    .download-btn {
      background: #f1f5f9;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      color: #475569;
      transition: all 0.2s;
      margin-left: 8px;
    }

    .download-btn:hover {
      background: #e2e8f0;
      color: #334155;
    }

    .download-options {
      display: none;
      position: absolute;
      right: 0;
      top: 35px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 100;
      min-width: 140px;
      overflow: hidden;
    }

    .download-options.show {
      display: block;
    }

    .download-option {
      padding: 10px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #475569;
      transition: background 0.2s;
    }

    .download-option:hover {
      background: #f1f5f9;
    }

    /* High-resolution canvas for PDF export */
    .high-res-canvas {
      position: absolute;
      left: -9999px;
      top: -9999px;
      width: 1200px;
      height: 800px;
    }

    /* Overlay for mobile when sidebar is open */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    /* Alarm control panel */
    .alarm-control {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 200px;
    }
    
    .alarm-control h4 {
      margin: 0;
      font-size: 16px;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .alarm-control button {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }
    
    .alarm-control button:hover {
      background: #dc2626;
    }
    
    .alarm-active {
      background: #ef4444;
      color: white;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e2e8f0;
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      color: white;
      border-radius: 16px 16px 0 0;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 24px;
    }

    .info-section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e2e8f0;
    }

    .info-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .info-section h4 {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #1e293b;
      margin-bottom: 20px;
      font-size: 18px;
    }

    .info-section h4 i {
      color: #2563eb;
    }

    .info-group {
      margin-bottom: 20px;
    }

    .info-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #475569;
      font-size: 14px;
    }

    .info-content {
      background: #f8fafc;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #2563eb;
      font-size: 14px;
      line-height: 1.6;
      color: #334155;
      min-height: 24px;
    }

    .info-content.empty {
      color: #94a3b8;
      font-style: italic;
      border-left-color: #cbd5e1;
    }

    .mayor-image-container {
      text-align: center;
      margin-bottom: 20px;
    }

    .mayor-image {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #2563eb;
      margin: 0 auto;
    }

    .placeholder-image {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      border: 4px solid #cbd5e1;
      color: #94a3b8;
      font-size: 48px;
    }

    .emergency-contact {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      padding: 12px;
      background: #f1f5f9;
      border-radius: 8px;
      border-left: 4px solid #dc2626;
    }

    .emergency-contact i {
      color: #dc2626;
      font-size: 18px;
      width: 24px;
    }

    .contact-label {
      font-weight: 600;
      color: #475569;
      min-width: 120px;
    }

    .contact-value {
      color: #334155;
      flex: 1;
    }

    .contact-value.empty {
      color: #94a3b8;
      font-style: italic;
    }

    .no-data-message {
      text-align: center;
      padding: 40px 20px;
      color: #94a3b8;
    }

    .no-data-message i {
      font-size: 48px;
      margin-bottom: 16px;
      color: #cbd5e1;
    }

    .no-data-message h4 {
      margin-bottom: 8px;
      color: #64748b;
    }

    .last-updated {
      font-size: 12px;
      color: #94a3b8;
      text-align: right;
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #e2e8f0;
    }

    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .stats-container {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }

    @media (max-width: 992px) {
      .topbar {
        padding: 16px 20px;
      }
      
      .content {
        padding: 15px;
      }
      
      .stat-box {
        padding: 15px;
      }
      
      .chart-card {
        padding: 15px;
      }
      
      .chart-header h3 {
        font-size: 15px;
      }
      
      .stat-content p {
        font-size: 22px;
      }
    }

    @media (max-width: 768px) {
      .hamburger {
        display: block;
      }
      
      .sidebar {
        position: fixed;
        height: 100%;
        transform: translateX(-100%);
        z-index: 1000;
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .sidebar-overlay.active {
        display: block;
      }
      
      .main {
        width: 100%;
      }
      
      .topbar {
        padding: 12px 15px;
        margin-bottom: 15px;
      }
      
      .topbar span {
        font-size: 16px;
      }
      
      .content {
        padding: 10px;
      }
      
      .stats-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
      
      .stat-box {
        padding: 12px;
      }
      
      .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      
      .stat-content h3 {
        font-size: 13px;
      }
      
      .stat-content p {
        font-size: 20px;
      }
      
      .chart-card {
        padding: 15px;
        border-radius: 12px;
      }
      
      .chart-header h3 {
        font-size: 14px;
      }
      
      .chart-header i {
        font-size: 18px;
      }
      
      .download-btn {
        padding: 5px 8px;
        font-size: 12px;
      }
      
      .download-options {
        top: 30px;
        min-width: 130px;
      }
      
      .download-option {
        padding: 8px 12px;
        font-size: 13px;
      }
      
      #userInfoBox {
        font-size: 12px;
        padding: 6px 12px;
      }
      
      .notification {
        font-size: 18px;
      }
      
      .badge {
        font-size: 10px;
        padding: 1px 5px;
      }
      
      .notif-dropdown {
        width: 220px;
        max-height: 250px;
      }
      
      .notif-dropdown p {
        padding: 8px;
        font-size: 13px;
      }
      
      .alarm-control {
        bottom: 10px;
        right: 10px;
        min-width: 180px;
      }
      
      .about-icon {
        font-size: 18px;
        padding: 6px;
      }
      
      /* Modal responsive */
      .modal-content {
        width: 95%;
        max-height: 85vh;
      }
      
      .modal-body {
        padding: 16px;
      }
      
      .modal-header {
        padding: 16px 20px;
      }
      
      .info-section h4 {
        font-size: 16px;
      }
      
      .emergency-contact {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .contact-label {
        min-width: auto;
      }
    }

    @media (max-width: 576px) {
      .topbar {
        padding: 10px 12px;
        margin-bottom: 10px;
      }
      
      .topbar span {
        font-size: 15px;
      }
      
      .content {
        padding: 8px;
      }
      
      .stats-container {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .stat-box {
        padding: 15px;
      }
      
      .stat-icon {
        width: 45px;
        height: 45px;
        font-size: 20px;
      }
      
      .stat-content h3 {
        font-size: 14px;
      }
      
      .stat-content p {
        font-size: 22px;
      }
      
      .chart-card {
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 15px;
      }
      
      .chart-header {
        margin-bottom: 12px;
      }
      
      .chart-header h3 {
        font-size: 14px;
      }
      
      .charts-stacked {
        gap: 15px;
      }
      
      .download-btn {
        padding: 4px 7px;
        font-size: 11px;
      }
      
      .download-options {
        min-width: 120px;
      }
      
      .download-option {
        padding: 7px 10px;
        font-size: 12px;
      }
      
      #userInfoBox {
        display: none; /* Hide admin info on very small screens */
      }
      
      .modal-header h3 {
        font-size: 18px;
      }
      
      .mayor-image, .placeholder-image {
        width: 120px;
        height: 120px;
      }
      
      .info-content {
        padding: 12px;
      }
    }

    @media (max-width: 480px) {
      .topbar span {
        font-size: 14px;
      }
      
      .stat-box {
        padding: 12px;
      }
      
      .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      
      .stat-content h3 {
        font-size: 13px;
      }
      
      .stat-content p {
        font-size: 20px;
      }
      
      .chart-card {
        padding: 10px;
      }
      
      .chart-header h3 {
        font-size: 13px;
      }
      
      .chart-header i {
        font-size: 16px;
      }
      
      .notif-dropdown {
        width: 200px;
      }
      
      .notif-dropdown p {
        padding: 6px;
        font-size: 12px;
      }
      
      .alarm-control {
        min-width: 160px;
        padding: 12px;
      }
      
      .about-icon {
        font-size: 16px;
      }
      
      .modal-body {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Alarm overlay -->
  <div id="alarmOverlay" class="alarm-overlay"></div>
  
  <!-- Sidebar Overlay for Mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <h2>Admin Panel</h2>
    <a href="SubAdmin.html" class="active"><i class="fas fa-home"></i> Dashboard</a>
    <a href="approve.html"><i class="fas fa-user-check"></i> Approve Accounts</a>
    <a href="reports.html"><i class="fas fa-calendar-alt"></i> Reports</a>
    <a href="ReportToAdmin.html" ><i class="fas fa-flag"></i> Submitted to Admin</a>
    <a href="#" id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <button class="hamburger" id="hamburgerBtn">
        <i class="fas fa-bars"></i>
      </button>
      <span>Dashboard</span>
      <div style="display:flex;align-items:center;gap:20px;">
        <div id="userInfoBox"><i class="fas fa-user-shield"></i><span id="userInfo">Loading...</span></div>
        
        <!-- About Icon -->
        <div class="about-icon" id="aboutIcon" title="About Barangay">
          <i class="fas fa-info-circle"></i>
        </div>
        
        <div class="notification" id="notificationIcon">
          <i class="fas fa-bell"></i>
          <span class="badge" id="notifBadge">0</span>
          <div class="notif-dropdown" id="notifDropdown"></div>
        </div>
      </div>
    </div>

    <div class="content">
      <!-- Stats -->
      <div class="stats-container">
        <div class="stat-box">
          <div class="stat-icon" style="background:#2563eb;"><i class="fas fa-users"></i></div>
          <div class="stat-content">
            <h3>Total Users</h3>
            <p id="userCount">0</p>
          </div>
        </div>

        <div class="stat-box">
          <div class="stat-icon" style="background:#dc2626;"><i class="fas fa-clock"></i></div>
          <div class="stat-content">
            <h3>Pending Reports</h3>
            <p id="pendingCount">0</p>
          </div>
        </div>

        <div class="stat-box">
          <div class="stat-icon" style="background:#f59e0b;"><i class="fas fa-spinner"></i></div>
          <div class="stat-content">
            <h3>In Progress</h3>
            <p id="progressCount">0</p>
          </div>
        </div>

        <div class="stat-box">
          <div class="stat-icon" style="background:#16a34a;"><i class="fas fa-check-circle"></i></div>
          <div class="stat-content">
            <h3>Resolved Reports</h3>
            <p id="resolvedCount">0</p>
          </div>
        </div>
      </div>

      <!-- Reports Overview Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Reports Overview</h3>
          <div style="display: flex; align-items: center;">
            <div class="download-container">
              <button class="download-btn" data-chart="reportsChart">
                <i class="fas fa-download"></i>
              </button>
              <div class="download-options" id="reportsChartOptions">
                <div class="download-option" data-format="png" data-chart="reportsChart">
                  <i class="fas fa-image"></i> Download PNG
                </div>
                <div class="download-option" data-format="pdf" data-chart="reportsChart">
                  <i class="fas fa-file-pdf"></i> Download PDF
                </div>
              </div>
            </div>
            <i class="fas fa-chart-bar"></i>
          </div>
        </div>
        <canvas id="reportsChart" height="110"></canvas>
      </div>

      <!-- Updated Charts Layout - Stacked Vertically -->
      <div class="charts-stacked">
        <!-- Blotter Type Chart -->
        <div class="chart-card">
          <div class="chart-header">
            <h3>Blotter Types</h3>
            <div style="display: flex; align-items: center;">
              <div class="download-container">
                <button class="download-btn" data-chart="blotterTypeChart">
                  <i class="fas fa-download"></i>
                </button>
                <div class="download-options" id="blotterTypeChartOptions">
                  <div class="download-option" data-format="png" data-chart="blotterTypeChart">
                    <i class="fas fa-image"></i> Download PNG
                  </div>
                  <div class="download-option" data-format="pdf" data-chart="blotterTypeChart">
                    <i class="fas fa-file-pdf"></i> Download PDF
                  </div>
                </div>
              </div>
              <i class="fas fa-file-alt"></i>
            </div>
          </div>
          <canvas id="blotterTypeChart" height="110"></canvas>
        </div>

        <!-- Incident Type Chart -->
        <div class="chart-card">
          <div class="chart-header">
            <h3>Incident Types</h3>
            <div style="display: flex; align-items: center;">
              <div class="download-container">
                <button class="download-btn" data-chart="incidentTypeChart">
                  <i class="fas fa-download"></i>
                </button>
                <div class="download-options" id="incidentTypeChartOptions">
                  <div class="download-option" data-format="png" data-chart="incidentTypeChart">
                    <i class="fas fa-image"></i> Download PNG
                  </div>
                  <div class="download-option" data-format="pdf" data-chart="incidentTypeChart">
                    <i class="fas fa-file-pdf"></i> Download PDF
                  </div>
                </div>
              </div>
              <i class="fas fa-exclamation-circle"></i>
            </div>
          </div>
          <canvas id="incidentTypeChart" height="110"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Alarm Control Panel (initially hidden) -->
  <div id="alarmControl" class="alarm-control" style="display: none;">
    <h4><i class="fas fa-bell"></i> Urgent Report Alert</h4>
    <p id="alarmMessage">Urgent reports detected!</p>
    <button id="silenceAlarmBtn">Silence Alarm</button>
  </div>

  <!-- About Modal -->
  <div class="modal-overlay" id="aboutModalOverlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>About Barangay </h3>
        <button class="modal-close" id="closeAboutModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body" id="aboutModalBody">
        <!-- Content will be loaded dynamically -->
        <div class="no-data-message" id="noDataMessage">
          <i class="fas fa-info-circle"></i>
          <h4>No Information Available</h4>
          <p>No about information has been set up yet.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- High-resolution canvases for PDF export (hidden) -->
  <canvas id="highResReportsChart" class="high-res-canvas"></canvas>
  <canvas id="highResBlotterTypeChart" class="high-res-canvas"></canvas>
  <canvas id="highResIncidentTypeChart" class="high-res-canvas"></canvas>

<script type="module">
  // Initialize jsPDF
  window.jsPDF = window.jspdf.jsPDF;

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCSUCbCVKEYZx_-dySDrAauf1OZ6GIUMgI",
    authDomain: "bpoms-15479.firebaseapp.com",
    databaseURL: "https://bpoms-15479-default-rtdb.firebaseio.com",
    projectId: "bpoms-15479",
    storageBucket: "bpoms-15479.appspot.com",
    messagingSenderId: "461076757426",
    appId: "1:461076757426:web:61adf7d3f1734cc05702ab"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const rtdb = getDatabase(app);

  const userInfo = document.getElementById("userInfo");
  const reportsRef = collection(db, "reports");

  const notifBadge = document.getElementById("notifBadge");
  const notifDropdown = document.getElementById("notifDropdown");
  const notifIcon = document.getElementById("notificationIcon");
  const hamburgerBtn = document.getElementById("hamburgerBtn");
  const sidebarOverlay = document.getElementById("sidebarOverlay");
  const sidebar = document.getElementById("sidebar");

  // Alarm elements
  const alarmOverlay = document.getElementById("alarmOverlay");
  const alarmControl = document.getElementById("alarmControl");
  const alarmMessage = document.getElementById("alarmMessage");
  const silenceAlarmBtn = document.getElementById("silenceAlarmBtn");

  // About modal elements
  const aboutIcon = document.getElementById('aboutIcon');
  const aboutModalOverlay = document.getElementById('aboutModalOverlay');
  const closeAboutModal = document.getElementById('closeAboutModal');
  const aboutModalBody = document.getElementById('aboutModalBody');
  const noDataMessage = document.getElementById('noDataMessage');
  

  // Store admin barangay for use in PDF generation
  let adminBarangay = "";

  // Alarm variables
  let previousUrgentCount = 0;
  let alarmActive = false;
  let alarmInterval = null;

  // Toggle sidebar for mobile
  function toggleSidebar() {
    sidebar.classList.toggle('active');
    sidebarOverlay.classList.toggle('active');
  }

  // Add event listeners for sidebar toggle
  hamburgerBtn.addEventListener('click', toggleSidebar);
  sidebarOverlay.addEventListener('click', toggleSidebar);

  notifIcon.addEventListener("click", () => {
    notifDropdown.style.display = notifDropdown.style.display === "block" ? "none" : "block";
  });

  // Open About modal
  aboutIcon.addEventListener('click', () => {
    
    loadAboutInfo();
    aboutModalOverlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  });

  // Close modal functions
  function closeModal() {
    aboutModalOverlay.style.display = 'none';
    document.body.style.overflow = 'auto';
  }

  closeAboutModal.addEventListener('click', closeModal);

  // Close modal when clicking outside content
  aboutModalOverlay.addEventListener('click', (e) => {
    if (e.target === aboutModalOverlay) {
      closeModal();
    }
  });

  // Load About info from Firebase and display it
  async function loadAboutInfo() {
    try {
      const aboutRef = ref(rtdb, `AboutInfo`); // Changed: Directly to AboutInfo node
      const snapshot = await get(aboutRef);
      
      if (snapshot.exists()) {
        const aboutData = snapshot.val();
        displayAboutInfo(aboutData);
        noDataMessage.style.display = 'none';
      } else {
        // Show no data message
        noDataMessage.style.display = 'block';
        aboutModalBody.innerHTML = '';
        aboutModalBody.appendChild(noDataMessage);
      }
    } catch (error) {
      console.error('Error loading About info:', error);
      // Show error message
      noDataMessage.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i>
        <h4>Error Loading Information</h4>
        <p>Unable to load about information. Please try again later.</p>
      `;
      noDataMessage.style.display = 'block';
      aboutModalBody.innerHTML = '';
      aboutModalBody.appendChild(noDataMessage);
    }
  }

  // Display About information in the modal
  function displayAboutInfo(data) {
    let html = `
      <!-- Mayor Section -->
      <div class="info-section">
        <h4><i class="fas fa-user-tie"></i> Mayor Information</h4>
        
        <div class="mayor-image-container">
          ${data.mayorImageUrl ? 
            `<img src="${data.mayorImageUrl}" alt="Mayor Photo" class="mayor-image" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\"placeholder-image\"><i class=\"fas fa-user-tie\"></i></div>` : 
            `<div class="placeholder-image"><i class="fas fa-user-tie"></i></div>`
          }
        </div>
        
        <div class="info-group">
          <label>Mayor Name</label>
          <div class="info-content ${!data.mayor ? 'empty' : ''}">
            ${data.mayor || 'Not specified'}
          </div>
        </div>
        
        <div class="info-group">
          <label>Mayor Biography</label>
          <div class="info-content ${!data.mayorBio ? 'empty' : ''}">
            ${data.mayorBio || 'No biography available'}
          </div>
        </div>
      </div>
      
      <!-- Barangay Information -->
      <div class="info-section">
        <h4><i class="fas fa-landmark"></i> Barangay Information</h4>
        
        <div class="info-group">
          <label>Barangay History</label>
          <div class="info-content ${!data.history ? 'empty' : ''}">
            ${data.history || 'No history available'}
          </div>
        </div>
        
        <div class="info-group">
          <label>Mission</label>
          <div class="info-content ${!data.mission ? 'empty' : ''}">
            ${data.mission || 'No mission statement available'}
          </div>
        </div>
        
        <div class="info-group">
          <label>Vision</label>
          <div class="info-content ${!data.vision ? 'empty' : ''}">
            ${data.vision || 'No vision statement available'}
          </div>
        </div>
        
        <div class="info-group">
          <label>Core Values</label>
          <div class="info-content ${!data.coreValues ? 'empty' : ''}">
            ${data.coreValues || 'No core values specified'}
          </div>
        </div>
      </div>
      
      <!-- Emergency Contacts -->
      <div class="info-section">
        <h4><i class="fas fa-phone-alt"></i> Emergency Contacts</h4>
        
        <div class="emergency-contact">
          <i class="fas fa-shield-alt"></i>
          <div class="contact-label">Police Station:</div>
          <div class="contact-value ${!data.police ? 'empty' : ''}">
            ${data.police || 'Not available'}
          </div>
        </div>
        
        <div class="emergency-contact">
          <i class="fas fa-ambulance"></i>
          <div class="contact-label">Medical Center:</div>
          <div class="contact-value ${!data.medical ? 'empty' : ''}">
            ${data.medical || 'Not available'}
          </div>
        </div>
        
        <div class="emergency-contact">
          <i class="fas fa-fire-extinguisher"></i>
          <div class="contact-label">Fire Department (BFP):</div>
          <div class="contact-value ${!data.bfp ? 'empty' : ''}">
            ${data.bfp || 'Not available'}
          </div>
        </div>
        
        <div class="emergency-contact">
          <i class="fas fa-exclamation-triangle"></i>
          <div class="contact-label">Disaster Management:</div>
          <div class="contact-value ${!data.disaster ? 'empty' : ''}">
            ${data.disaster || 'Not available'}
          </div>
        </div>
      </div>
    `;
    
    // Add last updated timestamp if available
    if (data.lastUpdated) {
      const lastUpdated = new Date(data.lastUpdated).toLocaleString();
      html += `<div class="last-updated">Last updated: ${lastUpdated}</div>`;
    }
    
    aboutModalBody.innerHTML = html;
  }

  // âœ… Check logged-in Barangay Admin
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userRef = ref(rtdb, "BrgyAccounts/" + user.uid);
      const snap = await get(userRef);

      if (snap.exists()) {
        const data = snap.val();
        adminBarangay = data.barangay;

        userInfo.innerHTML = `Welcome Brgy. Admin <strong>${data.firstName} ${data.middleName || ""} ${data.lastName}</strong> of <strong>${adminBarangay}</strong>`;

        // Show dashboard
        document.querySelector(".sidebar").style.display = "flex";
        document.querySelector(".main").style.display = "flex";

        // âœ… Fetch only users from Realtime Database that match barangay
        const usersRef = ref(rtdb, "users");
        onValue(usersRef, (snapshot) => {
          let count = 0;
          snapshot.forEach(child => {
            const u = child.val();
            if (u.barangay === adminBarangay) {
              count++;
            }
          });
          document.getElementById("userCount").textContent = count;
        });

        // âœ… Fetch reports counts from Realtime Database filtered by barangay
        const reportsDbRef = ref(rtdb, "Reports");
        onValue(reportsDbRef, (snapshot) => {
          let pending = 0, inProgress = 0, resolved = 0;
          let urgent = 0, nonUrgent = 0;
          let total = 0;
          
          // Object to count blotter types
          const blotterTypeCounts = {};
          
          // Object to count incident types
          const incidentTypeCounts = {};
          
          snapshot.forEach(child => {
            const report = child.val();
            // Only count reports from the admin's barangay
            if (report.barangay === adminBarangay) {
              total++;
              
              // Count by status
              if (report.status === "Pending") pending++;
              if (report.status === "In Progress") inProgress++;
              if (report.status === "Resolved") resolved++;
              
              // Count by urgency using the isUrgent field
              if (report.isUrgent === true) {
                urgent++;
              } else {
                nonUrgent++;
              }
              
              // Count blotter types
              if (report.blotterType) {
                if (blotterTypeCounts[report.blotterType]) {
                  blotterTypeCounts[report.blotterType]++;
                } else {
                  blotterTypeCounts[report.blotterType] = 1;
                }
              }
              
              // Count incident types
              if (report.incidentType) {
                if (incidentTypeCounts[report.incidentType]) {
                  incidentTypeCounts[report.incidentType]++;
                } else {
                  incidentTypeCounts[report.incidentType] = 1;
                }
              }
            }
          });
          
          // Update the stat boxes
          document.getElementById("pendingCount").textContent = pending;
          document.getElementById("progressCount").textContent = inProgress;
          document.getElementById("resolvedCount").textContent = resolved;
          
          // Update the main chart
          reportsChart.data.datasets[0].data = [total, urgent, nonUrgent];
          reportsChart.update();
          
          // Update the high-resolution chart
          updateHighResChart(reportsChart, highResReportsChart);
          
          // Update the blotter type chart
          updateBlotterTypeChart(blotterTypeCounts);
          
          // Update the incident type chart
          updateIncidentTypeChart(incidentTypeCounts);
          
          // Check for new urgent reports and trigger alarm if needed
          checkForNewUrgentReports(urgent);
        });

        // âœ… Monitor Reports node for new reports matching barangay
        const reportsDbRefForNotif = ref(rtdb, "Reports");
        onValue(reportsDbRefForNotif, (snapshot) => {
          let notificationCount = 0;
          notifDropdown.innerHTML = "";
          
          snapshot.forEach(child => {
            const report = child.val();
            // Only show notifications for reports from the admin's barangay
            if (report.barangay === adminBarangay) {
              notificationCount++;
              
              // Add report notification
              const timestamp = report.timestamp ? new Date(report.timestamp).toLocaleString() : "Recently";
              notifDropdown.innerHTML += `
                <p><strong>ðŸ“‹ NEW REPORT</strong><br>
                ${report.description || "New report submitted"}<br>
                <small>${timestamp}</small></p>`;
            }
          });

          // âœ… Monitor users node for new accounts matching barangay
          const usersRefForNotif = ref(rtdb, "users");
          onValue(usersRefForNotif, (snapshot) => {
            snapshot.forEach(child => {
              const userData = child.val();
              // Only show notifications for users from the admin's barangay
              if (userData.barangay === adminBarangay) {
                notificationCount++;
                
                // Add user notification
                const timestamp = userData.timestamp ? new Date(userData.timestamp).toLocaleString() : "Recently";
                notifDropdown.innerHTML += `
                  <p><strong>ðŸ‘¤ NEW USER</strong><br>
                  ${userData.firstName || ""} ${userData.lastName || ""} registered<br>
                  <small>${timestamp}</small></p>`;
              }
            });
            
            // Update notification badge
            notifBadge.textContent = notificationCount;
          });
        }, { onlyOnce: false }); // Continue listening for changes

      } else {
        window.location.href = "index.html"; // Not a Barangay Admin
      }
    } else {
      window.location.href = "index.html"; // No user logged in
    }
  });

  // Check for new urgent reports and trigger alarm
  function checkForNewUrgentReports(currentUrgentCount) {
    // If there are urgent reports and the count has increased
    if (currentUrgentCount > 0 && currentUrgentCount > previousUrgentCount) {
      const newUrgentCount = currentUrgentCount - previousUrgentCount;
      triggerAlarm(newUrgentCount);
    }
    
    // Update the previous count
    previousUrgentCount = currentUrgentCount;
  }

  // Trigger alarm for urgent reports
  function triggerAlarm(newUrgentCount) {
    if (alarmActive) return; // Don't trigger if already active
    
    alarmActive = true;
    
    // Update alarm message
    alarmMessage.textContent = `${newUrgentCount} new urgent report${newUrgentCount > 1 ? 's' : ''} detected!`;
    
    // Show alarm control
    alarmControl.style.display = 'flex';
    
    // Start flashing effect
    alarmOverlay.classList.add('active', 'alarm-flashing');
    
    // Create alarm sound using Web Audio API (if supported)
    try {
      playAlarmSound();
    } catch (error) {
      console.error("Could not play alarm sound:", error);
    }
  }

  // Play alarm sound using Web Audio API
  function playAlarmSound() {
    // Create audio context
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioContext = new AudioContext();
    
    // Create oscillator for beep sound
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
    
    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
    
    // Beep pattern (three short beeps)
    oscillator.start();
    
    // First beep
    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
    gainNode.gain.setValueAtTime(0, audioContext.currentTime + 0.2);
    
    // Second beep
    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime + 0.4);
    gainNode.gain.setValueAtTime(0, audioContext.currentTime + 0.6);
    
    // Third beep
    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime + 0.8);
    gainNode.gain.setValueAtTime(0, audioContext.currentTime + 1.0);
    
    // Stop oscillator after beeps
    oscillator.stop(audioContext.currentTime + 1.0);
    
    // Repeat the sound every 3 seconds while alarm is active
    if (alarmInterval) clearInterval(alarmInterval);
    alarmInterval = setInterval(() => {
      if (alarmActive) {
        playAlarmSound();
      } else {
        clearInterval(alarmInterval);
      }
    }, 3000);
  }

  // Silence the alarm
  function silenceAlarm() {
    alarmActive = false;
    
    // Remove flashing effect
    alarmOverlay.classList.remove('active', 'alarm-flashing');
    
    // Hide alarm control
    alarmControl.style.display = 'none';
    
    // Stop alarm sound
    if (alarmInterval) {
      clearInterval(alarmInterval);
      alarmInterval = null;
    }
  }

  // Add event listener for the silence alarm button
  silenceAlarmBtn.addEventListener('click', silenceAlarm);

  // Main reports chart setup
  let reportsChartCtx = document.getElementById("reportsChart").getContext("2d");
  let reportsChart = new Chart(reportsChartCtx, {
    type: "bar",
    data: {
      labels: ["Total", "Urgent", "Non-Urgent"],
      datasets: [{
        label: "Reports Count",
        data: [0, 0, 0],
        backgroundColor: ["#1e3a8a", "#dc2626", "#16a34a"]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // High-resolution reports chart setup
  let highResReportsChartCtx = document.getElementById("highResReportsChart").getContext("2d");
  let highResReportsChart = new Chart(highResReportsChartCtx, {
    type: "bar",
    data: {
      labels: ["Total", "Urgent", "Non-Urgent"],
      datasets: [{
        label: "Reports Count",
        data: [0, 0, 0],
        backgroundColor: ["#1e3a8a", "#dc2626", "#16a34a"]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // Blotter type chart setup
  let blotterTypeChartCtx = document.getElementById("blotterTypeChart").getContext("2d");
  let blotterTypeChart = new Chart(blotterTypeChartCtx, {
    type: "bar",
    data: {
      labels: [],
      datasets: [{
        label: "Count",
        data: [],
        backgroundColor: [
          "#4f46e5", "#ec4899", "#10b981", "#f59e0b", 
          "#ef4444", "#8b5cf6", "#06b6d4", "#f97316"
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // High-resolution blotter type chart setup
  let highResBlotterTypeChartCtx = document.getElementById("highResBlotterTypeChart").getContext("2d");
  let highResBlotterTypeChart = new Chart(highResBlotterTypeChartCtx, {
    type: "bar",
    data: {
      labels: [],
      datasets: [{
        label: "Count",
        data: [],
        backgroundColor: [
          "#4f46e5", "#ec4899", "#10b981", "#f59e0b", 
          "#ef4444", "#8b5cf6", "#06b6d4", "#f97316"
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // Incident type chart setup
  let incidentTypeChartCtx = document.getElementById("incidentTypeChart").getContext("2d");
  let incidentTypeChart = new Chart(incidentTypeChartCtx, {
    type: "bar",
    data: {
      labels: [],
      datasets: [{
        label: "Count",
        data: [],
        backgroundColor: [
          "#3b82f6", "#f43f5e", "#84cc16", "#f97316", 
          "#6366f1", "#14b8a6", "#a855f7", "#ef4444"
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // High-resolution incident type chart setup
  let highResIncidentTypeChartCtx = document.getElementById("highResIncidentTypeChart").getContext("2d");
  let highResIncidentTypeChart = new Chart(highResIncidentTypeChartCtx, {
    type: "bar",
    data: {
      labels: [],
      datasets: [{
        label: "Count",
        data: [],
        backgroundColor: [
          "#3b82f6", "#f43f5e", "#84cc16", "#f97316", 
          "#6366f1", "#14b8a6", "#a855f7", "#ef4444"
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // Function to update the blotter type chart
  function updateBlotterTypeChart(blotterTypeCounts) {
    const labels = Object.keys(blotterTypeCounts);
    const data = Object.values(blotterTypeCounts);
    
    blotterTypeChart.data.labels = labels;
    blotterTypeChart.data.datasets[0].data = data;
    blotterTypeChart.update();
    
    highResBlotterTypeChart.data.labels = labels;
    highResBlotterTypeChart.data.datasets[0].data = data;
    highResBlotterTypeChart.update();
  }

  // Function to update the incident type chart
  function updateIncidentTypeChart(incidentTypeCounts) {
    const labels = Object.keys(incidentTypeCounts);
    const data = Object.values(incidentTypeCounts);
    
    incidentTypeChart.data.labels = labels;
    incidentTypeChart.data.datasets[0].data = data;
    incidentTypeChart.update();
    
    highResIncidentTypeChart.data.labels = labels;
    highResIncidentTypeChart.data.datasets[0].data = data;
    highResIncidentTypeChart.update();
  }

  // Function to update high-resolution chart
  function updateHighResChart(sourceChart, targetChart) {
    targetChart.data = JSON.parse(JSON.stringify(sourceChart.data));
    targetChart.update();
  }

  // Listen for reports (Firestore) - For notifications only
  onSnapshot(reportsRef, (snapshot) => {
    let total = snapshot.size;
    notifBadge.textContent = total;
    
    // Clear and repopulate notifications
    notifDropdown.innerHTML = ""; 
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      notifDropdown.innerHTML += `<p><strong>${data.type?.toUpperCase()}</strong>: ${data.description || "New report submitted"}</p>`;
    });
  });

  // âœ… Logout functionality
  document.getElementById("logoutBtn").addEventListener("click", async (e) => {
    e.preventDefault();
    try {
      await signOut(auth);
      window.location.href = "index.html";
    } catch (error) {
      console.error("Logout failed:", error);
    }
  });

  // Download chart functionality
  document.querySelectorAll('.download-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const chartId = btn.getAttribute('data-chart');
      const optionsMenu = document.getElementById(`${chartId}Options`);
      
      // Hide all other open menus first
      document.querySelectorAll('.download-options').forEach(menu => {
        if (menu.id !== `${chartId}Options`) {
          menu.classList.remove('show');
        }
      });
      
      // Toggle the current menu
      optionsMenu.classList.toggle('show');
    });
  });

  // Handle download option clicks
  document.querySelectorAll('.download-option').forEach(option => {
    option.addEventListener('click', (e) => {
      e.stopPropagation();
      const chartId = option.getAttribute('data-chart');
      const format = option.getAttribute('data-format');
      
      // Get the chart instance
      let chart;
      let highResChart;
      let chartTitle;
      switch(chartId) {
        case 'reportsChart':
          chart = reportsChart;
          highResChart = highResReportsChart;
          chartTitle = "Reports Overview";
          break;
        case 'blotterTypeChart':
          chart = blotterTypeChart;
          highResChart = highResBlotterTypeChart;
          chartTitle = "Blotter Types";
          break;
        case 'incidentTypeChart':
          chart = incidentTypeChart;
          highResChart = highResIncidentTypeChart;
          chartTitle = "Incident Types";
          break;
      }
      
      if (chart) {
        if (format === 'png') {
          // Create a temporary link for downloading PNG
          const link = document.createElement('a');
          link.href = chart.toBase64Image();
          link.download = `${chartId}.png`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } else if (format === 'pdf') {
          // Generate PDF with high-resolution chart
          generatePDF(highResChart, chartTitle, chartId);
        }
      }
      
      // Hide the menu after selection
      document.getElementById(`${chartId}Options`).classList.remove('show');
    });
  });

  // Function to generate PDF with high-resolution chart
  function generatePDF(chart, chartTitle, chartId) {
    // Get the high-resolution image from the chart
    const imageData = chart.toBase64Image('image/png', 1.0);
    
    // Create PDF
    const pdf = new jsPDF({
      orientation: 'landscape',
      unit: 'mm',
      format: 'a4'
    });
    
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    
    // Add title with barangay name
    pdf.setFontSize(18);
    pdf.setFont(undefined, 'bold');
    pdf.text(`${chartTitle} - Barangay ${adminBarangay}`, pageWidth / 2, 15, { align: 'center' });
    
    // Add generation date
    pdf.setFontSize(10);
    pdf.setFont(undefined, 'normal');
    pdf.text(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth / 2, 22, { align: 'center' });
    
    // Calculate dimensions for the chart image
    const imgWidth = pageWidth - 40; // margin
    const imgHeight = (imgWidth * 2) / 3; // 2:3 aspect ratio
    
    // Add chart image
    pdf.addImage(imageData, 'PNG', 20, 30, imgWidth, imgHeight);
    
    // Save the PDF
    pdf.save(`${chartTitle.replace(/\s+/g, '_')}_Barangay_${adminBarangay}.pdf`);
  }

  // Close download menus when clicking elsewhere
  document.addEventListener('click', () => {
    document.querySelectorAll('.download-options').forEach(menu => {
      menu.classList.remove('show');
    });
  });
</script>

</body>
</html>